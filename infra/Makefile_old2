#------------------------------------------------------------------------
# ğŸ“¦ Variables de entorno
#------------------------------------------------------------------------
ENV_FILE_LOCAL ?= .env.local
ENV_FILE_DEV ?= .env.dev
ENV_FILE_PROD ?= .env.prod

# ğŸ†• Archivo de compose para Podman
COMPOSE_FILE_LOCAL ?= docker-compose-podman.yml
COMPOSE_FILE_DEV ?= docker-compose-podman.yml
COMPOSE_FILE_PROD ?= docker-compose-podman.yml

#------------------------------------------------------------------------
# ğŸ§‘â€ğŸ’» Funciones de desarrollo LOCAL (sin Podman)
#------------------------------------------------------------------------
validate-product: ## âœ… Valida la compilaciÃ³n y tests de product-service (sin Podman)
	cd .. && ./gradlew :product-service:build

validate-product-no-tests: ## âœ… Valida product-service sin ejecutar pruebas
	cd .. && ./gradlew :product-service:build -x test

clean-gradle: ## ğŸ§¹ Limpia cachÃ© y compilaciÃ³n de Gradle
	cd .. && ./gradlew clean

#------------------------------------------------------------------------
# ğŸ¦­ Funciones que USAN Podman Compose
#------------------------------------------------------------------------

## ğŸ”½ Infraestructura por entorno
up-local: ## ğŸ§ª Levanta infra para trabajar desde IntelliJ
	@echo "ğŸ§¹ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override

	@echo "ğŸ”¨ Construyendo servicios..."
	cd .. && ./gradlew :config-service:bootJar :discovery-service:bootJar :product-service:bootJar :api-gateway:bootJar

	@echo "ğŸ§¼ Apagando contenedores anteriores..."
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) down -v

	@echo "ğŸ¦­ Levantando contenedores con Podman..."
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) up --build

down-local: ## ğŸ”» Apaga infra local
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) down -v

up-dev: ## ğŸ§ª Levanta todo el stack en contenedores (modo dev)
	cp $(ENV_FILE_DEV) .env.override
	podman-compose -f $(COMPOSE_FILE_DEV) --env-file $(ENV_FILE_DEV) down -v
	podman-compose -f $(COMPOSE_FILE_DEV) --env-file $(ENV_FILE_DEV) up --build

up-prod: ## ğŸš€ Levanta todo en entorno de producciÃ³n
	cp $(ENV_FILE_PROD) .env.override
	podman-compose -f $(COMPOSE_FILE_PROD) --env-file $(ENV_FILE_PROD) down -v
	podman-compose -f $(COMPOSE_FILE_PROD) --env-file $(ENV_FILE_PROD) up --build

up-db: ## ğŸ”„ Levanta solo la base de datos para desarrollo local
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) up -d product-db

## ğŸ” Build y Rebuild
build-images: ## ğŸ—ï¸ Build manual de imÃ¡genes
	podman build -t inventory/discovery-service ../discovery-service
	podman build -t inventory/config-service ../config-service
	podman build -t inventory/api-gateway ../api-gateway
	podman build -t inventory/product-service ../product-service

build-jars:
	cd .. && ./gradlew --console=plain :config-service:bootJar :discovery-service:bootJar :api-gateway:bootJar :product-service:bootJar

# ğŸ†• Comandos para servicios individuales
rebuild-api-gateway-local: ## ğŸ” Reconstruye solo api-gateway (local)
	@echo "ğŸ› ï¸  Reconstruyendo api-gateway con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :api-gateway:bootJar  # âœ… AGREGAR ESTA LÃNEA
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) build api-gateway
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) up -d api-gateway

rebuild-config-service-local: ## ğŸ” Reconstruye solo config-service (local)
	@echo "ğŸ› ï¸  Reconstruyendo config-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) build config-service
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) up -d config-service

rebuild-discovery-local: ## ğŸ” Reconstruye solo discovery-service (local)
	@echo "ğŸ› ï¸  Reconstruyendo discovery-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) build discovery-service
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) up -d discovery-service

rebuild-product-local: ## ğŸ” Reconstruye solo product-service (local)
	@echo "ğŸ› ï¸  Reconstruyendo product-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) build product-service
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) up -d product-service

rebuild-product-dev: ## ğŸ” Reconstruye solo product-service (dev)
	@echo "ğŸ› ï¸  Reconstruyendo product-service con env: $(ENV_FILE_DEV)"
	cp $(ENV_FILE_DEV) .env.override
	podman-compose -f $(COMPOSE_FILE_DEV) --env-file $(ENV_FILE_DEV) build product-service
	podman-compose -f $(COMPOSE_FILE_DEV) --env-file $(ENV_FILE_DEV) up -d product-service

## â™»ï¸ Mantenimiento y limpieza
clean-volumes: ## ğŸ§¹ Limpia volÃºmenes no usados
	podman volume prune -f

clean-images: ## ğŸ§¹ Limpia imÃ¡genes sin contenedor
	podman image prune -a -f

clean-podman: ## ğŸ§¹ Limpia imÃ¡genes sin contenedor y volÃºmenes
	$(MAKE) clean-images
	$(MAKE) clean-volumes

stop-all: ## ğŸ›‘ Detiene todos los contenedores activos en Podman
	@echo "ğŸ›‘ Deteniendo todos los contenedores..."
	podman ps -q | xargs -r podman stop
	podman system prune -f --volumes

reset-db: ## ğŸ§¨ Reinicia product-db con script inicial
	@echo "â›” Eliminando contenedor y volumen de product-db..."
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) down -v --remove-orphans
	@echo "ğŸš€ Levantando product-db..."
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) up --build -d product-db
	@echo "ğŸ“‹ Mostrando logs..."
	podman logs -f product-db

reset-local: ## ğŸ” Reinicia completamente el entorno local
	$(MAKE) down-local
	$(MAKE) clean-podman
	$(MAKE) up-local

reload-schema: ## â™»ï¸ Ejecuta el script SQL en product-db
	podman cp ./init-scripts/product-init.sql product-db:/tmp/product-init.sql
	podman exec -it product-db psql -U product -d product -f /tmp/product-init.sql

## ğŸ” Logs y verificaciÃ³n
logs-local: ## ğŸ“œ Logs de todos los servicios locales
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) logs -f

logs-dev: ## ğŸ“œ Logs del entorno dev
	podman-compose -f $(COMPOSE_FILE_DEV) --env-file $(ENV_FILE_DEV) logs -f

# ğŸ†• Logs especÃ­ficos por servicio
logs-api-gateway: ## ğŸ“œ Logs del API Gateway
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) logs -f api-gateway

logs-discovery: ## ğŸ“œ Logs del Discovery Service
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) logs -f discovery-service

logs-config: ## ğŸ“œ Logs del Config Service
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) logs -f config-service

logs-product: ## ğŸ“œ Logs del Product Service
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) logs -f product-service

logs-db: ## ğŸ“œ Logs de la base de datos
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) logs -f product-db

check-db-init: ## ğŸ” Verifica existencia del volumen product-db
	@echo "ğŸ” Verificando volumen de la base de datos..."
	@if ! podman volume inspect inventoryms_product-data >/dev/null 2>&1; then \
		echo "âœ… Volumen no existe. Se ejecutarÃ¡ el script SQL al levantar PostgreSQL."; \
	else \
		echo "âš ï¸ Volumen ya existe. PostgreSQL NO ejecutarÃ¡ el script de inicializaciÃ³n."; \
	fi
	@$(MAKE) up-local

# ğŸ†• Status y testing
status: ## ğŸ“Š Ver estado de todos los servicios
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) ps

podman-status: ## ğŸ“Š Ver todos los contenedores Podman
	podman ps -a

test-services: ## ğŸ§ª Probar que todos los servicios estÃ©n funcionando
	@echo "ğŸ§ª Probando servicios..."
	@echo "Discovery Service (8761):"
	@curl -s http://localhost:8761/actuator/health | jq . || echo "âŒ Discovery Service no responde"
	@echo "\nConfig Service (7777):"
	@curl -s http://localhost:7777/actuator/health | jq . || echo "âŒ Config Service no responde"
	@echo "\nAPI Gateway (8090):"
	@curl -s http://localhost:8090/actuator/health | jq . || echo "âŒ API Gateway no responde"
	@echo "\nProduct Service (9090):"
	@curl -s http://localhost:9090/actuator/health | jq . || echo "âŒ Product Service no responde"

# ConstrucciÃ³n paso a paso con verificaciÃ³n
build-step-by-step:
	@echo "ğŸ§¹ Limpiando proyecto..."
	cd .. && ./gradlew clean
	@echo "ğŸ”¨ Construyendo config-service..."
	cd .. && ./gradlew :config-service:bootJar
	@echo "ğŸ”¨ Construyendo discovery-service..."
	cd .. && ./gradlew :discovery-service:bootJar
	@echo "ğŸ”¨ Construyendo api-gateway..."
	cd .. && ./gradlew :api-gateway:bootJar
	@echo "ğŸ”¨ Construyendo product-service..."
	cd .. && ./gradlew :product-service:bootJar
	@echo "âœ… Verificando JARs creados..."
	@ls -la ../*/build/libs/*.jar || echo "âŒ Algunos JARs no se crearon"
	@echo "ğŸ‰ ConstrucciÃ³n completada con Podman!"

# ğŸ†• Comandos adicionales para Podman
pods-list: ## ğŸ“‹ Lista todos los pods de Podman
	podman pod ps

pods-stats: ## ğŸ“Š EstadÃ­sticas de recursos de Podman
	podman stats --no-stream

images-list: ## ğŸ–¼ï¸ Lista todas las imÃ¡genes de Podman
	podman images

system-info: ## â„¹ï¸ InformaciÃ³n del sistema Podman
	podman system info

help: ## ğŸ“– Mostrar esta ayuda
	@echo "ğŸ¦­ Makefile para Podman - Sistema de Microservicios"
	@echo "=================================================="
	@echo ""
	@echo "Comandos disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-25s %s\n", $$1, $$2}'