networks:
  inventory-net:
    driver: bridge
    name: ${NETWORK_NAME:-inventory-net}

services:
  # --- BASES DE DATOS ---
  db_product:
    profiles: ["product"]
    image: ${IMAGE_DB:-postgres:16}
    container_name: db_product
    env_file: [./.env.local]
    environment:
      POSTGRES_DB: ${PRODUCT_DB_NAME:-db_product}
      POSTGRES_USER: ${PRODUCT_DB_USERNAME:-product}
      POSTGRES_PASSWORD: ${PRODUCT_DB_PASSWORD:-product123}
    ports:
      - "${PRODUCT_DB_PORT_HOST:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - db_product
          - product-db
    volumes:
      - db_product_data:/var/lib/postgresql/data
      - ./init-scripts/product/01-product-init.sql:/docker-entrypoint-initdb.d/01-product-init.sql:ro
    restart: unless-stopped

  db_supplier:
    profiles: ["supplier"]
    image: ${IMAGE_DB:-postgres:16}
    container_name: db_supplier
    env_file: [./.env.local]
    environment:
      POSTGRES_DB: ${SUPPLIER_DB_NAME:-db_supplier}
      POSTGRES_USER: ${SUPPLIER_DB_USERNAME:-supplier}
      POSTGRES_PASSWORD: ${SUPPLIER_DB_PASSWORD:-supplier123}
    ports:
      - "${SUPPLIER_DB_PORT_HOST:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - db_supplier
          - supplier-db
    volumes:
      - db_supplier_data:/var/lib/postgresql/data
      - ./init-scripts/supplier/02-supplier-init.sql:/docker-entrypoint-initdb.d/02-supplier-init.sql:ro
    restart: unless-stopped

  db_purchase:
    profiles: ["purchase"]
    image: ${IMAGE_DB:-postgres:16}
    container_name: db_purchase
    env_file: [./.env.local]
    environment:
      POSTGRES_DB: ${PURCHASE_DB_NAME:-db_purchase}
      POSTGRES_USER: ${PURCHASE_DB_USERNAME:-purchase}
      POSTGRES_PASSWORD: ${PURCHASE_DB_PASSWORD:-purchase123}
    ports:
      - "${PURCHASE_DB_PORT_HOST:-5436}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - db_purchase
          - purchase-db
    volumes:
      - db_purchase_data:/var/lib/postgresql/data
      - ./init-scripts/purchase/03-purchase-init.sql:/docker-entrypoint-initdb.d/03-purchase-init.sql:ro
    restart: unless-stopped

  db_tax:
    profiles: ["tax"]
    image: ${IMAGE_DB:-postgres:16}
    container_name: db_tax
    env_file: [./.env.local]
    environment:
      POSTGRES_DB: ${TAX_DB_NAME:-db_tax}
      POSTGRES_USER: ${TAX_DB_USERNAME:-tax}
      POSTGRES_PASSWORD: ${TAX_DB_PASSWORD:-tax123}
    ports:
      - "${TAX_DB_PORT_HOST:-5435}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - db_tax
          - tax-db
    volumes:
      - db_tax_data:/var/lib/postgresql/data
      - ./init-scripts/tax/04-tax-init.sql:/docker-entrypoint-initdb.d/04-tax-init.sql:ro
    restart: unless-stopped

  # --- SERVICIOS DE INFRAESTRUCTURA ---
  discovery-service:
    profiles: ["infra"]
    container_name: discovery-service
    image: discovery-service:latest
    env_file: [./.env.local]
    dns:
      - 8.8.8.8
      - 1.1.1.1
    build:
      context: ..
      dockerfile: discovery-service/Dockerfile.local
    ports:
      - "${DISCOVERY_PORT:-8761}:8761"
    environment:
      - SPRING_APPLICATION_NAME=discovery-service
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8761
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8761/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      inventory-net:
        aliases:
          - discovery-service
    restart: unless-stopped

  config-service:
    profiles: [ "infra" ]
    container_name: config-service
    image: config-service:latest
    env_file: [ ./.env.local ]
    build:
      context: ..
      dockerfile: config-service/Dockerfile.local
    ports:
      - "${CONFIG_PORT:-7777}:7777"
    entrypoint: [ "java", "-jar", "/app/app.jar" ]
    environment:
      - SPRING_APPLICATION_NAME=config-service
      - SPRING_PROFILES_ACTIVE=docker,native
      - SERVER_PORT=7777
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS=file:/config-repo-local/
      - WAIT_FOR=discovery-service:8761
    volumes:
      - ../../config-repo-local:/config-repo-local:ro,Z
    # Comenta los DNS si sigues teniendo problemas de resoluci√≥n interna
    # dns:
    #   - 8.8.8.8
    #   - 1.1.1.1
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:7777/actuator/health | grep UP || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    depends_on:
      discovery-service:
        condition: service_started
    networks:
      - inventory-net
    restart: unless-stopped

  # --- SERVICIOS DE NEGOCIO ---
  auth-service:
    profiles: ["auth"]
    container_name: auth-service
    env_file: [./.env.local]
    dns:
      - 8.8.8.8
      - 1.1.1.1
    build:
      context: ..
      dockerfile: auth-service/Dockerfile.local
    ports:
      - "${AUTH_PORT:-8080}:8080"
    environment:
      - SPRING_APPLICATION_NAME=auth-service
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE}
      - SPRING_CONFIG_IMPORT=optional:configserver:${SPRING_CLOUD_CONFIG_URI}
    depends_on:
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_started
    networks:
      - inventory-net
    restart: unless-stopped


  product-service:
    profiles: ["product"]
    container_name: product-service
    image: product-service:latest
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file: [./.env.local]
    build:
      context: ..
      dockerfile: product-service/Dockerfile.local
    ports:
      - "${PRODUCT_PORT:-9090}:9090"
    #entrypoint: ["java", "-jar", "/app/app.jar"]
    environment:
      - SPRING_APPLICATION_NAME=product-service
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_product:5432/${PRODUCT_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${PRODUCT_DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${PRODUCT_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-service:7777
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9090/actuator/health || exit 1" ]
      interval: ${INTERVAL20S:-20s}
      timeout: ${TIMEOUT10S:-10s}
      retries: ${RETRIES10:-10}
      start_period: ${START_PERIOD60S:-60s}
    depends_on:
      db_product:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  supplier-service:
    profiles: ["supplier"]
    container_name: supplier-service
    image: supplier-service:latest
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file: [./.env.local]
    build:
      context: ..
      dockerfile: supplier-service/Dockerfile.local
    ports:
      - "${SUPPLIER_PORT:-9091}:9091"
    environment:
      - SPRING_APPLICATION_NAME=supplier-service
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_supplier:5432/${SUPPLIER_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${SUPPLIER_DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SUPPLIER_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-service:7777
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      #- WAIT_FOR=discovery-service:8761
    entrypoint: ["java", "-jar", "/app/app.jar"]
    depends_on:
      db_supplier:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  purchase-service:
    profiles: ["purchase"]
    container_name: purchase-service
    image: purchase-service:latest
    env_file: [./.env.local]
    dns:
      - 8.8.8.8
      - 1.1.1.1
    build:
      context: ..
      dockerfile: purchase-service/Dockerfile.local
    ports:
      - "${PURCHASE_PORT:-9094}:9094"
    environment:
      - SPRING_APPLICATION_NAME=purcharse-service
      - SERVER_PORT=9094
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_purchase:5432/${PURCHASE_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${PURCHASE_DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${PURCHASE_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-service:7777
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      # Cambiamos a discovery-service porque es el punto central de la infraestructura
      - WAIT_FOR=discovery-service:8761
    depends_on:
      db_purchase:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  tax-service:
    profiles: ["tax"]
    container_name: tax-service
    image: tax-service:latest
    dns:
      - 8.8.8.8
      - 1.1.1.1
    env_file: [./.env.local]
    build:
      context: ..
      dockerfile: tax-service/Dockerfile.local
    ports:
      - "${TAX_PORT:-9093}:9093"
    environment:
      - SPRING_APPLICATION_NAME=tax-service
      - SERVER_PORT=9093
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_tax:5432/${TAX_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${TAX_DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${TAX_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-service:7777
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      - WAIT_FOR=discovery-service:8761
    depends_on:
      db_tax:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_started
    networks:
      - inventory-net
    restart: unless-stopped

  api-gateway:
    profiles: ["gateway"]
    container_name: api-gateway
    image: api-gateway:latest
    env_file: [./.env.local]
    build:
      context: ..
      dockerfile: api-gateway/Dockerfile.local
    ports:
      - "${API_GATEWAY_PORT:-8090}:8090"
    entrypoint: ["java", "-jar", "/app/app.jar"]
    environment:
      - SPRING_APPLICATION_NAME=api-gateway
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-service:7777
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      - WAIT_FOR=discovery-service:8761,config-service:7777
    depends_on:
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_started
    networks:
      - inventory-net
    restart: unless-stopped

volumes:
  db_product_data:
  db_supplier_data:
  db_purchase_data:
  db_tax_data:
  db_auth_data: