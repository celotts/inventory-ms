networks:
  inventory-net:
    driver: bridge

services:
  db_product:
    profiles: [ "product" ]
    image: postgres:16
    container_name: db_product
    environment:
      POSTGRES_DB: ${PRODUCT_DB_NAME:-db_product}
      POSTGRES_USER: ${PRODUCT_DB_USERNAME:-product}
      POSTGRES_PASSWORD: ${PRODUCT_DB_PASSWORD:-product123}
    ports:
      - "${PRODUCT_DB_PORT_HOST:-5433}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${PRODUCT_DB_USERNAME:-product} -d ${PRODUCT_DB_NAME:-db_product}" ]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 20s
    networks:
      - inventory-net
    volumes:
      - db_product_data:/var/lib/postgresql/data
      - ./init-scripts/product/01-product-init.sql:/docker-entrypoint-initdb.d/01-product-init.sql:ro
    restart: unless-stopped

  db_supplier:
    profiles: [ "supplier" ]
    image: postgres:16
    container_name: db_supplier
    environment:
      POSTGRES_DB: ${SUPPLIER_DB_NAME:-db_supplier}
      POSTGRES_USER: ${SUPPLIER_DB_USERNAME:-supplier}
      POSTGRES_PASSWORD: ${SUPPLIER_DB_PASSWORD:-supplier123}
    ports:
      - "${SUPPLIER_DB_PORT_HOST:-5432}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${SUPPLIER_DB_USERNAME:-supplier} -d ${SUPPLIER_DB_NAME:-db_supplier}" ]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 20s
    networks:
      - inventory-net
    volumes:
      - db_supplier_data:/var/lib/postgresql/data
    restart: unless-stopped

  db_purchase:
    profiles: [ "purchase" ]
    image: postgres:16
    container_name: db_purchase
    environment:
      POSTGRES_DB: ${PURCHASE_DB_NAME:-db_purchase}
      POSTGRES_USER: ${PURCHASE_DB_USERNAME:-purchase}
      POSTGRES_PASSWORD: ${PURCHASE_DB_PASSWORD:-purchase123}
    ports:
      - "${PURCHASE_DB_PORT_HOST:-5434}:5432" # <-- Corregido
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${PURCHASE_DB_USERNAME:-user} -d ${PURCHASE_DB_NAME:-db_purchase}" ]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 20s
    networks:
      - inventory-net
    volumes:
      - db_purchase_data:/var/lib/postgresql/data
    restart: unless-stopped

  db_tax:
    profiles: [ "tax" ]
    image: postgres:16
    container_name: db_tax
    environment:
      POSTGRES_DB: ${TAX_DB_NAME:-db_tax}
      POSTGRES_USER: ${TAX_DB_USERNAME:-tax}
      POSTGRES_PASSWORD: ${TAX_DB_PASSWORD:-tax123}
    ports:
      - "${TAX_DB_PORT_HOST:-5435}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${TAX_DB_USERNAME:-user} -d ${TAX_DB_NAME:-db_tax}" ]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 20s
    networks:
      - inventory-net
    volumes:
      - db_tax_data:/var/lib/postgresql/data
    restart: unless-stopped

  config-service:
    profiles: [ "infra" ]
    container_name: config-service
    build:
      context: ..
      dockerfile: ./config-service/Dockerfile
    ports:
      - "${CONFIG_PORT:-7777}:7777"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=7777
      - WAIT_FOR_DISCOVERY=true
      - JAVA_OPTS=-Xmx512m -Dspring.cloud.config.server.git.timeout=60 -Dspring.cloud.config.server.git.connection-timeout=30000
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CLOUD_CONFIG_SERVER_GIT_URI=${SPRING_CLOUD_CONFIG_SERVER_GIT_URI}
      - SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL=${SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL}
      - SPRING_CLOUD_CONFIG_SERVER_GIT_SEARCH_PATHS=${SPRING_CLOUD_CONFIG_SERVER_GIT_SEARCH_PATHS}
      - SPRING_CLOUD_CONFIG_SERVER_GIT_USERNAME=${GIT_USERNAME}
      - SPRING_CLOUD_CONFIG_SERVER_GIT_PASSWORD=${GIT_TOKEN}
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:7777/actuator/health || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 45s
    depends_on:
      discovery-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  discovery-service:
    profiles: [ "infra" ]
    container_name: discovery-service
    build:
      context: ..
      dockerfile: ./discovery-service/Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
        - DOCKER_USERNAME=${DOCKER_USERNAME}
        - DOCKER_PASSWORD=${DOCKER_PASSWORD}
    ports:
      - "${DISCOVERY_PORT:-8761}:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8761
      - EUREKA_CLIENT_REGISTER-WITH-EUREKA=false
      - EUREKA_CLIENT_FETCH-REGISTRY=false
      - JAVA_OPTS=-Xmx256m -Xms128m
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8761/actuator/health || exit 1" ]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - inventory-net
    restart: unless-stopped

  auth-service:
    profiles: [ "auth" ]
    container_name: auth-service
    build:
      context: ..
      dockerfile: ./auth-service/Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8080
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - WAIT_FOR=discovery-service:8761,config-service:7777
      - WAIT_TIMEOUT=60
    depends_on:
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 60s
    networks:
      - inventory-net
    restart: unless-stopped

  product-service:
    profiles: [ "product" ]
    container_name: product-service
    build:
      context: ..
      dockerfile: ./product-service/Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
    ports:
      - "${PRODUCT_PORT:-9090}:9090"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    entrypoint: ["/app/entrypoint.sh"]
    environment:
      - SPRING_APPLICATION_NAME=product-service
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - JAVA_OPTS=${JAVA_OPTS:-}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_product:5432/${PRODUCT_DB_NAME:-db_product}
      - SPRING_DATASOURCE_USERNAME=${PRODUCT_DB_USERNAME:-product}
      - SPRING_DATASOURCE_PASSWORD=${PRODUCT_DB_PASSWORD:-product123}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - EUREKA_CLIENT_REGISTRYFETCHINTERVALSECONDS=10
      - EUREKA_CLIENT_INSTANCEINFOREPLICATIONINTERVALSECONDS=10
      - WAIT_FOR=db_product:5432,discovery-service:8761,config-service:7777
      - WAIT_TIMEOUT=300
      - SPRING_CLOUD_CONFIG_FAILFAST=false
      - SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS=6
      - SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL=3000
      - PAGINATION_DEFAULT_PAGE=${PAGINATION_DEFAULT_PAGE:-0}
      - PAGINATION_DEFAULT_SIZE=${PAGINATION_DEFAULT_SIZE:-10}
      - PAGINATION_MAX_SIZE=${PAGINATION_MAX_SIZE:-100}
      - PAGINATION_DEFAULT_SORT_BY=${PAGINATION_DEFAULT_SORT_BY:-createdAt}
      - PAGINATION_DEFAULT_SORT_DIR=${PAGINATION_DEFAULT_SORT_DIR:-desc}
      - PAGINATION_ALLOWED_SORT_FIELDS=${PAGINATION_ALLOWED_SORT_FIELDS:-createdAt,updatedAt,code,description,unitPrice,currentStock}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,env,configprops,beans
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - SPRING_CLOUD_REFRESH_ENABLED=false
      - SERVER_PORT=9090
    dns:
      - 1.1.1.1
      - 8.8.8.8
    depends_on:
      db_product:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/actuator/health || exit 1"]
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 60s
    networks:
      - inventory-net
    restart: unless-stopped

  supplier-service:
    profiles: [ "supplier" ]
    container_name: supplier-service
    build:
      context: ..
      dockerfile: ./supplier-service/Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
    ports:
      - "${SUPPLIER_PORT:-9091}:9091"
    entrypoint: ["/app/entrypoint.sh"]
    dns:
      - 1.1.1.1 # Cloudflare DNS
      - 8.8.8.8 # Google DNS
    environment:
      - SPRING_APPLICATION_NAME=supplier-service
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - JAVA_OPTS=${JAVA_OPTS:-}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_supplier:5432/${SUPPLIER_DB_NAME:-db_supplier}
      - SPRING_DATASOURCE_USERNAME=${SUPPLIER_DB_USERNAME:-supplier}
      - SPRING_DATASOURCE_PASSWORD=${SUPPLIER_DB_PASSWORD:-supplier123}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - EUREKA_CLIENT_REGISTRYFETCHINTERVALSECONDS=10
      - EUREKA_CLIENT_INSTANCEINFOREPLICATIONINTERVALSECONDS=10
      - eureka.client.serviceUrl.defaultZone=http://discovery-service:8761/eureka/ # <-- Anulación 1: Confirma URL con alta precedencia
      - eureka.client.enabled=true # <-- Anulación 2: CRÍTICO. Garantiza la activación del registro.
      - WAIT_FOR=db_supplier:5432,discovery-service:8761,config-service:7777
      - WAIT_TIMEOUT=300
      - SPRING_CLOUD_CONFIG_FAILFAST=false
      - SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS=6
      - SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL=3000
      - PAGINATION_DEFAULT_PAGE=${PAGINATION_DEFAULT_PAGE:-0}
      - PAGINATION_DEFAULT_SIZE=${PAGINATION_DEFAULT_SIZE:-10}
      - PAGINATION_MAX_SIZE=${PAGINATION_MAX_SIZE:-100}
      - PAGINATION_DEFAULT_SORT_BY=${PAGINATION_DEFAULT_SORT_BY:-createdAt}
      - PAGINATION_DEFAULT_SORT_DIR=${PAGINATION_DEFAULT_SORT_DIR:-desc}
      - PAGINATION_ALLOWED_SORT_FIELDS=${PAGINATION_ALLOWED_SORT_FIELDS:-createdAt,updatedAt,name,code}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,env,configprops,beans
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - SPRING_CLOUD_REFRESH_ENABLED=false
      - SERVER_PORT=9091
    depends_on:
      db_supplier:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9091/actuator/health || exit 1"]
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 60s
    networks:
      - inventory-net
    restart: unless-stopped

  purchase-service:
    profiles: [ "purchase" ]
    container_name: purchase-service
    build:
      context: ..
      dockerfile: ./purchase-service/Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
    ports:
      - "${PURCHASE_PORT:-9092}:9094" # <-- Variable USADA (Host: 9092 / Contenedor: 9094)
    environment:
      - SPRING_APPLICATION_NAME=purchase-service
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - JAVA_OPTS=${JAVA_OPTS:-}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_purchase:5432/${PURCHASE_DB_NAME:-db_purchase}
      - SPRING_DATASOURCE_USERNAME=${PURCHASE_DB_USERNAME:-purchase}
      - SPRING_DATASOURCE_PASSWORD=${PURCHASE_DB_PASSWORD:-purchase123}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - EUREKA_CLIENT_REGISTRYFETCHINTERVALSECONDS=10
      - EUREKA_CLIENT_INSTANCEINFOREPLICATIONINTERVALSECONDS=10
      - WAIT_FOR=db_purchase:5432,discovery-service:8761,config-service:7777
      - WAIT_TIMEOUT=300
      - SPRING_CLOUD_CONFIG_FAILFAST=false
      - SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS=6
      - SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL=3000
      - PAGINATION_DEFAULT_PAGE=${PAGINATION_DEFAULT_PAGE:-0}
      - PAGINATION_DEFAULT_SIZE=${PAGINATION_DEFAULT_SIZE:-10}
      - PAGINATION_MAX_SIZE=${PAGINATION_MAX_SIZE:-100}
      - PAGINATION_DEFAULT_SORT_BY=${PAGINATION_DEFAULT_SORT_BY:-createdAt}
      - PAGINATION_DEFAULT_SORT_DIR=${PAGINATION_DEFAULT_SORT_DIR:-desc}
      - PAGINATION_ALLOWED_SORT_FIELDS=${PAGINATION_ALLOWED_SORT_FIELDS:-createdAt,updatedAt,purchaseNumber,date}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,env,configprops,beans
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - SPRING_CLOUD_REFRESH_ENABLED=false
      - SERVER_PORT=9094
    depends_on:
      db_purchase:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9094/actuator/health || exit 1"]
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 60s
    networks:
      - inventory-net
    restart: unless-stopped

  tax-service:
    profiles: [ "tax" ]
    container_name: tax-service
    build:
      context: ..
      dockerfile: ./tax-service/Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
    ports:
      - "${TAX_PORT:-9093}:9092"
    environment:
      - SPRING_APPLICATION_NAME=tax-service
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - JAVA_OPTS=${JAVA_OPTS:-}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:7777
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_tax:5432/${TAX_DB_NAME:-db_tax}
      - SPRING_DATASOURCE_USERNAME=${TAX_DB_USERNAME:-tax}
      - SPRING_DATASOURCE_PASSWORD=${TAX_DB_PASSWORD:-tax123}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - EUREKA_CLIENT_REGISTRYFETCHINTERVALSECONDS=10
      - EUREKA_CLIENT_INSTANCEINFOREPLICATIONINTERVALSECONDS=10
      - WAIT_FOR=discovery-service:8761,config-service:7777,db_tax:5432
      - WAIT_TIMEOUT=300
      - SPRING_CLOUD_CONFIG_FAILFAST=false
      - SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS=6
      - SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL=3000
      - PAGINATION_DEFAULT_PAGE=${PAGINATION_DEFAULT_PAGE:-0}
      - PAGINATION_DEFAULT_SIZE=${PAGINATION_DEFAULT_SIZE:-10}
      - PAGINATION_MAX_SIZE=${PAGINATION_MAX_SIZE:-100}
      - PAGINATION_DEFAULT_SORT_BY=${PAGINATION_DEFAULT_SORT_BY:-createdAt}
      - PAGINATION_DEFAULT_SORT_DIR=${PAGINATION_DEFAULT_SORT_DIR:-desc}
      - PAGINATION_ALLOWED_SORT_FIELDS=${PAGINATION_ALLOWED_SORT_FIELDS:-createdAt,updatedAt,name,rate}
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,env,configprops,beans
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - SPRING_CLOUD_REFRESH_ENABLED=false
      - SERVER_PORT=9092
    depends_on:
      db_tax:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9092/actuator/health || exit 1"]
      interval: 15s
      timeout: 15s
      retries: 10
      start_period: 60s
    networks:
      - inventory-net
    restart: unless-stopped

  api-gateway:
    profiles: [ "gateway" ]
    container_name: api-gateway
    build:
      context: ..
      dockerfile: ./api-gateway/Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
    ports:
      - "${API_GATEWAY_PORT:-8090}:8090" # <-- Variable USADA
    entrypoint: ["/app/entrypoint.sh"]
    environment:
      - SPRING_APPLICATION_NAME=api-gateway
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - JAVA_OPTS=${JAVA_OPTS:-}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:${CONFIG_PORT:-7777}
      - SPRING_CLOUD_GATEWAY_DISCOVERY_LOCATOR_ENABLED=true
      - SPRING_CLOUD_GATEWAY_DISCOVERY_LOCATOR_LOWERCASESERVICEID=true
      - SPRING_CLOUD_CONFIG_FAILFAST=false
      - SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS=6
      - SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL=3000
      - WAIT_FOR=discovery-service:8761,config-service:7777
      - WAIT_TIMEOUT=300
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,env,configprops,beans
      - MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true
      - SPRING_CLOUD_REFRESH_ENABLED=false
      - SERVER_PORT=8090
    dns:
      - 1.1.1.1
      - 8.8.8.8
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8090/actuator/health || exit 1"]
      interval: 8s
      timeout: 8s
      retries: 8
      start_period: 30s
    depends_on:
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy

    networks:
      - inventory-net
    restart: unless-stopped

volumes:
  db_product_data:
  db_supplier_data:
  db_purchase_data:
  db_tax_data:
  db_auth_data: