networks:
  inventory-net:
    driver: bridge
    name: ${NETWORK_NAME:-inventory-net}

services:
  # --- BASES DE DATOS ---
  db_product:
    profiles: ["product"]
    image: ${IMAGE_DB:-postgres:16}
    container_name: ${PRODUCT_DB_HOST:-db_product}
    deploy:
      resources:
        limits:
          memory: 256M
    env_file: [./.env.local]
    environment:
      POSTGRES_DB: ${PRODUCT_DB_NAME:-product}
      POSTGRES_USER: ${PRODUCT_DB_USERNAME:-product}
      POSTGRES_PASSWORD: ${PRODUCT_DB_PASSWORD:-product123}
    ports:
      - "${PRODUCT_DB_PORT_HOST:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PRODUCT_DB_USERNAME:-product} -d ${PRODUCT_DB_NAME:-product}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - ${PRODUCT_DB_HOST:-db_product}
          - product-db
    volumes:
      - db_product_data:/var/lib/postgresql/data
      - ./init-scripts/product/01-product-init.sql:/docker-entrypoint-initdb.d/01-product-init.sql:ro
    restart: unless-stopped

  db_supplier:
    profiles: ["supplier"]
    image: ${IMAGE_DB:-postgres:16}
    container_name: ${SUPPLIER_DB_HOST:-db_supplier}
    deploy:
      resources:
        limits:
          memory: 256M
    env_file: [./.env.local]
    environment:
      POSTGRES_DB: ${SUPPLIER_DB_NAME:-supplier}
      POSTGRES_USER: ${SUPPLIER_DB_USERNAME:-supplier}
      POSTGRES_PASSWORD: ${SUPPLIER_DB_PASSWORD:-supplier123}
    ports:
      - "${SUPPLIER_DB_PORT_HOST:-5434}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SUPPLIER_DB_USERNAME:-supplier} -d ${SUPPLIER_DB_NAME:-supplier}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - ${SUPPLIER_DB_HOST:-db_supplier}
          - supplier-db
    volumes:
      - db_supplier_data:/var/lib/postgresql/data
      - ./init-scripts/supplier/02-supplier-init.sql:/docker-entrypoint-initdb.d/02-supplier-init.sql:ro
    restart: unless-stopped

  db_purchase:
    profiles: [ "purchase" ]
    image: ${IMAGE_DB:-postgres:16}
    container_name: ${PURCHASE_DB_HOST:-db_purchase}
    deploy:
      resources:
        limits:
          memory: 256M
    env_file: [ ./.env.local ]
    environment:
      POSTGRES_DB: ${PURCHASE_DB_NAME:-purchase}
      POSTGRES_USER: ${PURCHASE_DB_USERNAME:-purchase}
      POSTGRES_PASSWORD: ${PURCHASE_DB_PASSWORD:-purchase123}
    ports:
      - "${PURCHASE_DB_PORT_HOST:-5436}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${PURCHASE_DB_USERNAME:-purchase} -d ${PURCHASE_DB_NAME:-purchase}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - ${PURCHASE_DB_HOST:-db_purchase}
          - purchase-db
    volumes:
      - db_purchase_data:/var/lib/postgresql/data
      - ./init-scripts/purchase/03-purchase-init.sql:/docker-entrypoint-initdb.d/03-purchase-init.sql:ro
    restart: unless-stopped

  db_tax:
    profiles: [ "tax" ]
    image: ${IMAGE_DB:-postgres:16}
    container_name: ${TAX_DB_HOST:-db_tax}
    deploy:
      resources:
        limits:
          memory: 256M
    env_file: [ ./.env.local ]
    environment:
      POSTGRES_DB: ${TAX_DB_NAME:-tax}
      POSTGRES_USER: ${TAX_DB_USERNAME:-tax}
      POSTGRES_PASSWORD: ${TAX_DB_PASSWORD:-tax123}
    ports:
      - "${TAX_DB_PORT_HOST:-5435}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${TAX_DB_USERNAME:-tax} -d ${TAX_DB_NAME:-tax}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - ${TAX_DB_HOST:-db_tax}
          - tax-db
    volumes:
      - db_tax_data:/var/lib/postgresql/data
      - ./init-scripts/tax/04-tax-init.sql:/docker-entrypoint-initdb.d/04-tax-init.sql:ro
    restart: unless-stopped

  db_auth:
    profiles: [ "auth" ]
    image: ${IMAGE_DB:-postgres:16}
    container_name: ${AUTH_DB_HOST:-db_auth}
    deploy:
      resources:
        limits:
          memory: 256M
    env_file: [ ./.env.local ]
    environment:
      POSTGRES_DB: ${AUTH_DB_NAME:-auth}
      POSTGRES_USER: ${AUTH_DB_USERNAME:-auth_user}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-auth_pass}
    ports:
      - "${AUTH_DB_PORT_HOST:-5437}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${AUTH_DB_USERNAME:-auth_user} -d ${AUTH_DB_NAME:-auth}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      inventory-net:
        aliases:
          - ${AUTH_DB_HOST:-db_auth}
    volumes:
      - db_auth_data:/var/lib/postgresql/data
    restart: unless-stopped

  # --- SERVICIOS DE INFRAESTRUCTURA ---
  discovery-service:
    profiles: ["infra"]
    container_name: ${EUREKA_HOST:-discovery-service}
    image: ${EUREKA_HOST:-discovery-service}:latest
    deploy:
      resources:
        limits:
          memory: 512M
    env_file: [./.env.local]
    build:
      context: ../
      dockerfile: discovery-service/Dockerfile.local
    ports:
      - "${DISCOVERY_PORT:-8761}:${DISCOVERY_PORT:-8761}"
    environment:
      - JAVA_OPTS=-Xmx384m -Xms256m
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - SERVER_PORT=${DISCOVERY_PORT:-8761}
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=${EUREKA_REGISTER:-false}
      - EUREKA_CLIENT_FETCH_REGISTRY=${EUREKA_FETCH:-false}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${DISCOVERY_PORT:-8761}/actuator/health || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5
    networks:
      - inventory-net
    restart: unless-stopped

  config-service:
    profiles: ["infra"]
    container_name: ${CONFIG_HOST:-config-service}
    image: ${CONFIG_HOST:-config-service}:latest
    deploy:
      resources:
        limits:
          memory: 512M
    user: root
    env_file: [./.env.local]
    build:
      context: ../
      dockerfile: config-service/Dockerfile.local
    ports:
      - "${CONFIG_PORT:-7777}:${CONFIG_PORT:-7777}"
    environment:
      - JAVA_OPTS=-Xmx384m -Xms256m
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker},native
      - SERVER_PORT=${CONFIG_PORT:-7777}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://${EUREKA_HOST:-discovery-service}:${DISCOVERY_PORT:-8761}/${NAME_EUREKA:-eureka}/
      - SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS=file:/config-repo-local/
    volumes:
      - ${LOCAL_CONFIG_REPO_PATH:-../config-repo-local}:/config-repo-local:ro,Z
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${CONFIG_PORT:-7777}/actuator/health || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5
    depends_on:
      discovery-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  # --- SERVICIOS DE NEGOCIO ---
  supplier-service:
    profiles: [ "supplier" ]
    container_name: ${SUPPLIER_SERVICE_NAME:-supplier-service}
    image: ${SUPPLIER_SERVICE_NAME:-supplier-service}:latest
    deploy:
      resources:
        limits:
          memory: 512M
    env_file: [ ./.env.local ]
    build:
      context: ../
      dockerfile: supplier-service/Dockerfile.local
    ports:
      - "${SUPPLIER_PORT:-9091}:9091"
    environment:
      - JAVA_OPTS=-Xmx384m -Xms256m
      - SERVER_PORT=${SUPPLIER_PORT:-9091}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - SPRING_APPLICATION_NAME=${SUPPLIER_SERVICE_NAME:-supplier-service}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${SUPPLIER_DB_HOST:-db_supplier}:${SUPPLIER_DB_PORT:-5432}/${SUPPLIER_DB_NAME:-supplier}
      - SPRING_DATASOURCE_USERNAME=${SUPPLIER_DB_USERNAME:-supplier}
      - SPRING_DATASOURCE_PASSWORD=${SUPPLIER_DB_PASSWORD:-supplier123}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - SPRING_CLOUD_CONFIG_URI=http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://${EUREKA_HOST:-discovery-service}:${DISCOVERY_PORT:-8761}/${NAME_EUREKA:-eureka}/
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:${SUPPLIER_PORT:-9091}/actuator/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    depends_on:
      db_supplier:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net

  api-gateway:
    profiles: [ "gateway" ]
    container_name: ${GATEWAY_SERVICE_NAME:-api-gateway}
    image: ${GATEWAY_SERVICE_NAME:-api-gateway}:latest
    deploy:
      resources:
        limits:
          memory: 768M
    env_file: [ ./.env.local ]
    build:
      context: ../
      dockerfile: api-gateway/Dockerfile.local
    ports:
      - "${API_GATEWAY_PORT:-8090}:8090"
    environment:
      - JAVA_OPTS=-Xmx512m -Xms256m
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - SPRING_APPLICATION_NAME=${GATEWAY_SERVICE_NAME:-api-gateway}
      - SERVER_PORT=${API_GATEWAY_PORT:-8090}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://${EUREKA_HOST:-discovery-service}:${DISCOVERY_PORT:-8761}/${NAME_EUREKA:-eureka}/
      - SPRING_CLOUD_CONFIG_URI=http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8090/actuator/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    depends_on:
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  product-service:
    profiles: [ "product" ]
    container_name: ${PRODUCT_SERVICE_NAME:-product-service}
    image: ${PRODUCT_SERVICE_NAME:-product-service}:latest
    deploy:
      resources:
        limits:
          memory: 512M
    env_file: [ ./.env.local ]
    build:
      context: ../
      dockerfile: product-service/Dockerfile.local
    ports:
      - "${PRODUCT_PORT:-9090}:9090"
    environment:
      - JAVA_OPTS=-Xmx384m -Xms256m
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - SPRING_APPLICATION_NAME=${PRODUCT_SERVICE_NAME:-product-service}
      - SERVER_PORT=${PRODUCT_PORT:-9090}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${PRODUCT_DB_HOST:-db_product}:5432/${PRODUCT_DB_NAME:-product}
      - SPRING_DATASOURCE_USERNAME=${PRODUCT_DB_USERNAME:-product}
      - SPRING_DATASOURCE_PASSWORD=${PRODUCT_DB_PASSWORD:-product123}
      - SPRING_CLOUD_CONFIG_URI=http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://${EUREKA_HOST:-discovery-service}:${DISCOVERY_PORT:-8761}/${NAME_EUREKA:-eureka}/
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9090/actuator/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    depends_on:
      db_product:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net

  tax-service:
    profiles: [ "tax" ]
    container_name: ${TAX_SERVICE_NAME:-tax-service}
    image: ${TAX_SERVICE_NAME:-tax-service}:latest
    deploy:
      resources:
        limits:
          memory: 512M
    env_file: [ ./.env.local ]
    build:
      context: ../
      dockerfile: tax-service/Dockerfile.local
    ports:
      - "${TAX_PORT:-9093}:9093"
    environment:
      - JAVA_OPTS=-Xmx384m -Xms256m
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - SPRING_APPLICATION_NAME=${TAX_SERVICE_NAME:-tax-service}
      - SERVER_PORT=${TAX_PORT:-9093}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${TAX_DB_HOST:-db_tax}:${TAX_DB_PORT:-5432}/${TAX_DB_NAME:-tax}
      - SPRING_DATASOURCE_USERNAME=${TAX_DB_USERNAME:-tax}
      - SPRING_DATASOURCE_PASSWORD=${TAX_DB_PASSWORD:-tax123}
      - SPRING_CLOUD_CONFIG_URI=http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://${EUREKA_HOST:-discovery-service}:${DISCOVERY_PORT:-8761}/${NAME_EUREKA:-eureka}/
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9093/actuator/health | grep UP || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    depends_on:
      db_tax:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  purchase-service:
    profiles: [ "purchase" ]
    container_name: ${PURCHASE_SERVICE_NAME:-purchase-service}
    image: ${PURCHASE_SERVICE_NAME:-purchase-service}:latest
    deploy:
      resources:
        limits:
          memory: 512M
    env_file: [ ./.env.local ]
    build:
      context: ../
      dockerfile: purchase-service/Dockerfile.local
    ports:
      - "${PURCHASE_PORT:-9094}:9094"
    environment:
      - JAVA_OPTS=-Xmx384m -Xms256m
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - SPRING_APPLICATION_NAME=${PURCHASE_SERVICE_NAME:-purchase-service}
      - SERVER_PORT=${PURCHASE_PORT:-9094}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${PURCHASE_DB_HOST:-db_purchase}:${PURCHASE_DB_PORT:-5432}/${PURCHASE_DB_NAME:-purchase}
      - SPRING_DATASOURCE_USERNAME=${PURCHASE_DB_USERNAME:-purchase}
      - SPRING_DATASOURCE_PASSWORD=${PURCHASE_DB_PASSWORD:-purchase123}
      - SPRING_CLOUD_CONFIG_URI=http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://${EUREKA_HOST:-discovery-service}:${DISCOVERY_PORT:-8761}/${NAME_EUREKA:-eureka}/
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9094/actuator/health | grep UP || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    depends_on:
      db_purchase:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

  auth-service:
    profiles: [ "auth" ]
    container_name: ${AUTH_SERVICE_NAME:-auth-service}
    image: ${AUTH_SERVICE_NAME:-auth-service}:latest
    deploy:
      resources:
        limits:
          memory: 512M
    env_file: [ ./.env.local ]
    build:
      context: ../
      dockerfile: auth-service/Dockerfile.local
    ports:
      - "${AUTH_PORT:-8081}:${AUTH_PORT:-8081}"
    environment:
      - JAVA_OPTS=-Xmx384m -Xms256m
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - SPRING_APPLICATION_NAME=${AUTH_SERVICE_NAME:-auth-service}
      - SERVER_PORT=${AUTH_PORT:-8081}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${AUTH_DB_HOST:-db_auth}:5432/${AUTH_DB_NAME:-auth}
      - DB_USERNAME=${AUTH_DB_USERNAME:-auth_user}
      - DB_PASSWORD=${AUTH_DB_PASSWORD:-auth_pass}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://${EUREKA_HOST:-discovery-service}:${DISCOVERY_PORT:-8761}/${NAME_EUREKA:-eureka}/
      - SPRING_CLOUD_CONFIG_URI=http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
      - SPRING_CONFIG_IMPORT=optional:configserver:http://${CONFIG_HOST:-config-service}:${CONFIG_PORT:-7777}
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:${AUTH_PORT:-8081}/actuator/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    depends_on:
      db_auth:
        condition: service_healthy
      config-service:
        condition: service_healthy
    networks:
      - inventory-net
    restart: unless-stopped

volumes:
  db_product_data:
  db_supplier_data:
  db_purchase_data:
  db_tax_data:
  db_auth_data: