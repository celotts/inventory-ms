#------------------------------------------------------------------------
# üì¶ Variables de entorno
#------------------------------------------------------------------------
ENV_FILE_LOCAL ?= .env.local
ENV_FILE_DEV   ?= .env.dev
ENV_FILE_PROD  ?= .env.prod

# üÜï Archivo de compose unificado
COMPOSE_FILE_LOCAL ?= docker-compose.yml
COMPOSE_FILE_DEV   ?= docker-compose.yml
COMPOSE_FILE_PROD  ?= docker-compose.yml

# üß∞ Helpers DRY para Podman Compose por entorno
COMPOSE_LOCAL := podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL)
COMPOSE_DEV   := podman-compose -f $(COMPOSE_FILE_DEV)   --env-file $(ENV_FILE_DEV)
COMPOSE_PROD  := podman-compose -f $(COMPOSE_FILE_PROD)  --env-file $(ENV_FILE_PROD)

# üîñ Perfiles disponibles (deben existir en docker-compose-no-usar.yml)
PROFILES_ALL := infra gateway product supplier purchase

# ====== Vars seguras (rutas absolutas) ======
CURDIR := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))
ENV_FILE_LOCAL     ?= $(CURDIR)/.env.local

# Usa UNO o VARIOS compose files (separados por espacio)
# Ejemplos:
#   make up-local-supplier_fix COMPOSE_FILES="$(CURDIR)/docker-compose-podman.yml"
#   make up-local-supplier_fix COMPOSE_FILES="$(CURDIR)/docker-compose-no-usar.yml $(CURDIR)/docker-compose.supplier.yml"
COMPOSE_FILES ?= $(CURDIR)/docker-compose.yml

# Helper para expandir -f por cada archivo
COMPOSE_F := $(foreach f,$(COMPOSE_FILES),-f $(f))

#------------------------------------------------------------------------
# üßë‚Äçüíª Funciones de desarrollo LOCAL (sin Docker)
#------------------------------------------------------------------------
validate-product: ## ‚úÖ Valida la compilaci√≥n y tests de product-service (sin Docker)
	cd .. && ./gradlew :product-service:build

validate-product-no-tests: ## ‚úÖ Valida product-service sin ejecutar pruebas
	cd .. && ./gradlew :product-service:build -x test

clean-gradle: ## üßπ Limpia cach√© y compilaci√≥n de Gradle
	cd .. && ./gradlew clean

#------------------------------------------------------------------------
# ‚ôªÔ∏è Targets gen√©ricos por perfil (UP/DOWN/LOGS)
#------------------------------------------------------------------------
up-%: ## Levanta por perfil: infra|gateway|product|supplier|purchase|all
	@if [ "$*" = "all" ]; then \
		$(COMPOSE_LOCAL) $(foreach p,$(PROFILES_ALL),--profile $(p)) up -d --build; \
	else \
		$(COMPOSE_LOCAL) --profile $* up -d --build; \
	fi

down-%: ## Baja por perfil: infra|gateway|product|supplier|purchase|all
	@if [ "$*" = "all" ]; then \
		$(COMPOSE_LOCAL) $(foreach p,$(PROFILES_ALL),--profile $(p)) down -v --remove-orphans; \
	else \
		$(COMPOSE_LOCAL) --profile $* down -v --remove-orphans; \
	fi

logs-%: ## Logs por perfil: infra|gateway|product|supplier|purchase
	$(COMPOSE_LOCAL) --profile $* logs -f

#------------------------------------------------------------------------
# ü¶≠ Funciones que USAN Podman Compose
#------------------------------------------------------------------------

## üîΩ Infraestructura por entorno
up-local: fix-container-orphans ## üß™ Infra + product + gateway para trabajar desde IntelliJ
	@echo "üßπ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override
	@echo "üî® Construyendo servicios..."
	cd .. && ./gradlew :config-service:bootJar :discovery-service:bootJar :product-service:bootJar :api-gateway:bootJar
	@echo "ü¶≠ Levantando contenedores con Podman (perfiles: infra, product, gateway)..."
	$(COMPOSE_LOCAL) --profile infra --profile product --profile gateway up -d --build


## üîΩ Levantar solo supplier (m√°s la base)
up-local-product-supplier: fix-container-orphans
	@echo "üßπ Copiando variables de entorno..."
	cp "$(ENV_FILE_LOCAL)" "$(CURDIR)/.env.override"

	@COMPOSE_FILE="$(CURDIR)/docker-compose-podman.yml"; \
	echo "üîé Verificando que existan supplier-db/supplier-service y product-db/product-service en $$COMPOSE_FILE..."; \
	SERVICES="$$(COMPOSE_PROFILES=infra,supplier,product podman-compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL)" \
	  --profile infra --profile supplier --profile product config --services 2>/dev/null || true)"; \
	echo "$$SERVICES" | grep -qx "supplier-db"      || { echo "‚ùå Falta supplier-db"; exit 1; }; \
	echo "$$SERVICES" | grep -qx "supplier-service" || { echo "‚ùå Falta supplier-service"; exit 1; }; \
	echo "$$SERVICES" | grep -qx "product-db"       || { echo "‚ùå Falta product-db"; exit 1; }; \
	echo "$$SERVICES" | grep -qx "product-service"  || { echo "‚ùå Falta product-service"; exit 1; }; \
	echo "‚úÖ Servicios detectados: supplier y product."; \

	@echo "üî® Construyendo jars necesarios (incluye product)..."
	cd "$(CURDIR)/.." && ./gradlew \
		:config-service:bootJar \
		:discovery-service:bootJar \
		:product-service:bootJar \
		:supplier-service:bootJar

	@echo "ü¶≠ Levantando discovery, config, product-db, product-service, supplier-db y supplier-service..."
	COMPOSE_PROFILES=infra,product,supplier \
	podman-compose -f "$(CURDIR)/docker-compose-podman.yml" --env-file "$(ENV_FILE_LOCAL)" \
	  --profile infra --profile product --profile supplier \
	  up -d --build \
	  discovery-service config-service \
	  product-db product-service \
	  supplier-db supplier-service

up-local-purchase: fix-container-orphans ## üß™ Base + purchase
	@echo "üßπ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override

	@echo "üî® Construyendo base + purchase..."
	cd .. && ./gradlew \
		:config-service:bootJar \
		:discovery-service:bootJar \
		:api-gateway:bootJar \
		:product-service:bootJar \
		:purchase-service:bootJar

	@echo "ü¶≠ Levantando contenedores (infra, product, gateway, purchase)..."
	podman-compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) \
		--profile infra --profile gateway --profile product \
		--profile purchase \
		up -d --build

# ---------------------------------------------------------------------
# üß™ Supplier Service
# ---------------------------------------------------------------------
rebuild-supplier-local: ## üîÅ Rebuild supplier-service (local)
	@echo "üõ†Ô∏è  Rebuild supplier-service (local)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :supplier-service:bootJar
	$(COMPOSE_LOCAL) --profile supplier build supplier-service
	$(COMPOSE_LOCAL) --profile supplier up -d supplier-db supplier-service

rebuild-supplier-dev: ## üîÅ Rebuild supplier-service (dev)
	@echo "üõ†Ô∏è  Rebuild supplier-service (dev)"
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) build supplier-service
	$(COMPOSE_DEV) up -d supplier-service

run-supplier-local: ## üöÄ Ejecutar supplier-service local (sin contenedor)
	@echo "üöÄ supplier-service local en http://localhost:$(SUPPLIER_PORT)"
	cd ../supplier-service && ./gradlew bootRun --args='--spring.profiles.active=local'

test-supplier: ## üß™ Tests supplier-service
	cd ../supplier-service && ./gradlew test

health-supplier: ## üíö Health de supplier-service
	@curl -fsS http://localhost:$(SUPPLIER_PORT)/actuator/health | jq . || echo "‚ùå supplier-service no responde"

# ---------------------------------------------------------------------
# üß™ Purchase Service
# ---------------------------------------------------------------------
rebuild-purchase-local: ## üîÅ Rebuild purchase-service (local)
	@echo "üõ†Ô∏è  Rebuild purchase-service (local)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :purchase-service:bootJar
	$(COMPOSE_LOCAL) build purchase-service
	$(COMPOSE_LOCAL) up -d purchase-service

rebuild-purchase-dev: ## üîÅ Rebuild purchase-service (dev)
	@echo "üõ†Ô∏è  Rebuild purchase-service (dev)"
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) build purchase-service
	$(COMPOSE_DEV) up -d purchase-service

run-purchase-local: ## üöÄ Ejecutar purchase-service local (sin contenedor)
	@echo "üöÄ purchase-service local en http://localhost:$(PURCHASE_PORT)"
	cd ../purchase-service && ./gradlew bootRun --args='--spring.profiles.active=local'

test-purchase: ## üß™ Tests purchase-service
	cd ../purchase-service && ./gradlew test

health-purchase: ## üíö Health de purchase-service
	@curl -fsS http://localhost:$(PURCHASE_PORT)/actuator/health | jq . || echo "‚ùå purchase-service no responde"

down-local: ## üîª Apaga infra local (perfiles: infra, product, gateway)
	$(COMPOSE_LOCAL) --profile infra --profile product --profile gateway down -v --remove-orphans

up-dev: ## üß™ Levanta todo el stack en contenedores (modo dev)
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) $(foreach p,$(PROFILES_ALL),--profile $(p)) down -v --remove-orphans
	$(COMPOSE_DEV) $(foreach p,$(PROFILES_ALL),--profile $(p)) up -d --build

up-prod: ## üöÄ Levanta todo en entorno de producci√≥n
	cp $(ENV_FILE_PROD) .env.override
	$(COMPOSE_PROD) $(foreach p,$(PROFILES_ALL),--profile $(p)) down -v --remove-orphans
	$(COMPOSE_PROD) $(foreach p,$(PROFILES_ALL),--profile $(p)) up -d --build

up-db: ## üîÑ Levanta solo la base de datos para desarrollo local (product-db)
	$(COMPOSE_LOCAL) --profile product up -d product-db

## üîÅ Build y Rebuild
build-images: ## üèóÔ∏è Build manual de im√°genes
	podman build -t inventory/discovery-service ../discovery-service
	podman build -t inventory/config-service ../config-service
	podman build -t inventory/api-gateway ../api-gateway
	podman build -t inventory/product-service ../product-service

build-jars:
	cd .. && ./gradlew --console=plain :config-service:bootJar :discovery-service:bootJar :api-gateway:bootJar :product-service:bootJar

# üÜï Comandos para servicios individuales
rebuild-api-gateway-local: ## üîÅ Reconstruye solo api-gateway (local)
	@echo "üõ†Ô∏è  Reconstruyendo api-gateway con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :api-gateway:bootJar
	$(COMPOSE_LOCAL) build api-gateway
	$(COMPOSE_LOCAL) up -d api-gateway

rebuild-config-service-local: ## üîÅ Reconstruye solo config-service (local)
	@echo "üõ†Ô∏è  Reconstruyendo config-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	$(COMPOSE_LOCAL) build config-service
	$(COMPOSE_LOCAL) up -d config-service

rebuild-discovery-local: ## üîÅ Reconstruye solo discovery-service (local)
	@echo "üõ†Ô∏è  Reconstruyendo discovery-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	$(COMPOSE_LOCAL) build discovery-service
	$(COMPOSE_LOCAL) up -d discovery-service

rebuild-product-local: ## üîÅ Reconstruye solo product-service (local)
	@echo "üõ†Ô∏è  Reconstruyendo product-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	$(COMPOSE_LOCAL) build product-service
	$(COMPOSE_LOCAL) up -d product-service

rebuild-product-dev: ## üîÅ Reconstruye solo product-service (dev)
	@echo "üõ†Ô∏è  Reconstruyendo product-service con env: $(ENV_FILE_DEV)"
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) build product-service
	$(COMPOSE_DEV) up -d product-service

## ‚ôªÔ∏è Mantenimiento y limpieza
clean-volumes: ## üßπ Limpia vol√∫menes no usados
	podman volume prune -f

clean-images: ## üßπ Limpia im√°genes sin contenedor
	podman image prune -a -f

clean-podman: ## üßπ Limpia im√°genes sin contenedor y vol√∫menes
	$(MAKE) clean-images
	$(MAKE) clean-volumes

stop-all: ## üõë Detiene todos los contenedores activos en Podman
	@echo "üõë Deteniendo todos los contenedores..."
	podman ps -q | xargs -r podman stop
	podman system prune -f --volumes

reset-db: ## üß® Reinicia product-db con script inicial
	@echo "‚õî Eliminando contenedor y volumen de product-db..."
	$(COMPOSE_LOCAL) down -v --remove-orphans
	@echo "üöÄ Levantando product-db..."
	$(COMPOSE_LOCAL) up --build -d product-db
	@echo "üìã Mostrando logs..."
	podman logs -f product-db

reset-local: ## üîÅ Reinicia completamente el entorno local
	$(MAKE) down-local
	$(MAKE) clean-podman
	$(MAKE) up-local

reload-schema: ## ‚ôªÔ∏è Ejecuta el script SQL en product-db
	podman cp ./init-scripts/product-init.sql product-db:/tmp/product-init.sql
	podman exec -it product-db psql -U product -d product -f /tmp/product-init.sql

## üîç Logs y verificaci√≥n
logs-local: ## üìú Logs de todos los servicios locales
	$(COMPOSE_LOCAL) logs -f

logs-dev: ## üìú Logs del entorno dev
	$(COMPOSE_DEV) logs -f

# üÜï Logs espec√≠ficos por servicio
logs-api-gateway: ## üìú Logs del API Gateway
	$(COMPOSE_LOCAL) logs -f api-gateway

logs-discovery: ## üìú Logs del Discovery Service
	$(COMPOSE_LOCAL) logs -f discovery-service

logs-config: ## üìú Logs del Config Service
	$(COMPOSE_LOCAL) logs -f config-service

logs-product: ## üìú Logs del Product Service
	$(COMPOSE_LOCAL) logs -f product-service

logs-db: ## üìú Logs de la base de datos
	$(COMPOSE_LOCAL) logs -f product-db

check-db-init: ## üîé Verifica existencia del volumen product-db
	@echo "üîé Verificando volumen de la base de datos..."
	@if ! podman volume inspect inventoryms_product-data >/dev/null 2>&1; then \
		echo "‚úÖ Volumen no existe. Se ejecutar√° el script SQL al levantar PostgreSQL."; \
	else \
		echo "‚ö†Ô∏è Volumen ya existe. PostgreSQL NO ejecutar√° el script de inicializaci√≥n."; \
	fi
	@$(MAKE) up-local

# üÜï Status y testing
status: ## üìä Ver estado de todos los servicios
	$(COMPOSE_LOCAL) ps

podman-status: ## üìä Ver todos los contenedores Podman
	podman ps -a

test-services: ## üß™ Probar que todos los servicios est√©n funcionando
	@echo "üß™ Probando servicios..."
	@echo "Discovery Service (8761):"
	@curl -s http://localhost:8761/actuator/health | jq . || echo "‚ùå Discovery Service no responde"
	@echo "\nConfig Service (7777):"
	@curl -s http://localhost:7777/actuator/health | jq . || echo "‚ùå Config Service no responde"
	@echo "\nAPI Gateway (8090):"
	@curl -s http://localhost:8090/actuator/health | jq . || echo "‚ùå API Gateway no responde"
	@echo "\nProduct Service (9090):"
	@curl -s http://localhost:9090/actuator/health | jq . || echo "‚ùå Product Service no responde"

# Construcci√≥n paso a paso con verificaci√≥n
build-step-by-step:
	@echo "üßπ Limpiando proyecto..."
	cd .. && ./gradlew clean
	@echo "üî® Construyendo config-service..."
	cd .. && ./gradlew :config-service:bootJar
	@echo "üî® Construyendo discovery-service..."
	cd .. && ./gradlew :discovery-service:bootJar
	@echo "üî® Construyendo api-gateway..."
	cd .. && ./gradlew :api-gateway:bootJar
	@echo "üî® Construyendo product-service..."
	cd .. && ./gradlew :product-service:bootJar
	@echo "‚úÖ Verificando JARs creados..."
	@ls -la ../*/build/libs/*.jar || echo "‚ùå Algunos JARs no se crearon"
	@echo "üéâ Construcci√≥n completada con Podman!"

# üÜï Comandos adicionales para Podman
pods-list: ## üìã Lista todos los pods de Podman
	podman pod ps

pods-stats: ## üìä Estad√≠sticas de recursos de Podman
	podman stats --no-stream

images-list: ## üñºÔ∏è Lista todas las im√°genes de Podman
	podman images

system-info: ## ‚ÑπÔ∏è Informaci√≥n del sistema Podman
	podman system info

podman-start: ## üöÄ Inicia la m√°quina virtual de Podman
	podman machine start

podman-machine-list: ## üìã Lista todas las m√°quinas virtuales de Podman
	podman machine list

podman-view-all: ## üëÄ Ver todos los contenedores (activos e inactivos)
	podman ps -a

podman-remove-all: ## üóëÔ∏è Eliminar todos los contenedores
	podman rm --all --force

#------------------------------------------------------------------------
# üß™ Product Service - Comandos espec√≠ficos para desarrollo local
#------------------------------------------------------------------------

## üß™ Testing del Product Service
test-product: ## üß™ Ejecutar todos los tests del product-service
	@echo "üß™ Ejecutando tests del product-service..."
	cd ../product-service && ./gradlew test

test-product-unit: ## üß™ Ejecutar solo tests unitarios del product-service
	@echo "üß™ Ejecutando tests unitarios del product-service..."
	cd ../product-service && ./gradlew test --tests "*Test"

test-product-controller: ## üß™ Testear ProductController espec√≠ficamente
	@echo "üß™ Testeando ProductController..."
	cd ../product-service && ./gradlew test --tests ProductControllerTest

test-product-app: ## üß™ Testear carga de aplicaci√≥n del product-service
	@echo "üß™ Testeando carga de aplicaci√≥n..."
	cd ../product-service && ./gradlew test --tests ProductServiceApplicationTests

test-product-health: ## üß™ Testear health endpoint del product-service
	@echo "üß™ Testeando health endpoint..."
	cd ../product-service && ./gradlew test --tests HealthCheckTest

test-product-report: ## üìä Abrir reporte de tests del product-service
	@echo "üìä Abriendo reporte de tests..."
	@open ../product-service/build/reports/tests/test/index.html || echo "‚ùå No se pudo abrir el reporte. Ejecuta 'make test-product' primero."

test-product-local: ## üß™ Ejecutar tests con perfil local
	@echo "üß™ Ejecutando tests con perfil local..."
	cd ../product-service && ./gradlew test --args='--spring.profiles.active=local'

## üöÄ Desarrollo local del Product Service (sin contenedores)
run-product-local: ## üöÄ Ejecutar product-service localmente con perfil local (puerto 9090)
	@echo "üöÄ Iniciando product-service en modo desarrollo local con perfil 'local'..."
	@echo "üìç La aplicaci√≥n estar√° disponible en: http://localhost:9090"
	@echo "üß™ Endpoint de prueba: http://localhost:9090/api/v1/products/test"
	@echo "üíö Health check: http://localhost:9090/actuator/health"
	@echo "üîß Usando perfil: local (localhost:5432)"
	cd ../product-service && ./gradlew bootRun --args='--spring.profiles.active=local'

run-product-dev: ## üöÄ Ejecutar product-service con perfil dev (para contenedores)
	@echo "üöÄ Iniciando product-service en modo desarrollo con perfil 'dev'..."
	@echo "üîß Usando perfil: dev (product-db:5432)"
	cd ../product-service && ./gradlew bootRun --args='--spring.profiles.active=dev'

run-product-profile: ## üöÄ Ejecutar product-service con perfil espec√≠fico (usar PROFILE=nombre)
	@echo "üöÄ Iniciando product-service con perfil: $(PROFILE)"
	cd ../product-service && ./gradlew bootRun --args='--spring.profiles.active=$(PROFILE)'

dev-product: run-product-local ## üöÄ Alias para run-product-local

stop-product-local: ## üõë Detener product-service local
	@echo "üõë Deteniendo product-service local..."
	@pkill -f "product-service" || echo "‚ÑπÔ∏è  No hay procesos del product-service ejecut√°ndose"

## üî® Build del Product Service
build-product: ## üî® Construir product-service para producci√≥n
	@echo "üî® Construyendo product-service para producci√≥n..."
	cd ../product-service && ./gradlew build

build-product-no-tests: ## üî® Construir product-service sin tests
	@echo "üî® Construyendo product-service sin tests..."
	cd ../product-service && ./gradlew build -x test

clean-product: ## üßπ Limpiar archivos temporales del product-service
	@echo "üßπ Limpiando product-service..."
	cd ../product-service && ./gradlew clean

rebuild-product-local-dev: clean-product build-product ## ‚ôªÔ∏è Limpiar y construir product-service

## ‚úÖ Calidad del Product Service
check-product: clean-product test-product build-product ## ‚úÖ Verificaci√≥n completa del product-service (clean + test + build)
	@echo "‚úÖ Verificaci√≥n de calidad del product-service completada"

lint-product: ## üîç Verificar estilo de c√≥digo del product-service
	@echo "üîç Verificando estilo de c√≥digo del product-service..."
	cd ../product-service && ./gradlew check

## üì¶ Dependencias del Product Service
deps-product: ## üì¶ Mostrar dependencias del product-service
	@echo "üì¶ Mostrando dependencias del product-service..."
	cd ../product-service && ./gradlew dependencies

deps-product-update: ## üì¶ Actualizar dependencias del product-service
	@echo "üì¶ Actualizando dependencias del product-service..."
	cd ../product-service && ./gradlew build --refresh-dependencies

## üõ†Ô∏è Utilidades del Product Service
health-product: ## üíö Verificar health del product-service
	@echo "üíö Verificando health del product-service..."
	@curl -f http://localhost:9090/actuator/health 2>/dev/null && echo "\n‚úÖ Product Service funcionando correctamente" || echo "‚ùå Product Service no responde. ¬øEst√° ejecut√°ndose?"

test-endpoints-product: ## üß™ Probar endpoints principales del product-service
	@echo "üß™ Probando endpoints del product-service..."
	@echo "üíö Health endpoint:"
	@curl -s http://localhost:9090/actuator/health | jq .status || echo "‚ùå Health endpoint no responde"
	@echo "\nüß™ Test endpoint:"
	@curl -s http://localhost:9090/api/v1/products/test || echo "‚ùå Test endpoint no responde"
	@echo "\nüì¶ Products endpoint (b√°sico):"
	@curl -s "http://localhost:9090/api/v1/products" | jq '. | length' || echo "‚ùå Products endpoint no responde"
	@echo "\nüìÑ Paginaci√≥n endpoint:"
	@curl -s "http://localhost:9090/api/v1/products/paginated?size=3&sortBy=createdAt&sortDir=desc" | jq '.content | length' || echo "‚ùå Paginaci√≥n endpoint no responde"

test-pagination-endpoints: ## üß™ Probar endpoints de paginaci√≥n con filtros
	@echo "üß™ Probando endpoints de paginaci√≥n del product-service..."
	@echo "üìÑ Paginaci√≥n b√°sica:"
	@curl -s "http://localhost:9090/api/v1/products/paginated?size=5&sortBy=createdAt&sortDir=desc" | jq . || echo "‚ùå Paginaci√≥n b√°sica no responde"
	@echo "\nüîç Paginaci√≥n con filtro por c√≥digo:"
	@curl -s "http://localhost:9090/api/v1/products/paginated?size=5&sortBy=name&sortDir=asc&code=ABC" | jq . || echo "‚ùå Filtro por c√≥digo no responde"
	@echo "\nüîç Paginaci√≥n con filtro por nombre:"
	@curl -s "http://localhost:9090/api/v1/products/paginated?size=5&sortBy=name&sortDir=asc&name=test" | jq . || echo "‚ùå Filtro por nombre no responde"
	@echo "\nüîç Paginaci√≥n con m√∫ltiples filtros:"
	@curl -s "http://localhost:9090/api/v1/products/paginated?size=10&sortBy=name&sortDir=asc&code=ABC&description=test" | jq . || echo "‚ùå M√∫ltiples filtros no responden"

info-product: ## ‚ÑπÔ∏è Informaci√≥n del product-service
	@echo "‚ÑπÔ∏è  Informaci√≥n del Product Service:"
	@echo "  üìÅ Proyecto: product-service"
	@echo "  ‚òï Java: 17"
	@echo "  üîß Build: Gradle"
	@echo "  üóÑÔ∏è  BD Producci√≥n: PostgreSQL"
	@echo "  üß™ BD Tests: H2"
	@echo "  üåê Puerto: 9090"
	@echo "  üìç Endpoints principales:"
	@echo "    - GET /api/v1/products/test"
	@echo "    - GET /api/v1/products"
	@echo "    - GET /api/v1/products/paginated"
	@echo "    - GET /actuator/health"

## üéØ Comandos r√°pidos del Product Service
quick-test-product: ## ‚ö° Test r√°pido del product-service
	@echo "‚ö° Test r√°pido del product-service..."
	cd ../product-service && ./gradlew test --parallel

quick-build-product: ## ‚ö° Build r√°pido del product-service
	@echo "‚ö° Build r√°pido del product-service..."
	cd ../product-service && ./gradlew build -x test

## üìä Reportes del Product Service
coverage-product: ## üìä Generar reporte de cobertura del product-service
	@echo "üìä Generando reporte de cobertura del product-service..."
	cd ../product-service && ./gradlew jacocoTestReport
	@echo "üìä Reporte disponible en: ../product-service/build/reports/jacoco/test/html/index.html"

## üîÑ Comandos integrados (Product Service + Infraestructura)
dev-full-stack: up-db run-product-local ## üöÄ Levantar BD en Docker + Product Service local
	@echo "üéâ Full stack listo: BD en Docker + Product Service local"

test-integration-product: up-db ## üß™ Tests de integraci√≥n con BD real
	@echo "üß™ Ejecutando tests de integraci√≥n con BD PostgreSQL..."
	@sleep 5
	cd ../product-service && ./gradlew test --args='--spring.profiles.active=local'

## ‚úÖ Validaci√≥n completa de funcionalidad
validate-pagination-feature: health-product test-pagination-endpoints ## ‚úÖ Validar funcionalidad completa de paginaci√≥n con filtros
	@echo "‚úÖ Validaci√≥n de funcionalidad de paginaci√≥n completada"

#------------------------------------------------------------------------
# üÜï Nuevas funcionalidades agregadas
#------------------------------------------------------------------------

## üì± Monitoreo y debugging avanzado
monitor-resources: ## üìä Monitorear recursos del sistema en tiempo real
	@echo "üìä Monitoreando recursos del sistema..."
	podman stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

debug-network: ## üåê Debugging de la red de contenedores
	@echo "üåê Inspeccionando red de contenedores..."
	podman network ls
	@echo "\nüìã Detalles de la red por defecto:"
	podman network inspect podman

debug-volumes: ## üíæ Debugging de vol√∫menes de datos
	@echo "üíæ Inspeccionando vol√∫menes..."
	podman volume ls
	@echo "\nüìã Detalles del volumen de datos:"
	podman volume inspect inventoryms_product-data 2>/dev/null || echo "‚ö†Ô∏è Volumen no existe"

debug-containers: ## üîç Debugging detallado de contenedores
	@echo "üîç Estado detallado de contenedores..."
	podman ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"

## üîß Comandos de mantenimiento avanzado
maintenance-full: ## üõ†Ô∏è Mantenimiento completo del sistema
	@echo "üõ†Ô∏è Ejecutando mantenimiento completo..."
	$(MAKE) stop-all
	$(MAKE) clean-podman
	podman system reset --force
	@echo "‚úÖ Mantenimiento completado"

backup-volumes: ## üíæ Crear backup de vol√∫menes importantes
	@echo "üíæ Creando backup de vol√∫menes..."
	@mkdir -p ./backups/$(shell date +%Y%m%d_%H%M%S)
	podman run --rm -v inventoryms_product-data:/data -v ./backups:/backup alpine tar czf /backup/product-data-$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .
	@echo "‚úÖ Backup creado en ./backups/"

restore-volumes: ## üîÑ Restaurar vol√∫menes desde backup (especificar BACKUP_FILE)
	@echo "üîÑ Restaurando vol√∫menes desde backup: $(BACKUP_FILE)"
	podman run --rm -v inventoryms_product-data:/data -v ./backups:/backup alpine tar xzf /backup/$(BACKUP_FILE) -C /data
	@echo "‚úÖ Vol√∫menes restaurados"

## üöÄ Despliegue y CI/CD helpers
deploy-staging: ## üé≠ Desplegar en entorno de staging
	@echo "üé≠ Desplegando en staging..."
	$(MAKE) build-jars
	$(MAKE) up-dev
	$(MAKE) test-services
	@echo "‚úÖ Despliegue en staging completado"

deploy-production: ## üöÄ Desplegar en entorno de producci√≥n
	@echo "üöÄ Desplegando en producci√≥n..."
	$(MAKE) build-jars
	$(MAKE) up-prod
	@sleep 30
	$(MAKE) test-services
	@echo "‚úÖ Despliegue en producci√≥n completado"

pre-commit-checks: ## ‚úÖ Verificaciones antes de commit
	@echo "‚úÖ Ejecutando verificaciones pre-commit..."
	$(MAKE) clean-gradle
	$(MAKE) build-jars
	$(MAKE) test-product
	$(MAKE) lint-product
	@echo "‚úÖ Todas las verificaciones pasaron"

## üìà Performance y benchmarking
benchmark-endpoints: ## üìà Benchmark de endpoints principales
	@echo "üìà Ejecutando benchmark de endpoints..."
	@command -v ab >/dev/null 2>&1 || { echo "‚ùå Apache Bench (ab) no est√° instalado"; exit 1; }
	@echo "üß™ Benchmark de health endpoint:"
	ab -n 100 -c 10 http://localhost:9090/actuator/health
	@echo "\nüì¶ Benchmark de products endpoint:"
	ab -n 100 -c 10 http://localhost:9090/api/v1/products
	@echo "\nüìÑ Benchmark de paginaci√≥n endpoint:"
	ab -n 100 -c 10 "http://localhost:9090/api/v1/products/paginated?size=10"

load-test-basic: ## üéØ Test de carga b√°sico
	@echo "üéØ Ejecutando test de carga b√°sico..."
	@command -v wrk >/dev/null 2>&1 || { echo "‚ùå wrk no est√° instalado. Instalar con: brew install wrk"; exit 1; }
	wrk -t12 -c400 -d30s http://localhost:9090/api/v1/products

## üîê Seguridad y validaci√≥n
security-scan: ## üîê Escaneo de seguridad de im√°genes
	@echo "üîê Escaneando im√°genes en busca de vulnerabilidades..."
	@command -v podman >/dev/null 2>&1 || { echo "‚ùå Podman no est√° disponible"; exit 1; }
	@for image in inventory/discovery-service inventory/config-service inventory/api-gateway inventory/product-service; do \
		echo "üîç Escaneando $$image..."; \
		podman run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image $$image || echo "‚ö†Ô∏è No se pudo escanear $$image"; \
	done

validate-configs: ## ‚úÖ Validar archivos de configuraci√≥n
	@echo "‚úÖ Validando archivos de configuraci√≥n..."
	@echo "üîç Validando docker-compose.yml..."
	$(COMPOSE_LOCAL) config > /dev/null && echo "‚úÖ docker-compose.yml v√°lido" || echo "‚ùå docker-compose.yml inv√°lido"
	@echo "üîç Validando archivos .env..."
	@for env_file in $(ENV_FILE_LOCAL) $(ENV_FILE_DEV) $(ENV_FILE_PROD); do \
		if [ -f $$env_file ]; then \
			echo "‚úÖ $$env_file existe"; \
		else \
			echo "‚ùå $$env_file no existe"; \
		fi \
	done

## üìã Reportes y documentaci√≥n
generate-reports: ## üìã Generar reportes del proyecto
	@echo "üìã Generando reportes del proyecto..."
	@mkdir -p ./reports/$(shell date +%Y%m%d_%H%M%S)
	@echo "üìä Generando reporte de tests..."
	$(MAKE) test-product
	@echo "üìà Generando reporte de cobertura..."
	$(MAKE) coverage-product
	@echo "üèóÔ∏è Generando reporte de dependencias..."
	cd ../product-service && ./gradlew dependencyInsight --dependency org.springframework.boot > ../infrastructure/reports/$(shell date +%Y%m%d_%H%M%S)/dependencies.txt
	@echo "‚úÖ Reportes generados en ./reports/"

system-info-full: ## ‚ÑπÔ∏è Informaci√≥n completa del sistema
	@echo "‚ÑπÔ∏è Informaci√≥n completa del sistema:"
	@echo "======================================"
	@echo "üê≥ Podman version:"
	podman --version
	@echo "\nü¶≠ Podman machine info:"
	podman machine list
	@echo "\nüìä Estad√≠sticas del sistema:"
	podman system info | head -20
	@echo "\nüì¶ Im√°genes disponibles:"
	podman images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.Created}}"
	@echo "\nüîå Contenedores activos:"
	podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

## üîÑ Workflows automatizados
workflow-dev: ## üîÑ Workflow completo de desarrollo
	@echo "üîÑ Iniciando workflow de desarrollo..."
	$(MAKE) clean-gradle
	$(MAKE) validate-configs
	$(MAKE) up-db
	@echo "‚è≥ Esperando que la BD est√© lista..."
	@sleep 10
	$(MAKE) test-product-local
	$(MAKE) run-product-local &
	@echo "‚è≥ Esperando que el servicio est√© listo..."
	@sleep 15
	$(MAKE) health-product
	$(MAKE) test-endpoints-product
	@echo "‚úÖ Workflow de desarrollo completado"

workflow-ci: ## üîÑ Workflow de integraci√≥n continua
	@echo "üîÑ Iniciando workflow de CI..."
	$(MAKE) pre-commit-checks
	$(MAKE) build-step-by-step
	$(MAKE) up-dev
	@sleep 30
	$(MAKE) test-services
	$(MAKE) benchmark-endpoints
	@echo "‚úÖ Workflow de CI completado"

workflow-production: ## üîÑ Workflow de producci√≥n
	@echo "üîÑ Iniciando workflow de producci√≥n..."
	$(MAKE) security-scan
	$(MAKE) validate-configs
	$(MAKE) backup-volumes
	$(MAKE) deploy-production
	$(MAKE) load-test-basic
	@echo "‚úÖ Workflow de producci√≥n completado"

## üÜò Troubleshooting y diagn√≥stico
troubleshoot-db: ## üÜò Diagn√≥stico de problemas de base de datos
	@echo "üÜò Diagnosticando problemas de base de datos..."
	@echo "üîç Estado del contenedor de BD:"
	podman ps -a --filter name=product-db
	@echo "\nüìã Logs recientes de la BD:"
	podman logs --tail 20 product-db 2>/dev/null || echo "‚ùå No se pueden obtener logs de product-db"
	@echo "\nüíæ Verificando volumen de datos:"
	podman volume inspect inventoryms_product-data >/dev/null 2>&1 && echo "‚úÖ Volumen existe" || echo "‚ùå Volumen no existe"
	@echo "\nüåê Verificando conectividad:"
	podman exec product-db pg_isready -U product 2>/dev/null && echo "‚úÖ PostgreSQL respondiendo" || echo "‚ùå PostgreSQL no responde"

troubleshoot-network: ## üÜò Diagn√≥stico de problemas de red
	@echo "üÜò Diagnosticando problemas de red..."
	@echo "üåê Redes disponibles:"
	podman network ls
	@echo "\nüîå Conectividad entre contenedores:"
	@for service in discovery-service config-service api-gateway product-service; do \
		echo "üß™ Probando $service..."; \
		podman exec product-service ping -c 1 $service 2>/dev/null && echo "‚úÖ $service accesible" || echo "‚ùå $service no accesible"; \
	done

troubleshoot-services: ## üÜò Diagn√≥stico de problemas de servicios
	@echo "üÜò Diagnosticando problemas de servicios..."
	@echo "üìä Estado de servicios:"
	$(MAKE) status
	@echo "\nüß™ Health checks:"
	$(MAKE) test-services
	@echo "\nüìã Logs de errores recientes:"
	podman-compose logs --tail 10 | grep -i error || echo "‚ÑπÔ∏è No se encontraron errores recientes"

fix-common-issues: ## üîß Solucionar problemas comunes
	@echo "üîß Solucionando problemas comunes..."
	@echo "üßπ Limpiando recursos no utilizados..."
	$(MAKE) clean-podman
	@echo "üîÑ Reiniciando m√°quina Podman..."
	podman machine stop 2>/dev/null || true
	podman machine start
	@echo "üöÄ Recreando contenedores..."
	$(MAKE) reset-local
	@echo "‚úÖ Problemas comunes solucionados"

## üéØ Comandos espec√≠ficos para diferentes roles
# Para desarrolladores
dev-setup: ## üë®‚Äçüíª Configuraci√≥n inicial para desarrolladores
	@echo "üë®‚Äçüíª Configurando entorno de desarrollo..."
	$(MAKE) podman-start
	$(MAKE) validate-configs
	$(MAKE) clean-gradle
	$(MAKE) up-db
	@echo "üìö Para empezar a desarrollar ejecuta: make dev-product"
	@echo "‚úÖ Entorno de desarrollo configurado"

# Para QA/Testing
qa-setup: ## üß™ Configuraci√≥n para QA y testing
	@echo "üß™ Configurando entorno de QA..."
	$(MAKE) up-dev
	@sleep 30
	$(MAKE) test-services
	$(MAKE) test-endpoints-product
	$(MAKE) test-pagination-endpoints
	@echo "‚úÖ Entorno de QA configurado y verificado"

# Para DevOps
devops-setup: ## ‚öôÔ∏è Configuraci√≥n para DevOps
	@echo "‚öôÔ∏è Configurando entorno DevOps..."
	$(MAKE) system-info-full
	$(MAKE) validate-configs
	$(MAKE) security-scan
	$(MAKE) backup-volumes
	@echo "‚úÖ Entorno DevOps configurado"

## üìä M√©tricas y monitoreo
collect-metrics: ## üìä Recopilar m√©tricas del sistema
	@echo "üìä Recopilando m√©tricas del sistema..."
	@mkdir -p ./metrics/$(shell date +%Y%m%d_%H%M%S)
	@echo "üìà M√©tricas de contenedores:" > ./metrics/$(shell date +%Y%m%d_%H%M%S)/container_stats.txt
	podman stats --no-stream >> ./metrics/$(shell date +%Y%m%d_%H%M%S)/container_stats.txt
	@echo "üíæ Uso de vol√∫menes:" > ./metrics/$(shell date +%Y%m%d_%H%M%S)/volume_usage.txt
	podman system df >> ./metrics/$(shell date +%Y%m%d_%H%M%S)/volume_usage.txt
	@echo "‚úÖ M√©tricas guardadas en ./metrics/"

health-check-all: ## üíö Verificaci√≥n de salud completa
	@echo "üíö Verificando salud completa del sistema..."
	@echo "üîç Verificando servicios principales:"
	$(MAKE) test-services
	@echo "\nüîç Verificando endpoints espec√≠ficos:"
	$(MAKE) test-endpoints-product
	@echo "\nüîç Verificando base de datos:"
	$(MAKE) troubleshoot-db
	@echo "\nüìä Estado de recursos:"
	$(MAKE) monitor-resources

## üîÑ Scripts de automatizaci√≥n
auto-restart: ## üîÑ Reinicio autom√°tico con verificaciones
	@echo "üîÑ Ejecutando reinicio autom√°tico..."
	$(MAKE) down-local
	@sleep 5
	$(MAKE) clean-volumes
	$(MAKE) up-local
	@sleep 30
	$(MAKE) health-check-all
	@echo "‚úÖ Reinicio autom√°tico completado"

daily-maintenance: ## üìÖ Mantenimiento diario automatizado
	@echo "üìÖ Ejecutando mantenimiento diario..."
	$(MAKE) backup-volumes
	$(MAKE) clean-images
	$(MAKE) collect-metrics
	$(MAKE) generate-reports
	@echo "‚úÖ Mantenimiento diario completado"

## üì± Comandos de utilidad m√≥vil/r√°pida
quick-start: up-db dev-product ## ‚ö° Inicio r√°pido para desarrollo
quick-test: test-product health-product ## ‚ö° Test r√°pido completo
quick-deploy: build-jars up-dev test-services ## ‚ö° Despliegue r√°pido
quick-stop: stop-product-local down-local ## ‚ö° Parada r√°pida completa

## üìñ Ayuda mejorada y documentaci√≥n
help-product: ## üìñ Mostrar ayuda espec√≠fica del product-service
	@echo "üß™ Product Service - Comandos disponibles:"
	@echo "============================================"
	@echo ""
	@echo "üß™ TESTING:"
	@echo "  make test-product              - Ejecutar todos los tests"
	@echo "  make test-product-local        - Ejecutar tests con perfil local"
	@echo "  make test-product-unit         - Ejecutar solo tests unitarios"
	@echo "  make test-product-report       - Abrir reporte de tests en navegador"
	@echo "  make test-integration-product  - Tests de integraci√≥n con BD real"
	@echo ""
	@echo "üöÄ DESARROLLO:"
	@echo "  make run-product-local         - Ejecutar con perfil local (localhost:5432)"
	@echo "  make run-product-dev           - Ejecutar con perfil dev (product-db:5432)"
	@echo "  make run-product-profile PROFILE=X - Ejecutar con perfil espec√≠fico"
	@echo "  make dev-product               - Alias para run-product-local"
	@echo "  make stop-product-local        - Detener aplicaci√≥n local"
	@echo ""
	@echo "üî® BUILD:"
	@echo "  make build-product             - Construir para producci√≥n"
	@echo "  make clean-product             - Limpiar archivos temporales"
	@echo "  make rebuild-product-local-dev - Limpiar y construir"
	@echo ""
	@echo "‚úÖ VALIDACI√ìN:"
	@echo "  make check-product             - Verificar c√≥digo (build + test)"
	@echo "  make validate-pagination-feature - Validar paginaci√≥n con filtros"
	@echo "  make lint-product              - Verificar estilo de c√≥digo"
	@echo ""
	@echo "üõ†Ô∏è  UTILIDADES:"
	@echo "  make health-product            - Verificar health de la aplicaci√≥n"
	@echo "  make test-endpoints-product    - Probar endpoints principales"
	@echo "  make test-pagination-endpoints - Probar endpoints de paginaci√≥n con filtros"
	@echo "  make info-product              - Informaci√≥n del proyecto"

help-workflows: ## üìñ Ayuda para workflows automatizados
	@echo "üîÑ Workflows Automatizados:"
	@echo "=========================="
	@echo ""
	@echo "üë®‚Äçüíª DESARROLLO:"
	@echo "  make dev-setup                 - Configuraci√≥n inicial para desarrolladores"
	@echo "  make workflow-dev              - Workflow completo de desarrollo"
	@echo "  make quick-start               - Inicio r√°pido para desarrollo"
	@echo ""
	@echo "üß™ QA/TESTING:"
	@echo "  make qa-setup                  - Configuraci√≥n para QA y testing"
	@echo "  make workflow-ci               - Workflow de integraci√≥n continua"
	@echo "  make quick-test                - Test r√°pido completo"
	@echo ""
	@echo "üöÄ PRODUCCI√ìN:"
	@echo "  make devops-setup              - Configuraci√≥n para DevOps"
	@echo "  make workflow-production       - Workflow de producci√≥n"
	@echo "  make quick-deploy              - Despliegue r√°pido"
	@echo ""
	@echo "üõ†Ô∏è  MANTENIMIENTO:"
	@echo "  make daily-maintenance         - Mantenimiento diario automatizado"
	@echo "  make auto-restart              - Reinicio autom√°tico con verificaciones"
	@echo "  make maintenance-full          - Mantenimiento completo del sistema"

help-troubleshooting: ## üìñ Ayuda para soluci√≥n de problemas
	@echo "üÜò Soluci√≥n de Problemas:"
	@echo "========================"
	@echo ""
	@echo "üîç DIAGN√ìSTICO:"
	@echo "  make troubleshoot-db           - Diagn√≥stico de problemas de base de datos"
	@echo "  make troubleshoot-network      - Diagn√≥stico de problemas de red"
	@echo "  make troubleshoot-services     - Diagn√≥stico de problemas de servicios"
	@echo "  make health-check-all          - Verificaci√≥n de salud completa"
	@echo ""
	@echo "üîß SOLUCIONES:"
	@echo "  make fix-common-issues         - Solucionar problemas comunes"
	@echo "  make auto-restart              - Reinicio autom√°tico con verificaciones"
	@echo "  make reset-local               - Reiniciar completamente el entorno local"
	@echo ""
	@echo "üìä MONITOREO:"
	@echo "  make monitor-resources         - Monitorear recursos en tiempo real"
	@echo "  make collect-metrics           - Recopilar m√©tricas del sistema"
	@echo "  make system-info-full          - Informaci√≥n completa del sistema"

help: ## üìñ Mostrar esta ayuda
	@echo "ü¶≠ Makefile para Podman - Sistema de Microservicios"
	@echo "=================================================="
	@echo ""
	@echo "‚ö° COMANDOS R√ÅPIDOS:"
	@echo "  make quick-start               - Inicio r√°pido para desarrollo"
	@echo "  make quick-test                - Test r√°pido completo"
	@echo "  make quick-deploy              - Despliegue r√°pido"
	@echo "  make quick-stop                - Parada r√°pida completa"
	@echo ""
	@echo "üìñ AYUDA DETALLADA:"
	@echo "  make help-product              - Ayuda espec√≠fica del Product Service"
	@echo "  make help-workflows            - Ayuda para workflows automatizados"
	@echo "  make help-troubleshooting      - Ayuda para soluci√≥n de problemas"
	@echo ""
	@echo "üîç CATEGOR√çAS PRINCIPALES:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  %-25s %s\n", $1, $2}' | \
		grep -E "(üîΩ|üîÅ|‚ôªÔ∏è|üîç|üìä|üß™|üöÄ|üî®|‚úÖ|üõ†Ô∏è|üéØ|üìä|üîÑ|üÜò|üì±|üîê|üìã)" | \
		head -20
	@echo ""
	@echo "üí° Ejecuta 'make help-[categoria]' para ayuda espec√≠fica"

help-supplier: ## üìñ Comandos de supplier-service
	@echo "supplier-service:"
	@echo "  make up-supplier              - Levantar perfil supplier (docker-compose)"
	@echo "  make rebuild-supplier-local   - Rebuild + up (local)"
	@echo "  make run-supplier-local       - Ejecutar sin contenedor (perfil local)"
	@echo "  make test-supplier            - Ejecutar tests"
	@echo "  make health-supplier          - Ver health"

help-purchase: ## üìñ Comandos de purchase-service
	@echo "purchase-service:"
	@echo "  make up-purchase              - Levantar perfil purchase (docker-compose)"
	@echo "  make rebuild-purchase-local   - Rebuild + up (local)"
	@echo "  make run-purchase-local       - Ejecutar sin contenedor (perfil local)"
	@echo "  make test-purchase            - Ejecutar tests"
	@echo "  make health-purchase          - Ver health"

fix-container-orphans: ## üõ†Ô∏è Limpia contenedores hu√©rfanos del proyecto
	@echo "üßπ Eliminando contenedores hu√©rfanos (compose project: $(COMPOSE_PROJECT_NAME))..."
	$(COMPOSE_LOCAL)  down -v --remove-orphans 2>/dev/null || true
	$(COMPOSE_DEV)    down -v --remove-orphans 2>/dev/null || true
	$(COMPOSE_PROD)   down -v --remove-orphans 2>/dev/null || true
	@echo "üóëÔ∏è  Pruning de recursos no usados..."
	podman rm -af || true
	podman system prune -af --volumes || true
	@echo "‚úÖ Limpieza de hu√©rfanos completada"

help-all: ## üìñ Mostrar todos los comandos disponibles en el Makefile
	@echo "ü¶≠ Makefile - Lista completa de comandos"
	@echo "========================================"
	@grep -E '^[a-zA-Z0-9_.-]+:.*## ' $(MAKEFILE_LIST) | \
	  awk -F ':.*## ' '{ printf "  %-35s %s\n", $$1, $$2 }' | sort

up-supplier: ## üöÄ Levanta s√≥lo la BD y el supplier-service
	$(COMPOSE_LOCAL) --profile supplier up -d --build supplier-db supplier-service

logs-supplier: ## üìú Logs de supplier-service
	$(COMPOSE_LOCAL) --profile supplier logs -f supplier-service

status-supplier: ## üìä Estado de servicios del perfil supplier
	$(COMPOSE_LOCAL) --profile supplier ps

up-ms: fix-container-orphans ## üöÄ Infra + supplier + purchase (sin product)
	@echo "üßπ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override
	@echo "üî® Construyendo JARs necesarios..."
	cd .. && ./gradlew :config-service:bootJar :discovery-service:bootJar :supplier-service:bootJar :purchase-service:bootJar
	@echo "ü¶≠ Levantando contenedores (infra, supplier, purchase)..."
	$(COMPOSE_LOCAL) --profile infra --profile supplier --profile purchase up -d --build

# --- target con check corregido ---
up-local-supplier: fix-container-orphans
	@echo "üßπ Copiando variables de entorno..."
	cp "$(ENV_FILE_LOCAL)" "$(CURDIR)/.env.override"

	@echo "üîé Verificando que supplier-db y supplier-service existan con perfiles infra,supplier..."
	@SERVICES="$$(COMPOSE_PROFILES=infra,supplier podman-compose $(COMPOSE_F) --env-file "$(ENV_FILE_LOCAL)" \
	  --profile infra --profile supplier config --services 2>/dev/null || true)"; \
	echo "$$SERVICES" | grep -E '^(supplier-db|supplier-service)$$' >/dev/null || { \
	  echo "‚ùå No se encuentran supplier-db/supplier-service con los perfiles infra,supplier"; \
	  echo "‚ÑπÔ∏è  Debug (config --services):"; echo "$$SERVICES"; \
	  echo "üí° Prueba manual:"; \
	  echo "   COMPOSE_PROFILES=infra,supplier podman-compose $(COMPOSE_F) --env-file $(ENV_FILE_LOCAL) --profile infra --profile supplier config --services"; \
	  exit 1; \
	}

	@echo "üî® Construyendo jars necesarios..."
	cd "$(CURDIR)/.." && ./gradlew \
		:config-service:bootJar \
		:discovery-service:bootJar \
		:supplier-service:bootJar

	@echo "ü¶≠ Levantando discovery, config, supplier-db y supplier-service..."
	COMPOSE_PROFILES=infra,supplier \
	podman-compose $(COMPOSE_F) --env-file "$(ENV_FILE_LOCAL)" \
	  --profile infra --profile supplier \
	  up -d --build discovery-service config-service supplier-db supplier-service


.PHONY: help help-product help-workflows help-troubleshooting \
        up-local down-local up-dev up-prod up-db \
        build-images build-jars \
        rebuild-api-gateway-local rebuild-config-service-local \
        rebuild-discovery-local rebuild-product-local rebuild-product-dev \
        clean-volumes clean-images clean-podman stop-all reset-db reset-local \
        logs-local logs-dev logs-api-gateway logs-discovery logs-config logs-product logs-db check-db-init \
        status podman-status test-services build-step-by-step \
        pods-list pods-stats images-list system-info podman-start podman-machine-list podman-view-all podman-remove-all \
        test-product test-product-unit test-product-controller test-product-app test-product-health test-product-report \
        test-product-local run-product-local run-product-dev run-product-profile dev-product stop-product-local \
        build-product build-product-no-tests clean-product rebuild-product-local-dev check-product lint-product \
        deps-product deps-product-update health-product test-endpoints-product test-pagination-endpoints info-product \
        quick-test-product quick-build-product coverage-product dev-full-stack test-integration-product validate-pagination-feature \
        monitor-resources debug-network debug-volumes debug-containers maintenance-full backup-volumes restore-volumes \
        deploy-staging deploy-production pre-commit-checks benchmark-endpoints load-test-basic security-scan validate-configs \
        generate-reports system-info-full workflow-dev workflow-ci workflow-production troubleshoot-db troubleshoot-network troubleshoot-services \
        fix-common-issues dev-setup qa-setup devops-setup collect-metrics health-check-all auto-restart daily-maintenance \
        quick-start quick-test quick-deploy quick-stop fix-orphans fix-container-orphans \
        up-% down-% logs-%