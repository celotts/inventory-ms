#------------------------------------------------------------------------
# ü¶≠ Makefile para Podman - Sistema de Microservicios InventoryMS
#------------------------------------------------------------------------

#------------------------------------------------------------------------
# üì¶ Variables de entorno y configuraci√≥n
#------------------------------------------------------------------------
CURDIR := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))
ROOT_DIR := $(abspath $(CURDIR)/..)
GRADLEW := $(ROOT_DIR)/gradlew

# Variables de utilidad para salida limpia
Q := @
ifndef VERBOSE
.SILENT:
endif

# Archivos de entorno
ENV_FILE_LOCAL ?= $(CURDIR)/.env.local
ENV_FILE_LOCAL_SUPPLIER ?= $(CURDIR)/.env.local-supplier
ENV_FILE_LOCAL_SUPPLIER_TAX ?= $(CURDIR)/.env.local-supplier-tax
ENV_FILE_DEV ?= $(CURDIR)/.env.dev
ENV_FILE_PROD ?= $(CURDIR)/.env.prod

# Resoluci√≥n de archivos de entorno
ENV_SUPPLIER_FALLBACK ?= $(ENV_FILE_LOCAL)
ENV_FILE_LOCAL_SUPPLIER_RESOLVED := $(if $(wildcard $(ENV_FILE_LOCAL_SUPPLIER)),$(ENV_FILE_LOCAL_SUPPLIER),$(ENV_SUPPLIER_FALLBACK))
ENV_FILE ?= $(ENV_FILE_LOCAL_SUPPLIER_TAX)
ENV_FILE_RESOLVED := $(if $(wildcard $(ENV_FILE)),$(ENV_FILE),)

# Configuraci√≥n de Compose
COMPOSE_FILE ?= docker-compose-podman.yml
COMPOSE_PROJECT_NAME ?= inventoryms
COMPOSE_PROVIDER ?= podman
export COMPOSE_DOCKER_CLI_BUILD ?= 0

# Puertos de servicios
PRODUCT_PORT ?= 9090
SUPPLIER_PORT ?= 9091
PURCHASE_PORT ?= 9095
TAX_PORT ?= 9092
GATEWAY_PORT ?= 8090
DISCOVERY_PORT ?= 8761
CONFIG_PORT ?= 7777

# Perfiles y servicios
PROFILES_ALL := infra gateway product supplier tax purchase
SERVICES_ALL := discovery-service config-service api-gateway product-service supplier-service tax-service purchase-service

# Comandos base
RUN := COMPOSE_PROVIDER=$(COMPOSE_PROVIDER) COMPOSE_PROJECT_NAME=$(COMPOSE_PROJECT_NAME)
COMPOSE_BASE := $(RUN) podman compose -f $(COMPOSE_FILE)

# Comandos espec√≠ficos por entorno
COMPOSE_LOCAL := $(COMPOSE_BASE) --env-file $(ENV_FILE_LOCAL)
COMPOSE_LOCAL_SUPPLIER := $(COMPOSE_BASE) --env-file $(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)
COMPOSE_DEV := $(COMPOSE_BASE) --env-file $(ENV_FILE_DEV)
COMPOSE_PROD := $(COMPOSE_BASE) --env-file $(ENV_FILE_PROD)
#------------------------------------------------------------------------

# üí° MACROS DE UTILIDAD
define check_health
	curl -f --max-time 5 $(1) >/dev/null 2>&1 && echo "‚úÖ $(2)" || echo "‚ùå $(2)"
endef

#üéØ COMANDOS PRINCIPALES - FLUJOS DE TRABAJO ESENCIALES
#------------------------------------------------------------------------

#üöÄ INICIAR SERVICIOS
start: up-local ## üöÄ Iniciar servicios base (Infra + Product + Gateway)
start-all: up-local-all-ordered ## üöÄ Iniciar TODOS los servicios
start-parallel: up-local-all ## üöÄ Iniciar todos los servicios en paralelo

#üõë DETENER SERVICIOS
stop: down-all ## üõë Detener todos los servicios

#üîÑ REINICIAR SERVICIOS
restart: stop start ## üîÑ Reiniciar servicios base
restart-all: stop start-all ## üîÑ Reiniciar todos los servicios

#üõ†Ô∏è DESARROLLO
dev: up-local ## üß™ Entorno de desarrollo base
dev-full: up-local-all-ordered ## üß™ Entorno de desarrollo completo
dev-supplier: up-local-supplier ## üß™ Entorno de desarrollo con Supplier
dev-tax: up-local-with-tax ## üß™ Entorno de desarrollo con Tax

#üèóÔ∏è CONSTRUCCI√ìN
build-all: build-jars-all ## üî® Construir todos los servicios
build-jars: ## üî® Construir JARs base
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :config-service:bootJar :discovery-service:bootJar :api-gateway:bootJar :product-service:bootJar
build-jars-all: ## üî® Construir TODOS los JARs
	@echo "üî® Construyendo todos los JARs..."
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :config-service:bootJar :discovery-service:bootJar :api-gateway:bootJar :product-service:bootJar :supplier-service:bootJar :tax-service:bootJar #:purchase-service:bootJar

#üß™ TESTING
test-all: ## üß™ Ejecutar todos los tests
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) test
test-quick: test-product test-supplier test-tax ## üß™ Tests r√°pidos de servicios principales

#üìä MONITOREO
status: podman-ready ## üìä Estado de todos los servicios
	$(COMPOSE_LOCAL) ps
status-all: status ## üìä Alias para status
logs: podman-ready ## üìú Logs de todos los servicios
	$(COMPOSE_LOCAL) logs -f
health: health-check-extended ## üíö Verificaci√≥n de salud completa
#------------------------------------------------------------------------

#üîß COMANDOS T√âCNICOS - PODMAN Y DOCKER COMPOSE
#------------------------------------------------------------------------
.PHONY: podman-ready
podman-ready: ## üîç Verificar que Podman est√© listo
	@if ! podman info >/dev/null 2>&1; then \
		echo "‚ö†Ô∏è Podman no responde. Intentando iniciar VM..."; \
		podman machine start >/dev/null 2>&1 || { \
			echo "‚ö†Ô∏è Podman Machine no existe. Inicializando y arrancando..."; \
			podman machine init --now >/dev/null 2>&1; \
		}; \
	fi; \
	podman info >/dev/null 2>&1 || ( echo "‚ùå No se pudo conectar a Podman. Aseg√∫rate de que la VM est√© en marcha."; exit 1 )

#üöÄ LEVANTAR SERVICIOS
up-local: podman-ready fix-container-orphans ## üß™ Infra + Product + Gateway
	@echo "üß™ Levantando: Infra + Product + Gateway"
	$(Q) cp $(ENV_FILE_LOCAL) .env.override
	$(Q) $(MAKE) build-jars
	$(Q) $(COMPOSE_LOCAL) --profile infra --profile product --profile gateway up -d --build --remove-orphans
up-local-all: podman-ready fix-container-orphans
	@echo "üöÄ Levantando TODOS los microservicios (paralelo)..."
	$(Q) cp $(ENV_FILE_LOCAL) .env.override
	$(Q) $(MAKE) build-jars-all
	$(Q) $(COMPOSE_LOCAL) --profile infra --profile gateway --profile product --profile supplier --profile tax up -d --build --remove-orphans
	@echo "üîç Verificando salud de los servicios (espera 30s)..."
	$(Q) sleep 30
	$(Q) $(MAKE) health-check-extended
up-local-all-ordered: podman-ready fix-container-orphans ## üöÄ Stack completo en orden correcto
	@echo "üöÄ INICIANDO STACK COMPLETO (ORDENADO)..."
	$(Q) echo "üßπ Limpieza previa..."
	$(Q) $(MAKE) fix-container-orphans
	$(Q) cp $(ENV_FILE_LOCAL) .env.override
	$(Q) $(MAKE) build-jars-all

	@echo "üî® Construyendo discovery-service..."
	$(Q) podman build --no-cache -f $(ROOT_DIR)/discovery-service/Dockerfile -t discovery-service:latest $(ROOT_DIR)

	@echo "üîß 1/5: Discovery Service..."
	$(Q) $(COMPOSE_LOCAL) --profile infra up -d --build discovery-service
	$(Q) sleep 30

	@echo "üîß 2/5: Config Service..."
	$(Q) $(COMPOSE_LOCAL) --profile infra up -d --build config-service
	$(Q) sleep 30

	# AJUSTE CR√çTICO: Eliminamos los nombres expl√≠citos de los servicios (product-db, etc.)
	# y confiamos en que los perfiles (--profile product, --profile supplier, --profile tax)
	# levantar√°n las bases de datos definidas en docker-compose-podman.yml.
	@echo "üóÑÔ∏è 3/5: Bases de datos (Levantando por perfiles)..."
	$(Q) $(COMPOSE_LOCAL) --profile infra --profile product --profile supplier --profile tax up -d
	$(Q) sleep 15

	@echo "üõ†Ô∏è 4/5: Microservicios (Product, Supplier, Tax)..."
	$(Q) $(COMPOSE_LOCAL) --profile infra --profile product --profile supplier --profile tax up -d --build product-service supplier-service tax-service
	$(Q) sleep 45

	@echo "üåê 5/5: API Gateway..."
	$(Q) $(COMPOSE_LOCAL) --profile infra --profile gateway up -d --build api-gateway

	@echo "üîç Verificaci√≥n final (espera 15s)..."
	$(Q) sleep 15
	$(Q) $(MAKE) health-check-extended
	@echo "üéâ STACK COMPLETO LEVANTADO!"
up-local-supplier: podman-ready fix-container-orphans ## üß™ Infra + Supplier
	@echo "üßπ Configurando entorno supplier..."
	$(Q) cp "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" "$(CURDIR)/.env.override"
	$(Q) cd "$(ROOT_DIR)" && $(GRADLEW) :config-service:bootJar :discovery-service:bootJar :supplier-service:bootJar
	@echo "ü¶≠ Levantando supplier..."
	$(Q) $(COMPOSE_LOCAL_SUPPLIER) --profile infra --profile supplier up -d --build --remove-orphans
up-local-with-tax: podman-ready fix-container-orphans ## üß™ Infra + Product + Gateway + Tax
	@echo "üßπ Configurando entorno con tax..."
	$(Q) cp $(ENV_FILE_LOCAL) .env.override
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :config-service:bootJar :discovery-service:bootJar :product-service:bootJar :api-gateway:bootJar :tax-service:bootJar
	@echo "ü¶≠ Levantando servicios con tax..."
	$(Q) $(COMPOSE_LOCAL) --profile infra --profile product --profile gateway --profile tax up -d --build --remove-orphans

#üîª DETENER SERVICIOS
down-local: podman-ready ## üîª Detener servicios locales
	$(COMPOSE_LOCAL) --profile infra --profile product --profile gateway down -v --remove-orphans
down-all: podman-ready ## üîª Detener TODOS los servicios
	@echo "üßπ Deteniendo todos los servicios..."
	$(COMPOSE_LOCAL) $(foreach p,$(PROFILES_ALL),--profile $(p)) down -v --remove-orphans

#üîç MONITOREO Y LOGS
logs-%: podman-ready ## üìú Logs por perfil
	$(COMPOSE_LOCAL) --profile $* logs -f

health-check-extended: podman-ready ## üíö Verificaci√≥n de salud extendida
	@echo "ü©∫ Verificaci√≥n de salud EXTENDIDA..."
	@if ! command -v curl >/dev/null; then echo "‚ùå Error: 'curl' no est√° instalado. No se puede verificar la salud de los microservicios."; fi

	@echo "üîç Infraestructura (Health Actuator):"
	$(call check_health, http://localhost:$(DISCOVERY_PORT)/actuator/health, Discovery)
	$(call check_health, http://localhost:$(CONFIG_PORT)/actuator/health, Config)

	@echo "üîç Bases de datos (pg_isready):"
	$(Q) podman exec $(COMPOSE_PROJECT_NAME)-product-db-1 pg_isready -U product >/dev/null 2>&1 && echo "‚úÖ Product DB" || echo "‚ùå Product DB"
	$(Q) podman exec $(COMPOSE_PROJECT_NAME)-supplier-db-1 pg_isready -U supplier >/dev/null 2>&1 && echo "‚úÖ Supplier DB" || echo "‚ùå Supplier DB"
	$(Q) podman exec $(COMPOSE_PROJECT_NAME)-tax-db-1 pg_isready -U tax >/dev/null 2>&1 && echo "‚úÖ Tax DB" || echo "‚ùå Tax DB"

	@echo "üîç Microservicios (Health Actuator):"
	$(call check_health, http://localhost:$(PRODUCT_PORT)/actuator/health, Product)
	$(call check_health, http://localhost:$(SUPPLIER_PORT)/actuator/health, Supplier)
	$(call check_health, http://localhost:$(TAX_PORT)/actuator/health, Tax)
	$(call check_health, http://localhost:$(GATEWAY_PORT)/actuator/health, Gateway)
#------------------------------------------------------------------------

#üõ†Ô∏è MANTENIMIENTO Y LIMPIEZA
#------------------------------------------------------------------------
fix-container-orphans: ## üßπ Limpiar contenedores hu√©rfanos
	@echo "üßπ Limpiando contenedores hu√©rfanos..."
	$(COMPOSE_LOCAL) down --remove-orphans 2>/dev/null || true
	$(Q) podman system prune -f 2>/dev/null || true
clean-all: podman-ready ## üß® Limpieza completa
	@echo "üß® Limpieza completa..."
	$(Q) $(MAKE) down-all
	$(Q) $(MAKE) clean-podman-prune
	$(Q) $(MAKE) clean-gradle
clean-podman-prune: podman-ready ## üßπ Limpiar recursos de Podman (im√°genes, vol√∫menes, cache)
	$(Q) podman system prune -a -f --volumes
clean-gradle: ## üßπ Limpiar cach√© de Gradle
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) clean
reset-local: clean-all up-local-all-ordered ## üîÑ Reinicio completo del entorno local
#------------------------------------------------------------------------

#üß™ SERVICIOS INDIVIDUALES
#------------------------------------------------------------------------

#üè∑Ô∏è PRODUCT SERVICE
test-product: ## üß™ Tests de Product Service
	$(Q) cd $(ROOT_DIR)/product-service && $(GRADLEW) test
run-product-local: ## üöÄ Ejecutar Product Service localmente
	@echo "üöÄ Product Service en http://localhost:$(PRODUCT_PORT)"
	$(Q) cd $(ROOT_DIR)/product-service && $(GRADLEW) bootRun --args='--spring.profiles.active=local'
rebuild-product-local: podman-ready ## üîÅ Reconstruir Product Service
	$(Q) cp $(ENV_FILE_LOCAL) .env.override
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :product-service:bootJar
	$(Q) $(COMPOSE_LOCAL) build product-service
	$(Q) $(COMPOSE_LOCAL) up -d product-service

#üè∑Ô∏è SUPPLIER SERVICE
test-supplier: ## üß™ Tests de Supplier Service
	$(Q) cd $(ROOT_DIR)/supplier-service && $(GRADLEW) test
run-supplier-local: ## üöÄ Ejecutar Supplier Service localmente
	@echo "üöÄ Supplier Service en http://localhost:$(SUPPLIER_PORT)"
	$(Q) cd $(ROOT_DIR)/supplier-service && $(GRADLEW) bootRun --args='--spring.profiles.active=local'
rebuild-supplier-local: podman-ready ## üîÅ Reconstruir Supplier Service
	$(Q) cp $(ENV_FILE_LOCAL) .env.override
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :supplier-service:bootJar
	$(Q) $(COMPOSE_LOCAL) build supplier-service
	$(Q) $(COMPOSE_LOCAL) up -d supplier-service

#üè∑Ô∏è TAX SERVICE
test-tax: ## üß™ Tests de Tax Service
	$(Q) cd $(ROOT_DIR)/tax-service && $(GRADLEW) test
run-tax-local: ## üöÄ Ejecutar Tax Service localmente
	@echo "üöÄ Tax Service en http://localhost:$(TAX_PORT)"
	$(Q) cd $(ROOT_DIR)/tax-service && $(GRADLEW) bootRun --args='--spring.profiles.active=local'
rebuild-tax-local: podman-ready ## üîÅ Reconstruir Tax Service
	$(Q) cp $(ENV_FILE_LOCAL) .env.override
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :tax-service:bootJar
	$(Q) $(COMPOSE_LOCAL) build tax-service
	$(Q) $(COMPOSE_LOCAL) up -d tax-service

#üè∑Ô∏è PURCHASE SERVICE
test-purchase: ## üß™ Tests de Purchase Service
	$(Q) cd $(ROOT_DIR)/purchase-service && $(GRADLEW) test
run-purchase-local: ## üöÄ Ejecutar Purchase Service localmente
	@echo "üöÄ Purchase Service en http://localhost:$(PURCHASE_PORT)"
	$(Q) cd $(ROOT_DIR)/purchase-service && $(GRADLEW) bootRun --args='--spring.profiles.active=local'
#------------------------------------------------------------------------

#üóÉÔ∏è BASE DE DATOS
#------------------------------------------------------------------------
up-db: podman-ready ## üóÉÔ∏è Levantar solo bases de datos
	@echo "üóÑÔ∏è Levantando bases de datos (solo por perfiles)..."
	# AJUSTE: Eliminamos la lista expl√≠cita de servicios
	$(Q) $(COMPOSE_LOCAL) --profile infra --profile product --profile supplier --profile tax up -d
reset-db: podman-ready ## üóÉÔ∏è Reiniciar base de datos principal
	@echo "üîÑ Reiniciando product-db..."
	$(Q) $(COMPOSE_LOCAL) down -v product-db
	$(Q) $(COMPOSE_LOCAL) up -d product-db
tax-db-reset: podman-ready ## üóÉÔ∏è Reiniciar base de datos de tax
	@echo "üîÑ Reiniciando tax-db y tax-service..."
	$(Q) $(COMPOSE_LOCAL) --profile tax down -v tax-db
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :tax-service:bootJar
	$(Q) $(COMPOSE_LOCAL) --profile tax up -d tax-db tax-service
#------------------------------------------------------------------------

#üÜò DIAGN√ìSTICO AVANZADO Y SOLUCI√ìN DE PROBLEMAS
#------------------------------------------------------------------------

#üîç DIAGN√ìSTICO ESPEC√çFICO PARA DISCOVERY SERVICE
debug-discovery: podman-ready ## üêõ Debug del Discovery Service
	@echo "üêõ Iniciando diagn√≥stico del Discovery Service..."
	@echo "üìã Estado del contenedor:"
	$(Q) podman ps -a --filter name=$(COMPOSE_PROJECT_NAME)-discovery-service-1
	@echo ""
	@echo "üìú √öltimos logs (100 l√≠neas):"
	$(Q) podman logs $(COMPOSE_PROJECT_NAME)-discovery-service-1 --tail 100 2>/dev/null || echo "‚ùå No se pueden obtener logs del discovery-service"
	@echo ""
	@echo "üîç Verificando recursos de Podman:"
	$(Q) podman system info | grep -E "(CPUs|Memory)" | head -2
fix-discovery: podman-ready ## üîß Solucionar problemas del Discovery Service
	@echo "üîß Aplicando correcciones para Discovery Service..."
	@echo "1. Deteniendo contenedor..."
	$(Q) podman stop $(COMPOSE_PROJECT_NAME)-discovery-service-1 2>/dev/null || true
	$(Q) podman rm $(COMPOSE_PROJECT_NAME)-discovery-service-1 2>/dev/null || true
	@echo "2. Reconstruyendo imagen (desde la ra√≠z)..."
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :discovery-service:bootJar
	$(Q) podman build --no-cache -f $(ROOT_DIR)/discovery-service/Dockerfile -t discovery-service:latest $(ROOT_DIR)
	@echo "3. Levantando solo discovery service..."
	$(Q) $(COMPOSE_LOCAL) --profile infra up -d discovery-service
	$(Q) sleep 10
	@echo "5. Verificando logs..."
	$(Q) podman logs $(COMPOSE_PROJECT_NAME)-discovery-service-1 --tail 20
check-discovery-health: ## üîç Verificar salud espec√≠fica del Discovery
	@echo "üîç Verificando salud de Discovery Service..."
	@if curl -s http://localhost:$(DISCOVERY_PORT)/actuator/health >/dev/null; then \
		echo "‚úÖ Discovery Service est√° saludable"; \
	else \
		echo "‚ùå Discovery Service no responde"; \
		echo "üìú √öltimos logs:"; \
		podman logs $(COMPOSE_PROJECT_NAME)-discovery-service-1 --tail 30 2>/dev/null || echo "No hay logs disponibles"; \
	fi

#üìä DIAGN√ìSTICO COMPLETO DEL SISTEMA
diagnose: podman-ready ## üîç Diagn√≥stico completo del sistema
	@echo "üîç Ejecutando diagn√≥stico completo del sistema..."
	@echo ""
	@echo "üìä ESTADO DE CONTENEDORES:"
	$(Q) $(COMPOSE_LOCAL) ps
	@echo ""
	@echo "üíæ RECURSOS DEL SISTEMA:"
	$(Q) podman stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.Status}}" 2>/dev/null || echo "‚ö†Ô∏è No se pudieron obtener estad√≠sticas"
	@echo ""
	@echo "üåê VERIFICACI√ìN DE RED:"
	$(Q) podman network ls
	@echo ""
	@echo "üì¶ VERIFICACI√ìN DE IM√ÅGENES:"
	$(Q) podman images --filter reference="inventory" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
	@echo ""
	@echo "ü©∫ VERIFICACI√ìN DE SALUD:"
	$(Q) $(MAKE) health-check-extended
check-resources: ## üìä Verificar recursos del sistema
	@echo "üìä Verificando recursos de Podman..."
	@echo "üñ•Ô∏è CPUs y Memoria:"
	$(Q) podman system info | grep -E "(CPUs|Memory|Disk)" | head -3
	@echo ""
	@echo "üíæ Uso de disco:"
	$(Q) podman system df
	@echo ""
	@echo "üìà Contenedores activos:"
	$(Q) podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
check-ports: ## üîç Verificar puertos en uso
	@echo "üîç Verificando puertos en uso (solo en el host):"
	@if ! command -v lsof >/dev/null; then echo "‚ö†Ô∏è Advertencia: 'lsof' no est√° instalado. No se puede verificar la disponibilidad de puertos del host."; exit 1; fi
	@for port in $(DISCOVERY_PORT) $(CONFIG_PORT) $(GATEWAY_PORT) $(PRODUCT_PORT) $(SUPPLIER_PORT) $(TAX_PORT) $(PURCHASE_PORT) 5432; do \
		if lsof -Pi :$$port -sTCP:LISTEN -t >/dev/null; then \
			echo "üî¥ Puerto $$port: OCUPADO"; \
		else \
			echo "üü¢ Puerto $$port: LIBRE"; \
		fi; \
	done

#üêõ HERRAMIENTAS DE DEBUGGING
service-logs: podman-ready ## üìú Ver logs de todos los servicios recientes
	@echo "üìú Mostrando √∫ltimos 50 l√≠neas de logs de cada servicio activo:"
	@for service in $$( $(COMPOSE_LOCAL) ps --services ); do \
		echo ""; \
		echo "=== $$service ==="; \
		podman logs $(COMPOSE_PROJECT_NAME)-$$service-1 --tail 50 2>/dev/null | tail -20 || echo "No hay logs disponibles"; \
	done
check-container-status: ## üîç Ver estado detallado de contenedores
	@echo "üîç Estado detallado de contenedores:"
	$(Q) podman ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"

#üöë COMANDOS DE EMERGENCIA
emergency-clean: ## üöë Limpieza de emergencia (cuando nada funciona)
	@echo "üöë EJECUTANDO LIMPIEZA DE EMERGENCIA..."
	@echo "‚õîÔ∏è ¬°ADVERTENCIA! Esto eliminar√° todos los contenedores, im√°genes y vol√∫menes!"
	@read -p "¬øEst√°s seguro? (solo escribe 'SI' para continuar): " confirm; \
	if [ "$$confirm" = "SI" ]; then \
		echo "üßπ Eliminando todos los contenedores..."; \
		podman rm -f $$(podman ps -aq) 2>/dev/null || true; \
		echo "üßπ Eliminando todas las im√°genes..."; \
		podman rmi -f $$(podman images -aq) 2>/dev/null || true; \
		echo "üßπ Eliminando todos los vol√∫menes..."; \
		podman volume rm -f $$(podman volume ls -q) 2>/dev/null || true; \
		echo "üßπ Limpiando sistema..."; \
		podman system prune -a -f --volumes; \
		echo "‚úÖ Limpieza de emergencia completada"; \
	else \
		echo "‚ùå Limpieza cancelada"; \
	fi
restart-podman-vm: ## üîÑ Reiniciar la m√°quina virtual de Podman
	@echo "üîÑ Reiniciando Podman Machine..."
	$(Q) podman machine stop
	$(Q) sleep 5
	$(Q) podman machine start
	@echo "‚úÖ Podman Machine reiniciada"
sync-podman-desktop: ## üçé Sincronizar con Podman Desktop (macOS)
	@echo "üîÑ Sincronizando con Podman Desktop..."
	$(Q) podman system connection default podman-machine-default
	@echo "‚úÖ Podman Desktop sincronizado"
	@echo "üí° Si no ves los contenedores, reinicia Podman Desktop completamente"
fix-discovery-chmod: ## üõ†Ô∏è Solucionar espec√≠ficamente el problema de chmod en discovery
	@echo "üõ†Ô∏è Aplicando fix espec√≠fico para discovery service..."
	# 1. Dar permisos en el host
	$(Q) chmod +x $(ROOT_DIR)/discovery-service/entrypoint.sh $(ROOT_DIR)/discovery-service/wait-for-it.sh
	# 2. Reconstruir JAR
	$(Q) cd $(ROOT_DIR) && $(GRADLEW) :discovery-service:bootJar
	# 3. Reconstruir imagen sin cache (forzando la copia de los scripts)
	$(Q) podman rmi discovery-service:latest 2>/dev/null || true
	$(Q) podman build --no-cache -f $(ROOT_DIR)/discovery-service/Dockerfile -t discovery-service:latest $(ROOT_DIR)
	# 4. Levantar solo discovery
	$(Q) $(COMPOSE_LOCAL) --profile infra up -d discovery-service
	@echo "‚úÖ Fix aplicado, verificando..."
	$(Q) sleep 10
	$(Q) podman logs $(COMPOSE_PROJECT_NAME)-discovery-service-1 --tail 10
diagnose-chmod: ## üîç Diagn√≥stico espec√≠fico de problemas chmod
	@echo "üîç Diagn√≥stico de problemas chmod..."
	@echo ""
	@echo "üìã Permisos de scripts en host:"
	@for service in discovery-service config-service api-gateway product-service supplier-service tax-service; do \
		if [ -f "$(ROOT_DIR)/$$service/entrypoint.sh" ]; then \
			echo "$$service/entrypoint.sh: $$(ls -l $(ROOT_DIR)/$$service/entrypoint.sh | cut -d' ' -f1)"; \
		else \
			echo "‚ùå $$service/entrypoint.sh: NO EXISTE"; \
		fi; \
		if [ -f "$(ROOT_DIR)/$$service/wait-for-it.sh" ]; then \
			echo "$$service/wait-for-it.sh: $$(ls -l $(ROOT_DIR)/$$service/wait-for-it.sh | cut -d' ' -f1)"; \
		else \
			echo "‚ùå $$service/wait-for-it.sh: NO EXISTE"; \
		fi; \
	done
	@echo ""
	@echo "üê≥ Estado de contenedores:"
	$(Q) podman ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
#------------------------------------------------------------------------

#üìñ AYUDA Y DOCUMENTACI√ìN
#------------------------------------------------------------------------
help: ## üìñ Mostrar ayuda general
	@echo "ü¶≠ Makefile para Podman - InventoryMS"
	@echo ""
	@echo "üöÄ COMANDOS PRINCIPALES:"
	@echo "  make start               - Iniciar servicios base (Infra + Product + Gateway)"
	@echo "  make start-all           - Iniciar todos los servicios (en orden)"
	@echo "  make start-parallel      - Iniciar todos los servicios (en paralelo)"
	@echo "  make stop                - Detener todos los servicios"
	@echo "  make restart             - Reiniciar servicios base"
	@echo "  make restart-all         - Reiniciar todos los servicios"
	@echo "  make dev-full            - Entorno de desarrollo completo (ordenado)"
	@echo ""
	@echo "üõ†Ô∏è DESARROLLO:"
	@echo "  make build-all           - Construir todos los JARs"
	@echo "  make test-all            - Ejecutar todos los tests"
	@echo "  make status              - Estado de los servicios"
	@echo "  make logs                - Logs de todos los servicios"
	@echo "  make health              - Verificaci√≥n de salud extendida"
	@echo ""
	@echo "üßπ MANTENIMIENTO:"
	@echo "  make clean-all           - Limpieza completa (detiene, purga podman, limpia gradle)"
	@echo "  make reset-local         - Reinicio completo del entorno local"
	@echo "  make fix-container-orphans - Limpiar contenedores hu√©rfanos"
	@echo ""
	@echo "üîç DIAGN√ìSTICO (TS):"
	@echo "  make diagnose            - Diagn√≥stico completo del sistema"
	@echo "  make check-ports         - Verificar puertos en uso en el host"
	@echo "  make debug-discovery     - Diagn√≥stico espec√≠fico del Discovery Service"
	@echo ""
	@echo "üìñ M√ÅS AYUDA:"
	@echo "  make help-services       - Comandos por servicio"
	@echo "  make help-db             - Comandos de base de datos"
	@echo "  make help-troubleshoot   - Soluci√≥n de problemas avanzada"

help-services: ## üìñ Ayuda de servicios individuales
	@echo "üß™ SERVICIOS INDIVIDUALES:"
	@echo ""
	@echo "üè∑Ô∏è Product Service:"
	@echo "  make run-product-local   - Ejecutar localmente (host)"
	@echo "  make test-product        - Ejecutar tests"
	@echo "  make rebuild-product-local - Reconstruir y levantar el contenedor"
	@echo "..."
help-db: ## üìñ Ayuda de bases de datos
	@echo "üóÉÔ∏è BASES DE DATOS:"
	@echo ""
	@echo "  make up-db               - Levantar solo bases de datos"
	@echo "  make reset-db            - Reiniciar base de datos principal (product-db)"
	@echo "  make tax-db-reset        - Reiniciar base de datos de tax y servicio"
help-troubleshoot: ## üìñ Ayuda de soluci√≥n de problemas
	@echo "üÜò SOLUCI√ìN DE PROBLEMAS ESPEC√çFICA:"
	@echo ""
	@echo "üîç DIAGN√ìSTICO:"
	@echo "  make diagnose            - Diagn√≥stico completo del sistema"
	@echo "  make debug-discovery     - Diagn√≥stico espec√≠fico del Discovery Service"
	@echo "  make check-ports         - Verificar puertos en uso"
	@echo "  make service-logs        - Logs recientes de todos los servicios"
	@echo "  make diagnose-chmod      - Diagn√≥stico de permisos de ejecuci√≥n (chmod)"
	@echo ""
	@echo "üîß SOLUCIONES:"
	@echo "  make fix-discovery       - Solucionar problemas del Discovery Service"
	@echo "  make fix-discovery-chmod - Solucionar espec√≠ficamente problemas de permisos en discovery"
	@echo "  make restart-podman-vm   - Reiniciar la m√°quina virtual de Podman"
	@echo "  make emergency-clean     - Limpieza completa (¬°USAR CON CUIDADO!)"
	@echo ""
	@echo "üí° CONSEJOS:"
	@echo "  ‚Ä¢ Si un servicio falla al iniciar, usa 'make service-logs' para ver el error."
	@echo "  ‚Ä¢ Los errores de 'exec format error' suelen ser problemas de permisos. Usa 'make diagnose-chmod' y 'make fix-discovery-chmod'."
.PHONY: help help-services help-db help-troubleshoot start start-all start-parallel \
	stop restart restart-all dev dev-full dev-supplier dev-tax build-all build-jars \
	build-jars-all test-all test-quick status status-all logs health podman-ready \
	up-local up-local-all up-local-all-ordered up-local-supplier up-local-with-tax \
	down-local down-all logs-% health-check-extended fix-container-orphans clean-all \
	clean-podman-prune clean-gradle reset-local test-product run-product-local rebuild-product-local \
	test-supplier run-supplier-local rebuild-supplier-local test-tax run-tax-local rebuild-tax-local \
	test-purchase run-purchase-local up-db reset-db tax-db-reset diagnose check-ports \
	sync-podman-desktop debug-discovery fix-discovery check-discovery-health check-resources \
	service-logs check-container-status emergency-clean restart-podman-vm fix-discovery-chmod diagnose-chmod