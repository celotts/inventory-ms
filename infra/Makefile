#------------------------------------------------------------------------
# ðŸ“¦ Variables de entorno
#------------------------------------------------------------------------
# Rutas absolutas seguras
CURDIR := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))

# ðŸ§­ RaÃ­z del proyecto (una carpeta arriba de infra)
ROOT_DIR := $(abspath $(CURDIR)/..)
GRADLEW  := $(ROOT_DIR)/gradlew

# Archivos .env (con rutas absolutas)
# ðŸŽ¯ APUNTAR A LA RAÃZ DEL PROYECTO (ROOT_DIR)
ENV_FILE_LOCAL            ?= $(CURDIR)/.env.local
ENV_FILE_LOCAL_SUPPLIER   ?= $(CURDIR)/.env.local-supplier
ENV_FILE_DEV              ?= $(CURDIR)/.env.dev
ENV_FILE_PROD             ?= $(CURDIR)/.env.prod

# Fallback: si no existe .env.local-supplier, usar .env.local
ENV_SUPPLIER_FALLBACK     ?= $(ENV_FILE_LOCAL)
ENV_FILE_LOCAL_SUPPLIER_RESOLVED := $(if $(wildcard $(ENV_FILE_LOCAL_SUPPLIER)),$(ENV_FILE_LOCAL_SUPPLIER),$(ENV_SUPPLIER_FALLBACK))

# ðŸ†• Archivo de compose unificado
COMPOSE_FILE_LOCAL ?= docker-compose-podman.yml
COMPOSE_FILE_DEV   ?= docker-compose-podman.yml
COMPOSE_FILE_PROD  ?= docker-compose-podman.yml
# ðŸ“› Nombre de proyecto para Compose (evita vacÃ­o en nombres y mensajes)
COMPOSE_PROJECT_NAME ?= inventoryms

# ðŸ“Œ Puertos por defecto de servicios
PRODUCT_PORT   ?= 9090
SUPPLIER_PORT  ?= 9091
PURCHASE_PORT  ?= 9095
TAX_PORT       ?= 9092
GATEWAY_PORT   ?= 8090
DISCOVERY_PORT ?= 8761
CONFIG_PORT    ?= 7777

# ðŸ§° Helpers DRY (usar subcomando oficial `podman compose` y aislar sockets)
export COMPOSE_PROVIDER ?= podman
# (opcional) desactivar paths heredados de docker-cli/build
export COMPOSE_DOCKER_CLI_BUILD ?= 0

# ðŸ“Œ CORRECCIÃ“N: Permitir que Podman Desktop vea los contenedores
# Se removiÃ³ CONTAINER_HOST= DOCKER_HOST= para usar la conexiÃ³n por defecto
RUN := COMPOSE_PROVIDER=$(COMPOSE_PROVIDER) \
       COMPOSE_PROJECT_NAME=$(COMPOSE_PROJECT_NAME)

COMPOSE_LOCAL          := $(RUN) podman compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL)
COMPOSE_LOCAL_SUPPLIER := $(RUN) podman compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)
COMPOSE_DEV            := $(RUN) podman compose -f $(COMPOSE_FILE_DEV)   --env-file $(ENV_FILE_DEV)
COMPOSE_PROD           := $(RUN) podman compose -f $(COMPOSE_FILE_PROD)  --env-file $(ENV_FILE_PROD)

# ðŸ”– Perfiles disponibles
PROFILES_ALL := infra gateway product supplier purchase tax

# Usa UNO o VARIOS compose files (separados por espacio)
COMPOSE_FILES ?= $(CURDIR)/docker-compose.yml
COMPOSE_F := $(foreach f,$(COMPOSE_FILES),-f $(f))

# ------------------------------------------------------------------------
# ðŸ§  VerificaciÃ³n previa: Podman Machine y â€œconnectionâ€ por defecto
# ------------------------------------------------------------------------
.PHONY: podman-ready
podman-ready:
	@unset CONTAINER_HOST DOCKER_HOST; \
	if ! podman info >/dev/null 2>&1; then \
	  echo "âš ï¸  Podman no responde. Iniciando VM..."; \
	  podman machine start >/dev/null 2>&1 || podman machine init --now >/dev/null 2>&1; \
	fi; \
	podman system connection list | grep -q podman-machine-default-root && \
	  podman system connection default podman-machine-default-root >/dev/null 2>&1 || true; \
	podman info >/dev/null 2>&1 || ( echo "âŒ No se pudo conectar a Podman."; exit 1 )

#------------------------------------------------------------------------
# ðŸ§‘â€ðŸ’» Funciones de desarrollo LOCAL (sin Docker)
#------------------------------------------------------------------------
validate-product: ## âœ… Valida la compilaciÃ³n y tests de product-service (sin Docker)
	cd .. && ./gradlew :product-service:build

validate-product-no-tests: ## âœ… Valida product-service sin ejecutar pruebas
	cd .. && ./gradlew :product-service:build -x test

clean-gradle: ## ðŸ§¹ Limpia cachÃ© y compilaciÃ³n de Gradle
	cd .. && ./gradlew clean

compose-provider: ## ðŸ”Ž Mostrar provider y versiÃ³n de podman compose
	@echo "COMPOSE_PROVIDER=$(COMPOSE_PROVIDER)"
	@echo "PODMAN_COMPOSE_PROVIDER=$(PODMAN_COMPOSE_PROVIDER)"
	@podman compose version

#------------------------------------------------------------------------
# â™»ï¸ Targets genÃ©ricos por perfil (UP/DOWN/LOGS)
#------------------------------------------------------------------------
up-%: podman-ready ## Levanta por perfil: infra|gateway|product|supplier|purchase|all
	@if [ "$*" = "all" ]; then \
		$(COMPOSE_LOCAL) $(foreach p,$(PROFILES_ALL),--profile $(p)) up -d --build; \
	else \
		$(COMPOSE_LOCAL) --profile $* up -d --build; \
	fi

down-%: podman-ready ## Baja por perfil: infra|gateway|product|supplier|purchase|all
	@if [ "$*" = "all" ]; then \
		$(COMPOSE_LOCAL) $(foreach p,$(PROFILES_ALL),--profile $(p)) down -v --remove-orphans; \
	else \
		$(COMPOSE_LOCAL) --profile $* down -v --remove-orphans; \
	fi

logs-%: podman-ready ## Logs por perfil: infra|gateway|product|supplier|purchase
	$(COMPOSE_LOCAL) --profile $* logs -f

#------------------------------------------------------------------------
# ðŸ¦­ Funciones que USAN Podman Compose
#------------------------------------------------------------------------

## ðŸ”½ Infraestructura por entorno
up-local: podman-ready fix-container-orphans ## ðŸ§ª Infra + product + gateway para trabajar desde IntelliJ
	@echo "ðŸ§¹ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override
	@echo "ðŸ”¨ Construyendo servicios..."
	cd .. && ./gradlew :config-service:bootJar :discovery-service:bootJar :product-service:bootJar :api-gateway:bootJar
	@echo "ðŸ¦­ Levantando contenedores con Podman (perfiles: infra, product, gateway)..."
	$(COMPOSE_LOCAL) --profile infra --profile product --profile gateway up -d --build

up-local-supplier: podman-ready fix-container-orphans
	@echo "ðŸ§¹ Copiando variables de entorno (supplier)..."
	@echo "[INFO] Archivo supplier detectado: $(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)"
	cp "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" "$(CURDIR)/.env.override"

	@echo "ðŸ”Ž Verificando que supplier-db y supplier-service existan (perfiles: infra,supplier)..."
	@SERVICES="$$(COMPOSE_PROFILES=infra,supplier \
	  $(RUN) podman compose -f "$(COMPOSE_FILE_LOCAL)" --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
	    --profile infra --profile supplier config --services 2>/dev/null || true)"; \
	echo "$$SERVICES" | grep -qx "supplier-db"      || { echo "âŒ Falta supplier-db"; exit 1; }; \
	echo "$$SERVICES" | grep -qx "supplier-service" || { echo "âŒ Falta supplier-service"; exit 1; }; \
	echo "âœ… Servicios detectados: supplier-db y supplier-service";

	@echo "ðŸ”¨ Construyendo JARs necesarios..."
	cd "$(CURDIR)/.." && ./gradlew :config-service:bootJar :discovery-service:bootJar :supplier-service:bootJar

	@echo "ðŸ¦­ Levantando discovery, config, supplier-db y supplier-service..."
	COMPOSE_PROFILES=infra,supplier \
	$(COMPOSE_LOCAL_SUPPLIER) \
	  --profile infra --profile supplier \
	  up -d --build discovery-service config-service supplier-db supplier-service

## ðŸ”½ Levantar product + supplier
up-local-product-supplier: podman-ready fix-container-orphans ## ðŸ§ª Infra + product + supplier
	@echo "ðŸ§¹ Copiando variables de entorno..."
	@echo "â„¹ï¸  Archivo supplier detectado: $(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)"
	cp "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" "$(CURDIR)/.env.override"

	@COMPOSE_FILE="$(CURDIR)/docker-compose-podman.yml"; \
	echo "ðŸ”Ž Validando compose (perfiles: infra,product,supplier)"; \
	COMPOSE_PROFILES=infra,product,supplier \
	$(RUN) podman compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
	  config >/dev/null || { \
	    echo "âŒ 'podman compose config' fallÃ³. Mostrando salida completa para diagnÃ³stico:"; \
	    COMPOSE_PROFILES=infra,product,supplier \
	    $(RUN) podman compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" config; \
	    exit 1; \
	  }; \
	OUT="$$(COMPOSE_PROFILES=infra,product,supplier \
	  $(RUN) podman compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
	    config --services)"; \
	LINES="$$(printf "%s\n" "$$OUT" | tr ' ' '\n' | sed '/^$$/d')"; \
	echo "ðŸ“‹ Servicios detectados:"; printf "%s\n" "$$LINES"; \
	for s in discovery-service config-service product-db product-service supplier-db supplier-service; do \
	  echo "$$LINES" | grep -xq $$s || { echo "âŒ Falta $$s"; exit 1; }; \
	done; \
	echo "âœ… Todos los servicios requeridos estÃ¡n definidos."

	@echo "ðŸ”¨ Construyendo JARs necesarios (incluye product/supplier)..."
	cd "$(CURDIR)/.." && ./gradlew \
		:config-service:bootJar \
		:discovery-service:bootJar \
		:product-service:bootJar \
		:supplier-service:bootJar

	@echo "ðŸ¦­ Levantando discovery, config, product y supplier..."
	@COMPOSE_PROFILES=infra,product,supplier \
	$(RUN) podman compose -f "$(CURDIR)/docker-compose-podman.yml" --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
	  --profile infra --profile product --profile supplier \
	  up -d --build \
	  discovery-service config-service \
	  product-db product-service \
	  supplier-db supplier-service || { echo "âŒ 'podman compose up' fallÃ³"; exit 1; }

	@$(COMPOSE_LOCAL_SUPPLIER) ps

up-local-purchase: podman-ready fix-container-orphans ## ðŸ§ª Base + purchase
	@echo "ðŸ§¹ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override

	@echo "ðŸ”¨ Construyendo base + purchase..."
	cd .. && ./gradlew \
		:config-service:bootJar \
		:discovery-service:bootJar \
		:api-gateway:bootJar \
		:product-service:bootJar \
		:purchase-service:bootJar

	@echo "ðŸ¦­ Levantando contenedores (infra, product, gateway, purchase)..."
	$(RUN) podman compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) \
		--profile infra --profile gateway --profile product \
		--profile purchase \
		up -d --build

up-dev: podman-ready ## ðŸ§ª Levanta todo el stack en contenedores (modo dev)
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) $(foreach p,$(PROFILES_ALL),--profile $(p)) down -v --remove-orphans
	$(COMPOSE_DEV) $(foreach p,$(PROFILES_ALL),--profile $(p)) up -d --build

up-prod: podman-ready ## ðŸš€ Levanta todo en entorno de producciÃ³n
	cp $(ENV_FILE_PROD) .env.override
	$(COMPOSE_PROD) $(foreach p,$(PROFILES_ALL),--profile $(p)) down -v --remove-orphans
	$(COMPOSE_PROD) $(foreach p,$(PROFILES_ALL),--profile $(p)) up -d --build

up-db: podman-ready ## ðŸ”„ Levanta solo la base de datos para desarrollo local (product-db)
	$(COMPOSE_LOCAL) --profile infra --profile product up -d product-db

print-envs: ## ðŸ”Ž Mostrar quÃ© .env usarÃ¡ cada target
	@echo "CURDIR:                         $(CURDIR)"
	@echo "ENV_FILE_LOCAL:                 $(ENV_FILE_LOCAL)"
	@echo "ENV_FILE_LOCAL_SUPPLIER:        $(ENV_FILE_LOCAL_SUPPLIER)"
	@echo "ENV_SUPPLIER_FALLBACK:          $(ENV_SUPPLIER_FALLBACK)"
	@echo "ENV_FILE_LOCAL_SUPPLIER_RESOLVED: $(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)"

up-local-all: podman-ready ## ðŸš€ Levanta TODO el stack con .env.local
	@echo "ðŸ§¹ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override

	@echo "ðŸ”¨ Construyendo TODOS los JARs..."
	$(MAKE) build-jars-all

	@echo "ðŸ¦­ Levantando contenedores (TODOS los perfiles)..."
	$(RUN) podman compose -f $(COMPOSE_FILE_LOCAL) --env-file $(ENV_FILE_LOCAL) \
	   $(foreach p,$(PROFILES_ALL),--profile $(p)) \
	   up -d --build
# ---------------------------------------------------------------------
# ðŸ†• Nuevo: Levantar TODO el stack localmente con .env.local
# ---------------------------------------------------------------------


# ---------------------------------------------------------------------
# ðŸ§ª Supplier Service
# ---------------------------------------------------------------------
rebuild-supplier-local: podman-ready ## ðŸ” Rebuild supplier-service (local)
	@echo "ðŸ› ï¸  Rebuild supplier-service (local)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :supplier-service:bootJar
	# build con perfiles infra,supplier
	COMPOSE_PROFILES=infra,supplier \
	$(COMPOSE_LOCAL) --profile infra --profile supplier build supplier-service
	# up incluyendo dependencias reales
	COMPOSE_PROFILES=infra,supplier \
	$(COMPOSE_LOCAL) --profile infra --profile supplier \
	  up -d discovery-service config-service supplier-db supplier-service

rebuild-supplier-dev: podman-ready ## ðŸ” Rebuild supplier-service (dev)
	@echo "ðŸ› ï¸  Rebuild supplier-service (dev)"
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) build supplier-service
	$(COMPOSE_DEV) up -d supplier-service

run-supplier-local: ## ðŸš€ Ejecutar supplier-service local (sin contenedor)
	@echo "ðŸš€ supplier-service local en http://localhost:$(SUPPLIER_PORT)"
	cd ../supplier-service && ./gradlew bootRun --args='--spring.profiles.active=local'

test-supplier: ## ðŸ§ª Tests supplier-service
	cd ../supplier-service && ./gradlew test

health-supplier: ## ðŸ’š Health de supplier-service
	@curl -fsS http://localhost:$(SUPPLIER_PORT)/actuator/health | jq . || echo "âŒ supplier-service no responde"

# ---------------------------------------------------------------------
# ðŸ§ª Purchase Service
# ---------------------------------------------------------------------
rebuild-purchase-local: podman-ready ## ðŸ” Rebuild purchase-service (local)
	@echo "ðŸ› ï¸  Rebuild purchase-service (local)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :purchase-service:bootJar
	$(COMPOSE_LOCAL) build purchase-service
	$(COMPOSE_LOCAL) up -d purchase-service

help-tax: ## ðŸ“– Comandos de tax-service
	@echo "tax-service:"
	@echo "  make up-tax                      - Levantar perfil tax (compose)"
	@echo "  make rebuild-tax-local           - Rebuild + up (local)"
	@echo "  make run-tax-local               - Ejecutar sin contenedor (perfil local)"
	@echo "  make test-tax                    - Ejecutar tests"
	@echo "  make health-tax                  - Ver health"
	@echo "  make tax-jar                     - Construir sÃ³lo el JAR de tax"
	@echo "  make tax-verify                  - Verifica tablas/seed en tax-db"
	@echo "  make tax-doctor                  - DiagnÃ³stico rÃ¡pido (i18n + compose + mÃ³dulo)"

test-tax: ## ðŸ§ª Tests tax-service
	cd ../tax-service && ./gradlew test

build-tax: ## ðŸ”¨ Construir tax-service
	cd ../tax-service && ./gradlew build

rebuild-purchase-dev: podman-ready ## ðŸ” Rebuild purchase-service (dev)
	@echo "ðŸ› ï¸  Rebuild purchase-service (dev)"
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) build purchase-service
	$(COMPOSE_DEV) up -d purchase-service

run-purchase-local: ## ðŸš€ Ejecutar purchase-service local (sin contenedor)
	@echo "ðŸš€ purchase-service local en http://localhost:$(PURCHASE_PORT)"
	cd ../purchase-service && ./gradlew bootRun --args='--spring.profiles.active=local'

test-purchase: ## ðŸ§ª Tests purchase-service
	cd ../purchase-service && ./gradlew test

health-purchase: ## ðŸ’š Health de purchase-service
	@curl -fsS http://localhost:$(PURCHASE_PORT)/actuator/health | jq . || echo "âŒ purchase-service no responde"

down-local: podman-ready ## ðŸ”» Apaga infra local (perfiles: infra, product, gateway)
	$(COMPOSE_LOCAL) --profile infra --profile product --profile gateway down -v --remove-orphans

## ðŸ” Build y Rebuild
build-images: podman-ready ## ðŸ—ï¸ Build manual de imÃ¡genes
	podman build -t inventory/discovery-service ../discovery-service
	podman build -t inventory/config-service ../config-service
	podman build -t inventory/api-gateway ../api-gateway
	podman build -t inventory/product-service ../product-service
	podman build -t inventory/tax-service ../tax-service

build-jars:
	cd .. && ./gradlew --console=plain :config-service:bootJar :discovery-service:bootJar :api-gateway:bootJar :product-service:bootJar

# ðŸ†• Build con TAX opcional (si el mÃ³dulo existe e incluido en settings.gradle)
build-jars-all:
	@if [ -f "../tax-service/build.gradle" ] && grep -q 'include\("?tax-service"?\)' ../settings.gradle; then \
	  echo "ðŸ”¨ Construyendo todos los JARs (incluye tax-service)..."; \
	  cd .. && ./gradlew --console=plain \
	    :config-service:bootJar \
	    :discovery-service:bootJar \
	    :api-gateway:bootJar \
	    :product-service:bootJar \
	    :tax-service:bootJar; \
	else \
	  echo "â„¹ï¸ tax-service no presente; ejecutando build base"; \
	  cd .. && ./gradlew --console=plain \
	    :config-service:bootJar \
	    :discovery-service:bootJar \
	    :api-gateway:bootJar \
	    :product-service:bootJar; \
	fi

# ðŸ†• Comandos para servicios individuales
rebuild-api-gateway-local: podman-ready ## ðŸ” Reconstruye solo api-gateway (local)
	@echo "ðŸ› ï¸  Reconstruyendo api-gateway con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :api-gateway:bootJar
	$(COMPOSE_LOCAL) build api-gateway
	$(COMPOSE_LOCAL) up -d api-gateway

rebuild-config-service-local: podman-ready ## ðŸ” Reconstruye solo config-service (local)
	@echo "ðŸ› ï¸  Reconstruyendo config-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	$(COMPOSE_LOCAL) build config-service
	$(COMPOSE_LOCAL) up -d config-service

rebuild-discovery-local: podman-ready ## ðŸ” Reconstruye solo discovery-service (local)
	@echo "ðŸ› ï¸  Reconstruyendo discovery-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	$(COMPOSE_LOCAL) build discovery-service
	$(COMPOSE_LOCAL) up -d discovery-service

rebuild-product-local: podman-ready ## ðŸ” Reconstruye solo product-service (local)
	@echo "ðŸ› ï¸  Reconstruyendo product-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	$(COMPOSE_LOCAL) build product-service
	$(COMPOSE_LOCAL) up -d product-service

rebuild-product-dev: podman-ready ## ðŸ” Reconstruye solo product-service (dev)
	@echo "ðŸ› ï¸  Reconstruyendo product-service con env: $(ENV_FILE_DEV)"
	cp $(ENV_FILE_DEV) .env.override
	$(COMPOSE_DEV) build product-service
	$(COMPOSE_DEV) up -d product-service

## â™»ï¸ Mantenimiento y limpieza
clean-volumes: podman-ready ## ðŸ§¹ Limpia volÃºmenes no usados
	podman volume prune -f

clean-images: podman-ready ## ðŸ§¹ Limpia imÃ¡genes sin contenedor
	podman image prune -a -f

clean-podman: podman-ready ## ðŸ§¹ Limpia imÃ¡genes sin contenedor y volÃºmenes
	$(MAKE) clean-images
	$(MAKE) clean-volumes

stop-all: podman-ready ## ðŸ›‘ Detiene todos los contenedores activos en Podman
	@echo "ðŸ›‘ Deteniendo todos los contenedores..."
	podman ps -q | xargs -r podman stop
	podman system prune -f --volumes

reset-db: podman-ready ## ðŸ§¨ Reinicia product-db con script inicial
	@echo "â›” Eliminando contenedor y volumen de product-db..."
	$(COMPOSE_LOCAL) down -v --remove-orphans
	@echo "ðŸš€ Levantando product-db..."
	$(COMPOSE_LOCAL) up --build -d product-db
	@echo "ðŸ“‹ Mostrando logs..."
	podman logs -f product-db

reset-local: ## ðŸ” Reinicia completamente el entorno local
	$(MAKE) down-local
	$(MAKE) clean-podman
	$(MAKE) up-local

reload-schema: podman-ready ## â™»ï¸ Ejecuta el script SQL en product-db
	podman cp ./init-scripts/product-init.sql product-db:/tmp/product-init.sql
	podman exec -it product-db psql -U product -d product -f /tmp/product-init.sql

## ðŸ” Logs y verificaciÃ³n
logs-local: podman-ready ## ðŸ“œ Logs de todos los servicios locales
	$(COMPOSE_LOCAL) logs -f

logs-dev: podman-ready ## ðŸ“œ Logs del entorno dev
	$(COMPOSE_DEV) logs -f

# ðŸ†• Logs especÃ­ficos por servicio
logs-api-gateway: podman-ready ## ðŸ“œ Logs del API Gateway
	$(COMPOSE_LOCAL) logs -f api-gateway

logs-discovery: podman-ready ## ðŸ“œ Logs del Discovery Service
	$(COMPOSE_LOCAL) logs -f discovery-service

logs-config: podman-ready ## ðŸ“œ Logs del Config Service
	$(COMPOSE_LOCAL) logs -f config-service

logs-product: podman-ready ## ðŸ“œ Logs del Product Service
	$(COMPOSE_LOCAL) logs -f product-service

logs-db: podman-ready ## ðŸ“œ Logs de la base de datos
	$(COMPOSE_LOCAL) logs -f product-db

check-db-init: podman-ready ## ðŸ”Ž Verifica existencia del volumen product-db
	@echo "ðŸ”Ž Verificando volumen de la base de datos..."
	@if ! podman volume inspect inventoryms_product-data >/dev/null 2>&1; then \
		echo "âœ… Volumen no existe. Se ejecutarÃ¡ el script SQL al levantar PostgreSQL."; \
	else \
		echo "âš ï¸ Volumen ya existe. PostgreSQL NO ejecutarÃ¡ el script de inicializaciÃ³n."; \
	fi
	@$(MAKE) up-local

# ðŸ†• Status y testing
status: podman-ready ## ðŸ“Š Ver estado de todos los servicios
	$(COMPOSE_LOCAL) ps

podman-status: podman-ready ## ðŸ“Š Ver todos los contenedores Podman
	podman ps -a

# Base sin TAX
test-services: ## ðŸ§ª Probar servicios base (sin TAX)
	@printf "ðŸ§ª Probando servicios (base)...\n"
	@printf "Discovery Service (8761):\n"
	@curl -s http://localhost:8761/actuator/health | jq . || echo "âŒ Discovery Service no responde"
	@printf "\nConfig Service (7777):\n"
	@curl -s http://localhost:7777/actuator/health | jq . || echo "âŒ Config Service no responde"
	@printf "\nAPI Gateway (8090):\n"
	@curl -s http://localhost:8090/actuator/health | jq . || echo "âŒ API Gateway no responde"
	@printf "\nProduct Service (9090):\n"
	@curl -s http://localhost:9090/actuator/health | jq . || echo "âŒ Product Service no responde"

# Extendido con TAX
test-services-all:
	@$(MAKE) test-services
	@printf "\nTax Service (9092):\n"
	@if curl -s http://localhost:9092/actuator/health >/dev/null 2>&1; then \
	  curl -s http://localhost:9092/actuator/health | jq . ; \
	else \
	  echo "â„¹ï¸ Tax Service no responde (puede no estar levantado)"; \
	fi

# ConstrucciÃ³n paso a paso con verificaciÃ³n
build-step-by-step:
	@echo "ðŸ§¹ Limpiando proyecto..."
	cd .. && ./gradlew clean
	@echo "ðŸ”¨ Construyendo config-service..."
	cd .. && ./gradlew :config-service:bootJar
	@echo "ðŸ”¨ Construyendo discovery-service..."
	cd .. && ./gradlew :discovery-service:bootJar
	@echo "ðŸ”¨ Construyendo api-gateway..."
	cd .. && ./gradlew :api-gateway:bootJar
	@echo "ðŸ”¨ Construyendo product-service..."
	cd .. && ./gradlew :product-service:bootJar
	@echo "âœ… Verificando JARs creados..."
	@ls -la ../*/build/libs/*.jar || echo "âŒ Algunos JARs no se crearon"
	@echo "ðŸŽ‰ ConstrucciÃ³n completada con Podman!"

# ðŸ†• Comandos adicionales para Podman
pods-list: podman-ready ## ðŸ“‹ Lista todos los pods de Podman
	podman pod ps

pods-stats: podman-ready ## ðŸ“Š EstadÃ­sticas de recursos de Podman
	podman stats --no-stream

images-list: podman-ready ## ðŸ–¼ï¸ Lista todas las imÃ¡genes de Podman
	podman images

system-info: podman-ready ## â„¹ï¸ InformaciÃ³n del sistema Podman
	podman system info

podman-start: podman-ready ## ðŸš€ Inicia la mÃ¡quina virtual de Podman
	podman machine start

podman-machine-list: podman-ready ## ðŸ“‹ Lista todas las mÃ¡quinas virtuales de Podman
	podman machine list

podman-view-all: podman-ready ## ðŸ‘€ Ver todos los contenedores (activos e inactivos)
	podman ps -a

podman-remove-all: podman-ready ## ðŸ—‘ï¸ Eliminar todos los contenedores
	podman rm --all --force

#------------------------------------------------------------------------
# ðŸ§ª Product Service - Comandos especÃ­ficos para desarrollo local
#------------------------------------------------------------------------
## (sin cambios funcionales aquÃ­, se mantienen tal cual)
test-product: ## ðŸ§ª Ejecutar todos los tests del product-service
	@echo "ðŸ§ª Ejecutando tests del product-service..."
	cd ../product-service && ./gradlew test

test-product-unit: ## ðŸ§ª Ejecutar solo tests unitarios del product-service
	@echo "ðŸ§ª Ejecutando tests unitarios del product-service..."
	cd ../product-service && ./gradlew test --tests "*Test"

test-product-controller: ## ðŸ§ª Testear ProductController especÃ­ficamente
	@echo "ðŸ§ª Testeando ProductController..."
	cd ../product-service && ./gradlew test --tests ProductControllerTest

test-product-app: ## ðŸ§ª Testear carga de aplicaciÃ³n del product-service
	@echo "ðŸ§ª Testeando carga de aplicaciÃ³n..."
	cd ../product-service && ./gradlew test --tests ProductServiceApplicationTests

test-product-health: ## ðŸ§ª Testear health endpoint del product-service
	@echo "ðŸ§ª Testeando health endpoint..."
	cd ../product-service && ./gradlew test --tests HealthCheckTest

test-product-report: ## ðŸ“Š Abrir reporte de tests del product-service
	@echo "ðŸ“Š Abriendo reporte de tests..."
	@open ../product-service/build/reports/tests/test/index.html || echo "âŒ No se pudo abrir el reporte. Ejecuta 'make test-product' primero."

test-product-local: ## ðŸ§ª Ejecutar tests con perfil local
	@echo "ðŸ§ª Ejecutando tests con perfil local..."
	cd ../product-service && ./gradlew test --args='--spring.profiles.active=local'

## ðŸš€ Desarrollo local del Product Service (sin contenedores)
run-product-local: ## ðŸš€ Ejecutar product-service localmente con perfil local (puerto 9090)
	@echo "ðŸš€ Iniciando product-service en modo desarrollo local con perfil 'local'..."
	@echo "ðŸ“ La aplicaciÃ³n estarÃ¡ disponible en: http://localhost:$(PRODUCT_PORT)"
	@echo "ðŸ§ª Endpoint de prueba: http://localhost:$(PRODUCT_PORT)/api/v1/products/test"
	@echo "ðŸ’š Health check: http://localhost:$(PRODUCT_PORT)/actuator/health"
	@echo "ðŸ”§ Usando perfil: local (localhost:5432)"
	cd ../product-service && ./gradlew bootRun --args='--spring.profiles.active=local'

run-product-dev: ## ðŸš€ Ejecutar product-service con perfil dev (para contenedores)
	@echo "ðŸš€ Iniciando product-service en modo desarrollo con perfil 'dev'..."
	@echo "ðŸ”§ Usando perfil: dev (product-db:5432)"
	cd ../product-service && ./gradlew bootRun --args='--spring.profiles.active=dev'

run-product-profile: ## ðŸš€ Ejecutar product-service con perfil especÃ­fico (usar PROFILE=nombre)
	@echo "ðŸš€ Iniciando product-service con perfil: $(PROFILE)"
	cd ../product-service && ./gradlew bootRun --args='--spring.profiles.active=$(PROFILE)'

dev-product: run-product-local ## ðŸš€ Alias para run-product-local

stop-product-local: ## ðŸ›‘ Detener product-service local
	@echo "ðŸ›‘ Deteniendo product-service local..."
	@pkill -f "product-service" || echo "â„¹ï¸  No hay procesos del product-service ejecutÃ¡ndose"

## ðŸ”¨ Build del Product Service
build-product: ## ðŸ”¨ Construir product-service para producciÃ³n
	@echo "ðŸ”¨ Construyendo product-service para producciÃ³n..."
	cd ../product-service && ./gradlew build

build-product-no-tests: ## ðŸ”¨ Construir product-service sin tests
	@echo "ðŸ”¨ Construyendo product-service sin tests..."
	cd ../product-service && ./gradlew build -x test

clean-product: ## ðŸ§¹ Limpiar archivos temporales del product-service
	@echo "ðŸ§¹ Limpiando product-service..."
	cd ../product-service && ./gradlew clean

rebuild-product-local-dev: clean-product build-product ## â™»ï¸ Limpiar y construir product-service

## âœ… Calidad del Product Service
check-product: clean-product test-product build-product ## âœ… VerificaciÃ³n completa del product-service (clean + test + build)
	@echo "âœ… VerificaciÃ³n de calidad del product-service completada"

lint-product: ## ðŸ” Verificar estilo de cÃ³digo del product-service
	@echo "ðŸ” Verificando estilo de cÃ³digo del product-service..."
	cd ../product-service && ./gradlew check

## ðŸ“¦ Dependencias del Product Service
deps-product: ## ðŸ“¦ Mostrar dependencias del product-service
	@echo "ðŸ“¦ Mostrando dependencias del product-service..."
	cd ../product-service && ./gradlew dependencies

deps-product-update: ## ðŸ“¦ Actualizar dependencias del product-service
	@echo "ðŸ“¦ Actualizando dependencias del product-service..."
	cd ../product-service && ./gradlew build --refresh-dependencies

## ðŸ› ï¸ Utilidades del Product Service
health-product: ## ðŸ’š Verificar health del product-service
	@echo "ðŸ’š Verificando health del product-service..."
	@curl -f http://localhost:$(PRODUCT_PORT)/actuator/health 2>/dev/null && echo "\nâœ… Product Service funcionando correctamente" || echo "âŒ Product Service no responde. Â¿EstÃ¡ ejecutÃ¡ndose?"

test-endpoints-product: ## ðŸ§ª Probar endpoints principales del product-service
	@echo "ðŸ§ª Probando endpoints del product-service..."
	@echo "ðŸ’š Health endpoint:"
	@curl -s http://localhost:$(PRODUCT_PORT)/actuator/health | jq .status || echo "âŒ Health endpoint no responde"
	@echo "\nðŸ§ª Test endpoint:"
	@curl -s http://localhost:$(PRODUCT_PORT)/api/v1/products/test || echo "âŒ Test endpoint no responde"
	@echo "\nðŸ“¦ Products endpoint (bÃ¡sico):"
	@curl -s "http://localhost:$(PRODUCT_PORT)/api/v1/products" | jq '. | length' || echo "âŒ Products endpoint no responde"
	@echo "\nðŸ“„ PaginaciÃ³n endpoint:"
	@curl -s "http://localhost:$(PRODUCT_PORT)/api/v1/products/paginated?size=3&sortBy=createdAt&sortDir=desc" | jq '.content | length' || echo "âŒ PaginaciÃ³n endpoint no responde"

test-pagination-endpoints: ## ðŸ§ª Probar endpoints de paginaciÃ³n con filtros
	@echo "ðŸ§ª Probando endpoints de paginaciÃ³n del product-service..."
	@echo "ðŸ“„ PaginaciÃ³n bÃ¡sica:"
	@curl -s "http://localhost:$(PRODUCT_PORT)/api/v1/products/paginated?size=5&sortBy=createdAt&sortDir=desc" | jq . || echo "âŒ PaginaciÃ³n bÃ¡sica no responde"
	@echo "\nðŸ” Filtro por cÃ³digo:"
	@curl -s "http://localhost:$(PRODUCT_PORT)/api/v1/products/paginated?size=5&sortBy=name&sortDir=asc&code=ABC" | jq . || echo "âŒ Filtro por cÃ³digo no responde"
	@echo "\nðŸ” Filtro por nombre:"
	@curl -s "http://localhost:$(PRODUCT_PORT)/api/v1/products/paginated?size=5&sortBy=name&sortDir=asc&name=test" | jq . || echo "âŒ Filtro por nombre no responde"
	@echo "\nðŸ” MÃºltiples filtros:"
	@curl -s "http://localhost:$(PRODUCT_PORT)/api/v1/products/paginated?size=10&sortBy=name&sortDir=asc&code=ABC&description=test" | jq . || echo "âŒ MÃºltiples filtros no responden"

info-product: ## â„¹ï¸ InformaciÃ³n del product-service
	@echo "â„¹ï¸  InformaciÃ³n del Product Service:"
	@echo "  ðŸ“ Proyecto: product-service"
	@echo "  â˜• Java: 17"
	@echo "  ðŸ”§ Build: Gradle"
	@echo "  ðŸ—„ï¸  BD ProducciÃ³n: PostgreSQL"
	@echo "  ðŸ§ª BD Tests: H2"
	@echo "  ðŸŒ Puerto: 9090"
	@echo "  ðŸ“ Endpoints principales:"
	@echo "    - GET /api/v1/products/test"
	@echo "    - GET /api/v1/products"
	@echo "    - GET /api/v1/products/paginated"
	@echo "    - GET /actuator/health"

## ðŸŽ¯ Comandos rÃ¡pidos del Product Service
quick-test-product: ## âš¡ Test rÃ¡pido del product-service
	@echo "âš¡ Test rÃ¡pido del product-service..."
	cd ../product-service && ./gradlew test --parallel

quick-build-product: ## âš¡ Build rÃ¡pido del product-service
	@echo "âš¡ Build rÃ¡pido del product-service..."
	cd ../product-service && ./gradlew build -x test

## ðŸ“Š Reportes del Product Service
coverage-product: ## ðŸ“Š Generar reporte de cobertura del product-service
	@echo "ðŸ“Š Generando reporte de cobertura del product-service..."
	cd ../product-service && ./gradlew jacocoTestReport
	@echo "ðŸ“Š Reporte disponible en: ../product-service/build/reports/jacoco/test/html/index.html"

## ðŸ”„ Comandos integrados (Product Service + Infraestructura)
dev-full-stack: up-db run-product-local ## ðŸš€ Levantar BD en Docker + Product Service local
	@echo "ðŸŽ‰ Full stack listo: BD en Docker + Product Service local"

test-integration-product: up-db ## ðŸ§ª Tests de integraciÃ³n con BD real
	@echo "ðŸ§ª Ejecutando tests de integraciÃ³n con BD PostgreSQL..."
	@sleep 5
	cd ../product-service && ./gradlew test --args='--spring.profiles.active=local'

## âœ… ValidaciÃ³n completa de funcionalidad
validate-pagination-feature: health-product test-pagination-endpoints ## âœ… Validar paginaciÃ³n con filtros
	@echo "âœ… ValidaciÃ³n de funcionalidad de paginaciÃ³n completada"

print-services-local-supplier:
	@COMPOSE_FILE="$(CURDIR)/docker-compose-podman.yml"; \
    COMPOSE_PROFILES=infra,supplier,product \
    $(RUN) podman compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
    	--profile infra --profile supplier --profile product \
    	config --services

#------------------------------------------------------------------------
# ðŸ†• Nuevas funcionalidades agregadas
#------------------------------------------------------------------------

## ðŸ“± Monitoreo y debugging avanzado
monitor-resources: podman-ready ## ðŸ“Š Monitorear recursos del sistema en tiempo real
	@echo "ðŸ“Š Monitoreando recursos del sistema..."
	podman stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

debug-network: podman-ready ## ðŸŒ Debugging de la red de contenedores
	@echo "ðŸŒ Inspeccionando red de contenedores..."
	podman network ls
	@echo "\nðŸ“‹ Detalles de la red por defecto:"
	podman network inspect podman

debug-volumes: podman-ready ## ðŸ’¾ Debugging de volÃºmenes de datos
	@echo "ðŸ’¾ Inspeccionando volÃºmenes..."
	podman volume ls
	@echo "\nðŸ“‹ Detalles del volumen de datos:"
	podman volume inspect inventoryms_product-data 2>/dev/null || echo "âš ï¸ Volumen no existe"

debug-containers: podman-ready ## ðŸ” Debugging detallado de contenedores
	@echo "ðŸ” Estado detallado de contenedores..."
	podman ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}"

## ðŸ”§ Comandos de mantenimiento avanzado
maintenance-full: podman-ready ## ðŸ› ï¸ Mantenimiento completo del sistema
	@echo "ðŸ› ï¸ Ejecutando mantenimiento completo..."
	$(MAKE) stop-all
	$(MAKE) clean-podman
	podman system reset --force
	@echo "âœ… Mantenimiento completado"

backup-volumes: podman-ready ## ðŸ’¾ Crear backup de volÃºmenes importantes
	@echo "ðŸ’¾ Creando backup de volÃºmenes..."
	@mkdir -p ./backups/$(shell date +%Y%m%d_%H%M%S)
	podman run --rm -v inventoryms_product-data:/data -v ./backups:/backup alpine tar czf /backup/product-data-$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .
	@echo "âœ… Backup creado en ./backups/"

restore-volumes: podman-ready ## ðŸ”„ Restaurar volÃºmenes desde backup (especificar BACKUP_FILE)
	@echo "ðŸ”„ Restaurando volÃºmenes desde backup: $(BACKUP_FILE)"
	podman run --rm -v inventoryms_product-data:/data -v ./backups:/backup alpine tar xzf /backup/$(BACKUP_FILE) -C /data
	@echo "âœ… VolÃºmenes restaurados"

## ðŸš€ Despliegue y CI/CD helpers
deploy-staging: podman-ready ## ðŸŽ­ Desplegar en entorno de staging
	@echo "ðŸŽ­ Desplegando en staging..."
	$(MAKE) build-jars
	$(MAKE) up-dev
	$(MAKE) test-services
	@echo "âœ… Despliegue en staging completado"

deploy-production: podman-ready ## ðŸš€ Desplegar en entorno de producciÃ³n
	@echo "ðŸš€ Desplegando en producciÃ³n..."
	$(MAKE) build-jars
	$(MAKE) up-prod
	@sleep 30
	$(MAKE) test-services
	@echo "âœ… Despliegue en producciÃ³n completado"

pre-commit-checks: ## âœ… Verificaciones antes de commit
	@echo "âœ… Ejecutando verificaciones pre-commit..."
	$(MAKE) clean-gradle
	$(MAKE) build-jars
	$(MAKE) test-product
	$(MAKE) lint-product
	@echo "âœ… Todas las verificaciones pasaron"

## ðŸ“ˆ Performance y benchmarking
benchmark-endpoints: ## ðŸ“ˆ Benchmark de endpoints principales
	@echo "ðŸ“ˆ Ejecutando benchmark de endpoints..."
	@command -v ab >/dev/null 2>&1 || { echo "âŒ Apache Bench (ab) no estÃ¡ instalado"; exit 1; }
	@echo "ðŸ§ª Benchmark de health endpoint:"
	ab -n 100 -c 10 http://localhost:9090/actuator/health
	@echo "\nðŸ“¦ Benchmark de products endpoint:"
	ab -n 100 -c 10 http://localhost:9090/api/v1/products
	@echo "\nðŸ“„ Benchmark de paginaciÃ³n endpoint:"
	ab -n 100 -c 10 "http://localhost:9090/api/v1/products/paginated?size=10"

load-test-basic: ## ðŸŽ¯ Test de carga bÃ¡sico
	@echo "ðŸŽ¯ Ejecutando test de carga bÃ¡sico..."
	@command -v wrk >/dev/null 2>&1 || { echo "âŒ wrk no estÃ¡ instalado. Instalar con: brew install wrk"; exit 1; }
	wrk -t12 -c400 -d30s http://localhost:9090/api/v1/products

## ðŸ” Seguridad y validaciÃ³n
security-scan: podman-ready ## ðŸ” Escaneo de seguridad de imÃ¡genes
	@echo "ðŸ” Escaneando imÃ¡genes en busca de vulnerabilidades..."
	@command -v podman >/dev/null 2>&1 || { echo "âŒ Podman no estÃ¡ disponible"; exit 1; }
	@for image in inventory/discovery-service inventory/config-service inventory/api-gateway inventory/product-service; do \
		echo "ðŸ” Escaneando $$image..."; \
		podman run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image $$image || echo "âš ï¸ No se pudo escanear $$image"; \
	done

validate-configs: podman-ready ## âœ… Validar archivos de configuraciÃ³n
	@echo "âœ… Validando archivos de configuraciÃ³n..."
	@echo "ðŸ” Validando docker-compose.yml..."
	$(COMPOSE_LOCAL) config > /dev/null && echo "âœ… docker-compose.yml vÃ¡lido" || echo "âŒ docker-compose.yml invÃ¡lido"
	@echo "ðŸ” Validando archivos .env..."
	@for env_file in $(ENV_FILE_LOCAL) $(ENV_FILE_DEV) $(ENV_FILE_PROD); do \
		if [ -f $$env_file ]; then \
			echo "âœ… $$env_file existe"; \
		else \
			echo "âŒ $$env_file no existe"; \
		fi \
	done

## ðŸ“‹ Reportes y documentaciÃ³n
generate-reports: ## ðŸ“‹ Generar reportes del proyecto
	@echo "ðŸ“‹ Generando reportes del proyecto..."
	@mkdir -p ./reports/$(shell date +%Y%m%d_%H%M%S)
	@echo "ðŸ“Š Generando reporte de tests..."
	$(MAKE) test-product
	@echo "ðŸ“ˆ Generando reporte de cobertura..."
	$(MAKE) coverage-product
	@echo "ðŸ—ï¸ Generando reporte de dependencias..."
	cd ../product-service && ./gradlew dependencyInsight --dependency org.springframework.boot > ../infrastructure/reports/$(shell date +%Y%m%d_%H%M%S)/dependencies.txt
	@echo "âœ… Reportes generados en ./reports/"

system-info-full: podman-ready ## â„¹ï¸ InformaciÃ³n completa del sistema
	@echo "â„¹ï¸ InformaciÃ³n completa del sistema:"
	@echo "======================================"
	@echo "ðŸ³ Podman version:"
	podman --version
	@echo "\nðŸ¦­ Podman machine info:"
	podman machine list
	@echo "\nðŸ“Š EstadÃ­sticas del sistema:"
	podman system info | head -20
	@echo "\nðŸ“¦ ImÃ¡genes disponibles:"
	podman images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.Created}}"
	@echo "\nðŸ”Œ Contenedores activos:"
	podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

## ðŸ”„ Workflows automatizados
workflow-dev: ## ðŸ”„ Workflow completo de desarrollo
	@echo "ðŸ”„ Iniciando workflow de desarrollo..."
	$(MAKE) clean-gradle
	$(MAKE) validate-configs
	$(MAKE) up-db
	@echo "â³ Esperando que la BD estÃ© lista..."
	@sleep 10
	$(MAKE) test-product-local
	$(MAKE) run-product-local &
	@echo "â³ Esperando que el servicio estÃ© listo..."
	@sleep 15
	$(MAKE) health-product
	$(MAKE) test-endpoints-product
	@echo "âœ… Workflow de desarrollo completado"

workflow-ci: ## ðŸ”„ Workflow de integraciÃ³n continua
	@echo "ðŸ”„ Iniciando workflow de CI..."
	$(MAKE) pre-commit-checks
	$(MAKE) build-step-by-step
	$(MAKE) up-dev
	@sleep 30
	$(MAKE) test-services
	$(MAKE) benchmark-endpoints
	@echo "âœ… Workflow de CI completado"

workflow-production: ## ðŸ”„ Workflow de producciÃ³n
	@echo "ðŸ”„ Iniciando workflow de producciÃ³n..."
	$(MAKE) security-scan
	$(MAKE) validate-configs
	$(MAKE) backup-volumes
	$(MAKE) deploy-production
	$(MAKE) load-test-basic
	@echo "âœ… Workflow de producciÃ³n completado"

## ðŸ†˜ Troubleshooting y diagnÃ³stico
troubleshoot-db: podman-ready ## ðŸ†˜ DiagnÃ³stico de problemas de base de datos
	@echo "ðŸ†˜ Diagnosticando problemas de base de datos..."
	@echo "ðŸ” Estado del contenedor de BD:"
	podman ps -a --filter name=product-db
	@echo "\nðŸ“‹ Logs recientes de la BD:"
	podman logs --tail 20 product-db 2>/dev/null || echo "âŒ No se pueden obtener logs de product-db"
	@echo "\nðŸ’¾ Verificando volumen de datos:"
	podman volume inspect inventoryms_product-data >/dev/null 2>&1 && echo "âœ… Volumen existe" || echo "âŒ Volumen no existe"
	@echo "\nðŸŒ Verificando conectividad:"
	podman exec product-db pg_isready -U product 2>/dev/null && echo "âœ… PostgreSQL respondiendo" || echo "âŒ PostgreSQL no responde"

troubleshoot-network: podman-ready ## ðŸ†˜ DiagnÃ³stico de problemas de red
	@echo "ðŸ†˜ Diagnosticando problemas de red..."
	@echo "ðŸŒ Redes disponibles:"
	podman network ls
	@echo "\nðŸ”Œ Conectividad entre contenedores:"
	@for service in discovery-service config-service api-gateway product-service; do \
		echo "ðŸ§ª Probando $${service}..."; \
		podman exec product-service ping -c 1 $${service} 2>/dev/null && echo "âœ… $${service} accesible" || echo "âŒ $${service} no accesible"; \
	done

troubleshoot-services: podman-ready ## ðŸ†˜ DiagnÃ³stico de problemas de servicios
	@echo "ðŸ†˜ Diagnosticando problemas de servicios..."
	@echo "ðŸ“Š Estado de servicios:"
	$(MAKE) status
	@echo "\nðŸ§ª Health checks:"
	$(MAKE) test-services
	@echo "\nðŸ“‹ Logs de errores recientes:"
	$(RUN) podman compose logs --tail 10 | grep -i error || echo "â„¹ï¸ No se encontraron errores recientes"

fix-common-issues: ## ðŸ”§ Solucionar problemas comunes
	@echo "ðŸ”§ Solucionando problemas comunes..."
	@echo "ðŸ§¹ Limpiando recursos no utilizados..."
	$(MAKE) clean-podman
	@echo "ðŸ”„ Reiniciando mÃ¡quina Podman..."
	podman machine stop 2>/dev/null || true
	podman machine start
	@echo "ðŸš€ Recreando contenedores..."
	$(MAKE) reset-local
	@echo "âœ… Problemas comunes solucionados"

## ðŸŽ¯ Comandos especÃ­ficos para diferentes roles
# Para desarrolladores
dev-setup: ## ðŸ‘¨â€ðŸ’» ConfiguraciÃ³n inicial para desarrolladores
	@echo "ðŸ‘¨â€ðŸ’» Configurando entorno de desarrollo..."
	$(MAKE) podman-start
	$(MAKE) validate-configs
	$(MAKE) clean-gradle
	$(MAKE) up-db
	@echo "ðŸ“š Para empezar a desarrollar ejecuta: make dev-product"
	@echo "âœ… Entorno de desarrollo configurado"

# Para QA/Testing
qa-setup: ## ðŸ§ª ConfiguraciÃ³n para QA y testing
	@echo "ðŸ§ª Configurando entorno de QA..."
	$(MAKE) up-dev
	@sleep 30
	$(MAKE) test-services
	$(MAKE) test-endpoints-product
	$(MAKE) test-pagination-endpoints
	@echo "âœ… Entorno de QA configurado y verificado"

# Para DevOps
devops-setup: ## âš™ï¸ ConfiguraciÃ³n para DevOps
	@echo "âš™ï¸ Configurando entorno DevOps..."
	$(MAKE) system-info-full
	$(MAKE) validate-configs
	$(MAKE) security-scan
	$(MAKE) backup-volumes
	@echo "âœ… Entorno DevOps configurado"

## ðŸ“Š MÃ©tricas y monitoreo
collect-metrics: podman-ready ## ðŸ“Š Recopilar mÃ©tricas del sistema
	@echo "ðŸ“Š Recopilando mÃ©tricas del sistema..."
	@mkdir -p ./metrics/$(shell date +%Y%m%d_%H%M%S)
	@echo "ðŸ“ˆ MÃ©tricas de contenedores:" > ./metrics/$(shell date +%Y%m%d_%H%M%S)/container_stats.txt
	podman stats --no-stream >> ./metrics/$(shell date +%Y%m%d_%H%M%S)/container_stats.txt
	@echo "ðŸ’¾ Uso de volÃºmenes:" > ./metrics/$(shell date +%Y%m%d_%H%M%S)/volume_usage.txt
	podman system df >> ./metrics/$(shell date +%Y%m%d_%H%M%S)/volume_usage.txt
	@echo "âœ… MÃ©tricas guardadas en ./metrics/"

health-check-all: ## ðŸ’š VerificaciÃ³n de salud completa
	@echo "ðŸ’š Verificando salud completa del sistema..."
	@echo "ðŸ” Verificando servicios principales:"
	$(MAKE) test-services
	@echo "\nðŸ” Verificando endpoints especÃ­ficos:"
	$(MAKE) test-endpoints-product
	@echo "\nðŸ” Verificando base de datos:"
	$(MAKE) troubleshoot-db
	@echo "\nðŸ“Š Estado de recursos:"
	$(MAKE) monitor-resources

## ðŸ”„ Scripts de automatizaciÃ³n
auto-restart: ## ðŸ”„ Reinicio automÃ¡tico con verificaciones
	@echo "ðŸ”„ Ejecutando reinicio automÃ¡tico..."
	$(MAKE) down-local
	@sleep 5
	$(MAKE) clean-volumes
	$(MAKE) up-local
	@sleep 30
	$(MAKE) health-check-all
	@echo "âœ… Reinicio automÃ¡tico completado"

daily-maintenance: ## ðŸ“… Mantenimiento diario automatizado
	@echo "ðŸ“… Ejecutando mantenimiento diario..."
	$(MAKE) backup-volumes
	$(MAKE) clean-images
	$(MAKE) collect-metrics
	$(MAKE) generate-reports
	@echo "âœ… Mantenimiento diario completado"

## ðŸ“± Comandos de utilidad mÃ³vil/rÃ¡pida
quick-start: up-db dev-product ## âš¡ Inicio rÃ¡pido para desarrollo
quick-test: test-product health-product ## âš¡ Test rÃ¡pido completo
quick-deploy: build-jars up-dev test-services ## âš¡ Despliegue rÃ¡pido
quick-stop: stop-product-local down-local ## âš¡ Parada rÃ¡pida completa

## ðŸ“– Ayuda mejorada y documentaciÃ³n
help-product: ## ðŸ“– Mostrar ayuda especÃ­fica del product-service
	@echo "ðŸ§ª Product Service - Comandos disponibles:"
	@echo "============================================"
	@echo ""
	@echo "ðŸ§ª TESTING:"
	@echo "  make test-product              - Ejecutar todos los tests"
	@echo "  make test-product-local        - Ejecutar tests con perfil local"
	@echo "  make test-product-unit         - Ejecutar solo tests unitarios"
	@echo "  make test-product-report       - Abrir reporte de tests en navegador"
	@echo "  make test-integration-product  - Tests de integraciÃ³n con BD real"
	@echo ""
	@echo "ðŸš€ DESARROLLO:"
	@echo "  make run-product-local         - Ejecutar con perfil local (localhost:5432)"
	@echo "  make run-product-dev           - Ejecutar con perfil dev (product-db:5432)"
	@echo "  make run-product-profile PROFILE=X - Ejecutar con perfil especÃ­fico"
	@echo "  make dev-product               - Alias para run-product-local"
	@echo "  make stop-product-local        - Detener aplicaciÃ³n local"
	@echo ""
	@echo "ðŸ”¨ BUILD:"
	@echo "  make build-product             - Construir para producciÃ³n"
	@echo "  make clean-product             - Limpiar archivos temporales"
	@echo "  make rebuild-product-local-dev - Limpiar y construir"
	@echo ""
	@echo "âœ… VALIDACIÃ“N:"
	@echo "  make check-product             - Verificar cÃ³digo (build + test)"
	@echo "  make validate-pagination-feature - Validar paginaciÃ³n con filtros"
	@echo "  make lint-product              - Verificar estilo de cÃ³digo"
	@echo ""
	@echo "ðŸ› ï¸  UTILIDADES:"
	@echo "  make health-product            - Verificar health de la aplicaciÃ³n"
	@echo "  make test-endpoints-product    - Probar endpoints principales"
	@echo "  make test-pagination-endpoints - Probar endpoints de paginaciÃ³n con filtros"
	@echo "  make info-product              - InformaciÃ³n del proyecto"

help-workflows: ## ðŸ“– Ayuda para workflows automatizados
	@echo "ðŸ”„ Workflows Automatizados:"
	@echo "=========================="
	@echo ""
	@echo "ðŸ‘¨â€ðŸ’» DESARROLLO:"
	@echo "  make dev-setup                 - ConfiguraciÃ³n inicial para desarrolladores"
	@echo "  make workflow-dev              - Workflow completo de desarrollo"
	@echo "  make quick-start               - Inicio rÃ¡pido para desarrollo"
	@echo ""
	@echo "ðŸ§ª QA/TESTING:"
	@echo "  make qa-setup                  - ConfiguraciÃ³n para QA y testing"
	@echo "  make workflow-ci               - Workflow de integraciÃ³n continua"
	@echo "  make quick-test                - Test rÃ¡pido completo"
	@echo ""
	@echo "ðŸš€ PRODUCCIÃ“N:"
	@echo "  make devops-setup              - ConfiguraciÃ³n para DevOps"
	@echo "  make workflow-production       - Workflow de producciÃ³n"
	@echo "  make quick-deploy              - Despliegue rÃ¡pido"
	@echo ""
	@echo "ðŸ› ï¸  MANTENIMIENTO:"
	@echo "  make daily-maintenance         - Mantenimiento diario automatizado"
	@echo "  make auto-restart              - Reinicio automÃ¡tico con verificaciones"
	@echo "  make maintenance-full          - Mantenimiento completo del sistema"

help-troubleshooting: ## ðŸ“– Ayuda para soluciÃ³n de problemas
	@echo "ðŸ†˜ SoluciÃ³n de Problemas:"
	@echo "========================"
	@echo ""
	@echo "ðŸ” DIAGNÃ“STICO:"
	@echo "  make troubleshoot-db           - DiagnÃ³stico de problemas de base de datos"
	@echo "  make troubleshoot-network      - DiagnÃ³stico de problemas de red"
	@echo "  make troubleshoot-services     - DiagnÃ³stico de problemas de servicios"
	@echo "  make health-check-all          - VerificaciÃ³n de salud completa"
	@echo ""
	@echo "ðŸ”§ SOLUCIONES:"
	@echo "  make fix-common-issues         - Solucionar problemas comunes"
	@echo "  make auto-restart              - Reinicio automÃ¡tico con verificaciones"
	@echo "  make reset-local               - Reiniciar completamente el entorno local"
	@echo ""
	@echo "ðŸ“Š MONITOREO:"
	@echo "  make monitor-resources         - Monitorear recursos en tiempo real"
	@echo "  make collect-metrics           - Recopilar mÃ©tricas del sistema"
	@echo "  make system-info-full          - InformaciÃ³n completa del sistema"

help: ## ðŸ“– Mostrar esta ayuda
	@echo "ðŸ¦­ Makefile para Podman - Sistema de Microservicios"
	@echo "=================================================="
	@echo ""
	@echo "âš¡ COMANDOS RÃPIDOS:"
	@echo "  make quick-start               - Inicio rÃ¡pido para desarrollo"
	@echo "  make quick-test                - Test rÃ¡pido completo"
	@echo "  make quick-deploy              - Despliegue rÃ¡pido"
	@echo "  make quick-stop                - Parada rÃ¡pida completa"
	@echo ""
	@echo "ðŸ“– AYUDA DETALLADA:"
	@echo "  make help-product              - Ayuda especÃ­fica del Product Service"
	@echo "  make help-workflows            - Ayuda para workflows automatizados"
	@echo "  make help-troubleshooting      - Ayuda para soluciÃ³n de problemas"
	@echo ""
	@echo "ðŸ” CATEGORÃAS PRINCIPALES:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  %-25s %s\n", $$1, $$2}' | \
		grep -E "(ðŸ”½|ðŸ”|â™»ï¸|ðŸ”|ðŸ“Š|ðŸ§ª|ðŸš€|ðŸ”¨|âœ…|ðŸ› ï¸|ðŸŽ¯|ðŸ“Š|ðŸ”„|ðŸ†˜|ðŸ“±|ðŸ”|ðŸ“‹)" | \
		head -20
	@echo ""
	@echo "ðŸ’¡ Ejecuta 'make help-[categoria]' para ayuda especÃ­fica"

help-supplier: ## ðŸ“– Comandos de supplier-service
	@echo "supplier-service:"
	@echo "  make up-supplier              - Levantar perfil supplier (compose)"
	@echo "  make rebuild-supplier-local   - Rebuild + up (local)"
	@echo "  make run-supplier-local       - Ejecutar sin contenedor (perfil local)"
	@echo "  make test-supplier            - Ejecutar tests"
	@echo "  make health-supplier          - Ver health"

help-purchase: ## ðŸ“– Comandos de purchase-service
	@echo "purchase-service:"
	@echo "  make up-purchase              - Levantar perfil purchase (compose)"
	@echo "  make rebuild-purchase-local   - Rebuild + up (local)"
	@echo "  make run-purchase-local       - Ejecutar sin contenedor (perfil local)"
	@echo "  make test-purchase            - Ejecutar tests"
	@echo "  make health-purchase          - Ver health"

fix-container-orphans: podman-ready ## ðŸ› ï¸ Limpia contenedores huÃ©rfanos del proyecto
	@echo "ðŸ§¹ Eliminando contenedores huÃ©rfanos (compose project: $(COMPOSE_PROJECT_NAME))..."
	$(COMPOSE_LOCAL)  down -v --remove-orphans 2>/dev/null || true
	$(COMPOSE_DEV)    down -v --remove-orphans 2>/dev/null || true
	$(COMPOSE_PROD)   down -v --remove-orphans 2>/dev/null || true
	@echo "ðŸ—‘ï¸  Pruning de recursos no usados..."
	$(RUN) podman rm -af || true
	$(RUN) podman system prune -af --volumes || true
	@echo "âœ… Limpieza de huÃ©rfanos completada"

help-all: ## ðŸ“– Mostrar todos los comandos disponibles en el Makefile
	@echo "ðŸ¦­ Makefile - Lista completa de comandos"
	@echo "========================================"
	@grep -E '^[a-zA-Z0-9_.-]+:.*## ' $(MAKEFILE_LIST) | \
	  awk -F ':.*## ' '{ printf "  %-35s %s\n", $$1, $$2 }' | sort

up-supplier: podman-ready ## ðŸš€ Levanta sÃ³lo la BD y el supplier-service
	$(COMPOSE_LOCAL) --profile supplier up -d --build supplier-db supplier-service

logs-supplier: podman-ready ## ðŸ“œ Logs de supplier-service
	$(COMPOSE_LOCAL) --profile supplier logs -f supplier-service

status-supplier: podman-ready ## ðŸ“Š Estado de servicios del perfil supplier
	$(COMPOSE_LOCAL) --profile supplier ps

up-ms: podman-ready fix-container-orphans ## ðŸš€ Infra + supplier + purchase (sin product)
	@echo "ðŸ§¹ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override
	@echo "ðŸ”¨ Construyendo JARs necesarios..."
	cd .. && ./gradlew :config-service:bootJar :discovery-service:bootJar :supplier-service:bootJar :purchase-service:bootJar
	@echo "ðŸ¦­ Levantando contenedores (infra, supplier, purchase)..."
	$(COMPOSE_LOCAL) --profile infra --profile supplier --profile purchase up -d --build

# --- TAX Service ---
up-tax: podman-ready ## ðŸš€ Levanta sÃ³lo tax-db + tax-service (y la infra si no estÃ¡)
	$(COMPOSE_LOCAL) --profile infra --profile tax up -d --build tax-db tax-service

# Variante con TAX (no pisa up-local base)
up-local-with-tax: podman-ready fix-container-orphans ## ðŸ§ª Infra + product + gateway + tax
	@echo "ðŸ§¹ Copiando variables de entorno..."
	cp $(ENV_FILE_LOCAL) .env.override
	@echo "ðŸ”¨ Construyendo servicios base..."
	cd .. && ./gradlew :config-service:bootJar :discovery-service:bootJar :product-service:bootJar :api-gateway:bootJar
	@if [ -f "../tax-service/build.gradle" ] && grep -q 'include\("?tax-service"?\)' ../settings.gradle; then \
	  echo "ðŸ”¨ Construyendo tax-service..."; \
	  cd .. && ./gradlew :tax-service:bootJar; \
	else \
	  echo "â„¹ï¸ tax-service no presente; se omite build"; \
	fi
	@echo "ðŸ¦­ Levantando contenedores con Podman (perfiles: infra, product, gateway, tax)..."
	$(COMPOSE_LOCAL) --profile infra --profile product --profile gateway --profile tax up -d --build

up-local-product-supplier-tax: podman-ready fix-container-orphans ## ðŸ§ª Infra + product + supplier + tax
	@echo "ðŸ§¹ Copiando variables de entorno (supplier/local)..."
	@echo "â„¹ï¸  Archivo supplier detectado: $(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)"
	cp "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" "$(CURDIR)/.env.override"

	@COMPOSE_FILE="$(CURDIR)/docker-compose-podman.yml"; \
	echo "ðŸ”Ž Validando compose (perfiles: infra,product,supplier,tax)"; \
	COMPOSE_PROFILES=infra,product,supplier,tax \
	$(RUN) podman compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
	  config >/dev/null || { \
	    echo "âŒ 'podman compose config' fallÃ³. Mostrando salida completa para diagnÃ³stico:"; \
	    COMPOSE_PROFILES=infra,product,supplier,tax \
	    $(RUN) podman compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" config; \
	    exit 1; \
	  }; \
	OUT="$$(COMPOSE_PROFILES=infra,product,supplier,tax \
	  $(RUN) podman compose -f $$COMPOSE_FILE --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
	    config --services)"; \
	LINES="$$(printf "%s\n" "$$OUT" | tr ' ' '\n' | sed '/^$$/d')"; \
	echo "ðŸ“‹ Servicios detectados:"; printf "%s\n" "$$LINES"; \
	for s in discovery-service config-service product-db product-service supplier-db supplier-service tax-db tax-service; do \
	  echo "$$LINES" | grep -xq $$s || { echo "âŒ Falta $$s"; exit 1; }; \
	done; \
	echo "âœ… Todos los servicios requeridos estÃ¡n definidos."

	@echo "ðŸ”¨ Construyendo JARs necesarios..."
	cd "$(CURDIR)/.." && ./gradlew \
		:config-service:bootJar \
		:discovery-service:bootJar \
		:product-service:bootJar \
		:supplier-service:bootJar \
		:tax-service:bootJar

	@echo "ðŸ¦­ Levantando discovery, config, product, supplier y tax..."
	@COMPOSE_PROFILES=infra,product,supplier,tax \
	$(RUN) podman compose -f "$(CURDIR)/docker-compose-podman.yml" --env-file "$(ENV_FILE_LOCAL_SUPPLIER_RESOLVED)" \
	  --profile infra --profile product --profile supplier --profile tax \
	  up -d --build \
	  discovery-service config-service \
	  product-db product-service \
	  supplier-db supplier-service \
	  tax-db tax-service || { echo "âŒ 'podman compose up' fallÃ³"; exit 1; }

	@$(COMPOSE_LOCAL_SUPPLIER) ps

down-local-with-tax: podman-ready ## ðŸ”» Apaga infra local (perfiles: infra, product, gateway, tax)
	$(COMPOSE_LOCAL) --profile infra --profile product --profile gateway --profile tax down -v --remove-orphans

rebuild-tax-local: podman-ready ## ðŸ” Rebuild tax-service (local)
	@echo "ðŸ› ï¸  Rebuild tax-service (local)"
	cp $(ENV_FILE_LOCAL) .env.override
	cd .. && ./gradlew :tax-service:bootJar
	COMPOSE_PROFILES=infra,tax \
	$(COMPOSE_LOCAL) --profile infra --profile tax build tax-service
	COMPOSE_PROFILES=infra,tax \
	$(COMPOSE_LOCAL) --profile infra --profile tax \
	  up -d discovery-service config-service tax-db tax-service

run-tax-local: ## ðŸš€ Ejecutar tax-service local (sin contenedor)
	@echo "ðŸš€ tax-service local en http://localhost:$(TAX_PORT)"
	cd ../tax-service && ./gradlew bootRun --args='--spring.profiles.active=local'

logs-tax: podman-ready ## ðŸ“œ Logs de tax-service
	$(COMPOSE_LOCAL) --profile tax logs -f tax-service

status-tax: podman-ready ## ðŸ“Š Estado de perfil tax
	$(COMPOSE_LOCAL) --profile tax ps

health-tax: ## ðŸ’š Health de tax-service
	@curl -fsS http://localhost:$(TAX_PORT)/actuator/health | jq . || echo "âŒ tax-service no responde"

#------------------------------------------------------------------------
# ðŸŽ macOS: SincronizaciÃ³n de Podman Desktop
#------------------------------------------------------------------------
sync-podman-desktop: ## ðŸŽ Sincroniza Podman Desktop en macOS (usa podman-machine-default)
	@echo "ðŸ”„ Sincronizando Podman Desktop en macOS..."
	@echo ""
	@echo "ðŸ“‹ Conexiones disponibles:"
	podman system connection list
	@echo ""
	@echo "ðŸ”— Cambiando a conexiÃ³n de Podman Desktop (podman-machine-default)..."
	podman system connection default podman-machine-default
	@echo ""
	@echo "âœ… Verificando contenedores..."
	podman ps
	@echo ""
	@echo "ðŸ“Œ Los contenedores deberÃ­an aparecer en Podman Desktop ahora"
	@echo "ðŸ’¡ Si no ves nada, reinicia Podman Desktop completamente"
# ==== TAX DB helpers ====

# Conecta psql al tax-db
tax-psql: podman-ready
	@podman exec -it tax-db psql -U $${TAX_DB_USERNAME:-tax} -d $${TAX_DB_NAME:-tax}

# Resetea tax-db (borra volumen => re-ejecuta 01/02/03 al levantar)
tax-db-reset: podman-ready
	@echo "ðŸ›‘ Derribando tax (containers + volumen)..."
	$(COMPOSE_LOCAL) --profile tax down -v --remove-orphans || true
	@VOL="$$(podman volume ls --format '{{.Name}}' | grep -E '^$(COMPOSE_PROJECT_NAME)_tax-data$$' || true)"; \
	if [ -n "$$VOL" ]; then \
	  echo "ðŸ§¹ Borrando volumen $$VOL"; podman volume rm -f $$VOL; \
	else echo "â„¹ï¸ Volumen tax-data no existe"; fi

	@echo "ðŸ”¨ Construyendo JARs necesarios (infra + tax)..."
	cd "$(CURDIR)/.." && ./gradlew \
		:discovery-service:bootJar \
		:config-service:bootJar \
		:tax-service:bootJar

	@echo "ðŸš€ Levantando tax-db + tax-service (con infra)â€¦"
	COMPOSE_PROFILES=infra,tax \
	$(COMPOSE_LOCAL) --profile infra --profile tax up -d --build tax-db tax-service

	@echo "â³ Esperando DB..."; sleep 5
	$(MAKE) tax-verify
# Solo volver a correr el seed 03 contra una base existente
tax-db-seed: podman-ready
	@echo "ðŸŒ± Re-ejecutando seed 03-tax-seed.sql..."
	podman exec -i tax-db psql -U $${TAX_DB_USERNAME:-tax} -d $${TAX_DB_NAME:-tax} < ./init-scripts/tax/03-tax-seed.sql
	$(MAKE) tax-verify

# VerificaciÃ³n rÃ¡pida
tax-verify: podman-ready
	@echo "ðŸ”Ž Tabla tax:"
	@podman exec -it tax-db psql -U $${TAX_DB_USERNAME:-tax} -d $${TAX_DB_NAME:-tax} -c "\d+ tax" || true
	@echo "ðŸ”Ž Filas:"
	@podman exec -it tax-db psql -U $${TAX_DB_USERNAME:-tax} -d $${TAX_DB_NAME:-tax} -c "SELECT code, name, rate, is_active FROM tax ORDER BY code;" || true

.PHONY: help help-product help-workflows help-troubleshooting help-supplier help-purchase help-all \
        podman-ready compose-provider print-envs print-services-local-supplier \
        up-local up-local-with-tax up-local-supplier up-local-product-supplier up-local-purchase up-dev up-prod up-db up-ms up-tax \
        down-local down-local-with-tax \
        help-tax test-tax build-tax \
        build-images build-jars build-jars-all build-step-by-step \
        rebuild-api-gateway-local rebuild-config-service-local rebuild-discovery-local \
        rebuild-product-local rebuild-product-dev rebuild-supplier-local rebuild-supplier-dev \
        rebuild-purchase-local rebuild-purchase-dev rebuild-tax-local \
        clean-volumes clean-images clean-podman stop-all reset-db reset-local \
        logs-local logs-dev logs-api-gateway logs-discovery logs-config logs-product logs-supplier logs-tax logs-db \
        check-db-init status status-supplier status-tax podman-status \
        pods-list pods-stats images-list system-info system-info-full podman-start podman-machine-list podman-view-all podman-remove-all \
        test-services test-services-all \
        up-local-product-supplier-tax \
        test-product test-product-unit test-product-controller test-product-app test-product-health test-product-report \
        test-product-local run-product-local run-product-dev run-product-profile dev-product stop-product-local \
        build-product build-product-no-tests clean-product rebuild-product-local-dev check-product lint-product \
        deps-product deps-product-update health-product health-supplier health-purchase health-tax \
        test-endpoints-product test-pagination-endpoints info-product \
        quick-test-product quick-build-product coverage-product dev-full-stack test-integration-product validate-pagination-feature \
        monitor-resources debug-network debug-volumes debug-containers maintenance-full backup-volumes restore-volumes \
        deploy-staging deploy-production pre-commit-checks benchmark-endpoints load-test-basic security-scan validate-configs \
        generate-reports workflow-dev workflow-ci workflow-production troubleshoot-db troubleshoot-network troubleshoot-services \
        fix-common-issues dev-setup qa-setup devops-setup collect-metrics health-check-all auto-restart daily-maintenance \
        quick-start quick-test quick-deploy quick-stop fix-container-orphans sync-podman-desktop \
        up-% down-% logs-%