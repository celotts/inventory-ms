#------------------------------------------------------------------------
# make up-local          # Levanta infra para trabajar desde IntelliJ
# make down-local        # Apaga infra local
# make logs-local        # Ver logs en tiempo real (local)
# make restart-db        # Reinicia solo la base de datos
# make reset-local       # Reinicia completamente el entorno local (infra)
# make up-dev            # Levanta todo el stack en contenedores (modo dev)
# make down-dev          # Apaga todo el stack en dev
# make logs-dev          # Ver logs de todos los contenedores en dev
# make up-prod           # Levanta todo en entorno de producciÃ³n
# make build-images      # Construye manualmente imÃ¡genes
# make clean-docker      # Limpia imÃ¡genes, volÃºmenes, contenedores detenidos
# make stop-all          # Detiene todos los contenedores activos en Docker
# make reset-portainer   # Apaga, limpia y relanza stack de Portainer
#------------------------------------------------------------------------


# Variables
ENV_FILE_LOCAL ?= .env.local
ENV_FILE_DEV ?= .env.dev
ENV_FILE_PROD ?= .env.prod
# Levantar con archivo .env actual (puedes exportar ENV_FILE para cambiarlo)

# ğŸ§ª LOCAL: ejecutas product-service desde IntelliJ
up-local:
	cp $(ENV_FILE_LOCAL) .env
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) down -v
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) up --build

down-local:
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) down -v

# ğŸ§ª DEV: todo en contenedores (incluye product-service)
up-dev:
	cp $(ENV_FILE_DEV) .env
	docker compose down -v
	docker compose --env-file $(ENV_FILE_DEV) up --build

# ğŸ§ª PROD: igual que dev pero con variables de producciÃ³n
up-prod:
	cp $(ENV_FILE_PROD) .env
	docker compose down -v
	docker compose --env-file $(ENV_FILE_PROD) up --build

# ğŸ—ï¸ Build manual de imÃ¡genes (opcional si ya usas build automÃ¡tico)
build-images:
	docker build -t inventory/discovery-service ../discovery-service
	docker build -t inventory/config-service ../config-service
	docker build -t inventory/product-service ../product-service

# ğŸ”„ Reinicia solo la base de datos
restart-db:
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) restart product-db

# ğŸ“œ Muestra logs de todos los servicios locales
logs-local:
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) logs -f

# ğŸ“œ Muestra logs del entorno dev
logs-dev:
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_DEV) logs -f

# ğŸ§¹ Limpia imÃ¡genes sin contenedor y volÃºmenes no usados
clean-docker:
	docker system prune -f --volumes

# ğŸ” Reinicia completamente el entorno local (infra)
reset-local:
	@echo "ğŸ”» Apagando contenedores..."
	$(MAKE) down-local
	@echo "ğŸ§¹ Limpiando recursos no usados de Docker..."
	$(MAKE) clean-docker
	@echo "ğŸš€ Levantando entorno local limpio..."
	$(MAKE) up-local

# ğŸ”» Detiene todos los contenedores en ejecuciÃ³n (cualquier origen)
stop-all:
	@echo "ğŸ›‘ Deteniendo todos los contenedores..."
	docker ps -q | xargs -r docker stop
	docker system prune -f --volumes

