#------------------------------------------------------------------------
# make up-local          # Levanta infra para trabajar desde IntelliJ
# make down-local        # Apaga infra local
# make logs-local        # Ver logs en tiempo real (local)
# make restart-db        # Reinicia solo la base de datos
# make reset-local       # Reinicia completamente el entorno local (infra)
# make up-dev            # Levanta todo el stack en contenedores (modo dev)
# make down-dev          # Apaga todo el stack en dev
# make logs-dev          # Ver logs de todos los contenedores en dev
# make up-prod           # Levanta todo en entorno de producciÃ³n
# make build-images      # Construye manualmente imÃ¡genes
# make clean-docker      # Limpia imÃ¡genes, volÃºmenes, contenedores detenidos
# make stop-all          # Detiene todos los contenedores activos en Docker
# make reset-portainer   # Apaga, limpia y relanza stack de Portainer
#------------------------------------------------------------------------


# Variables
ENV_FILE_LOCAL ?= .env.local
ENV_FILE_DEV ?= .env.dev
ENV_FILE_PROD ?= .env.prod

help:
	@grep -E '^#|^[a-zA-Z_-]+:.*?## ' $(MAKEFILE_LIST) | \
	awk 'BEGIN {FS = ":.*?## "}; /^[^#].*/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

clean-volumes: ## ğŸ§¹ Limpia volÃºmenes no usados
	docker volume prune -f

clean-images: ## ğŸ§¹ Limpia imÃ¡genes sin contenedor
	docker image prune -a -f

clean-docker: ## ğŸ§¹ Limpia imÃ¡genes sin contenedor y volÃºmenes no usados
	clean-images clean-volumes

up-local: ## ğŸ§ª Levanta infra para trabajar desde IntelliJ
	cp $(ENV_FILE_LOCAL) .env.override
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) down -v
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) up --build

down-local: ## ğŸ”» Apaga infra local
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) down -v


up-dev: ## ğŸ§ª Levanta todo el stack en contenedores (modo dev)
	cp $(ENV_FILE_DEV) .env.override
	docker compose down -v
	docker compose --env-file $(ENV_FILE_DEV) up --build


up-prod: ## ğŸš€ Levanta todo en entorno de producciÃ³n
	cp $(ENV_FILE_PROD) .env.override
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_PROD) down -v
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_PROD) up --build

build-images: ## ğŸ—ï¸ Build manual de imÃ¡genes (opcional si ya usas build automÃ¡tico)
	docker build -t inventory/discovery-service ../discovery-service
	docker build -t inventory/config-service ../config-service
	docker build -t inventory/product-service ../product-service


restart-db:  ## ğŸ”„ Reinicia solo la base de datos
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) restart product-db

logs-local: ## ğŸ“œ Muestra logs de todos los servicios locales
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) logs -f


logs-dev: ## ğŸ“œ Muestra logs del entorno dev
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_DEV) logs -f


check-db-init: ## ğŸ” Verifica existencia del volumen de base de datos
	@echo "ğŸ” Verificando si el volumen de la base de datos existe..."
	@if ! docker volume inspect inventoryms_product-data >/dev/null 2>&1; then \
		echo "âœ… Volumen no existe. Se ejecutarÃ¡ el script SQL al levantar PostgreSQL."; \
	else \
		echo "âš ï¸ Volumen ya existe. PostgreSQL NO ejecutarÃ¡ el script de inicializaciÃ³n."; \
	fi
	@$(MAKE) up-local


reset-local: # ğŸ” Reinicia completamente el entorno local (infra)
	@echo "ğŸ”» Apagando contenedores..."
	$(MAKE) down-local
	@echo "ğŸ§¹ Limpiando recursos no usados de Docker..."
	$(MAKE) clean-docker
	@echo "ğŸš€ Levantando entorno local limpio..."
	$(MAKE) up-local

stop-all: ## ğŸ›‘ Detiene todos los contenedores activos en Docker
	@echo "ğŸ›‘ Deteniendo todos los contenedores..."
	docker ps -q | xargs -r docker stop
	docker system prune -f --volumes

