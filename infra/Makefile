#------------------------------------------------------------------------
# üì¶ Variables de entorno
#------------------------------------------------------------------------
ENV_FILE_LOCAL ?= .env.local
ENV_FILE_DEV ?= .env.dev
ENV_FILE_PROD ?= .env.prod

#------------------------------------------------------------------------
# üìñ Utilidades
#------------------------------------------------------------------------
help:
	@grep -E '^#|^[a-zA-Z_-]+:.*?## ' $(MAKEFILE_LIST) | \
	awk 'BEGIN {FS = ":.*?## "}; /^[^#].*/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

#------------------------------------------------------------------------
# üßπ Limpieza y mantenimiento
#------------------------------------------------------------------------
clean-volumes: ## üßπ Limpia vol√∫menes no usados
	docker volume prune -f

clean-images: ## üßπ Limpia im√°genes sin contenedor
	docker image prune -a -f

clean-docker: ## üßπ Limpia im√°genes sin contenedor y vol√∫menes no usados
	$(MAKE) clean-images
	$(MAKE) clean-volumes

stop-all: ## üõë Detiene todos los contenedores activos en Docker
	@echo "üõë Deteniendo todos los contenedores..."
	docker ps -q | xargs -r docker stop
	docker system prune -f --volumes

#------------------------------------------------------------------------
# üöÄ Levantar entornos
#------------------------------------------------------------------------
up-local: ## üß™ Levanta infra para trabajar desde IntelliJ
	cp $(ENV_FILE_LOCAL) .env.override
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) down -v
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) up --build

down-local: ## üîª Apaga infra local
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) down -v

up-dev: ## üß™ Levanta todo el stack en contenedores (modo dev)
	cp $(ENV_FILE_DEV) .env.override
	docker compose down -v
	docker compose --env-file $(ENV_FILE_DEV) up --build

up-prod: ## üöÄ Levanta todo en entorno de producci√≥n
	cp $(ENV_FILE_PROD) .env.override
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_PROD) down -v
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_PROD) up --build

#------------------------------------------------------------------------
# üèóÔ∏è Build y Rebuild
#------------------------------------------------------------------------
build-images: ## üèóÔ∏è Build manual de im√°genes (opcional si ya usas build autom√°tico)
	docker build -t inventory/discovery-service ../discovery-service
	docker build -t inventory/config-service ../config-service
	docker build -t inventory/product-service ../product-service

build-jars:
	cd .. && ./gradlew --console=plain :config-service:bootJar :discovery-service:bootJar :product-service:bootJar

rebuild-config-service-local: ## üîÅ Reconstruye solo config-service (entorno local)
	@echo "üõ†Ô∏è  Reconstruyendo config-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) build config-service
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) up -d config-service

rebuild-discovery-local: ## üîÅ Reconstruye solo discovery-service (entorno local)
	@echo "üõ†Ô∏è  Reconstruyendo discovery-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) build discovery-service
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) up -d discovery-service

rebuild-product-local: ## üîÅ Reconstruye solo product-service (entorno local)
	@echo "üõ†Ô∏è  Reconstruyendo imagen del product-service con env: $(ENV_FILE_LOCAL)"
	cp $(ENV_FILE_LOCAL) .env.override
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) build product-service
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) up -d product-service

rebuild-product-dev: ## üîÅ Reconstruye solo product-service (entorno dev)
	@echo "üõ†Ô∏è  Reconstruyendo imagen del product-service con env: $(ENV_FILE_DEV)"
	cp $(ENV_FILE_DEV) .env.override
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_DEV) build product-service
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_DEV) up -d product-service

#------------------------------------------------------------------------
# üîÑ Reinicios y recarga
#------------------------------------------------------------------------
reset-db: ## üß® Elimina y vuelve a crear product-db con datos iniciales
	@echo "‚õî Eliminando contenedor y volumen de product-db..."
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) down -v --remove-orphans
	@echo "üöÄ Levantando solo product-db..."
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) up --build -d product-db
	@echo "üìã Mostrando logs de product-db..."
	docker logs -f product-db

reset-local: ## üîÅ Reinicia completamente el entorno local (infra)
	@echo "üîª Apagando contenedores..."
	$(MAKE) down-local
	@echo "üßπ Limpiando recursos no usados de Docker..."
	$(MAKE) clean-docker
	@echo "üöÄ Levantando entorno local limpio..."
	$(MAKE) up-local

reload-schema: ## ‚ôªÔ∏è Ejecuta manualmente el script SQL en product-db
	docker cp ./init-scripts/product-init.sql product-db:/tmp/product-init.sql
	docker exec -it product-db psql -U product -d product -f /tmp/product-init.sql

#------------------------------------------------------------------------
# üîç Logs y verificaci√≥n
#------------------------------------------------------------------------
logs-local: ## üìú Muestra logs de todos los servicios locales
	docker compose -f docker-compose-local.yml --env-file $(ENV_FILE_LOCAL) logs -f

logs-dev: ## üìú Muestra logs del entorno dev
	docker compose -f docker-compose.yml --env-file $(ENV_FILE_DEV) logs -f

check-db-init: ## üîé Verifica existencia del volumen de base de datos
	@echo "üîé Verificando si el volumen de la base de datos existe..."
	@if ! docker volume inspect inventoryms_product-data >/dev/null 2>&1; then \
		echo "‚úÖ Volumen no existe. Se ejecutar√° el script SQL al levantar PostgreSQL."; \
	else \
		echo "‚ö†Ô∏è Volumen ya existe. PostgreSQL NO ejecutar√° el script de inicializaci√≥n."; \
	fi
	@$(MAKE) up-local

validate-product: ## ‚úÖ Valida la compilaci√≥n y tests de product-service (sin Docker)
	cd .. && ./gradlew :product-service:build

validate-product-no-tests: ## ‚úÖ Valida product-service sin ejecutar pruebas
	cd .. && ./gradlew :product-service:build -x test