plugins {
    id 'java'
    // El plugin debe usar la versi√≥n 3.4.5 para resolver el conflicto de classpath de Gradle.
    id 'org.springframework.boot' version '3.4.5'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'com.github.ben-manes.versions' version '0.53.0'
    id 'org.owasp.dependencycheck' version '9.0.7'
}

group = 'com.celotts'
version = '0.0.1-SNAPSHOT'

java { toolchain { languageVersion = JavaLanguageVersion.of(21) } }

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
    // Repositorios de desarrollo eliminados, ya que estamos usando la versi√≥n estable 3.3.1
}

ext {
    // Se cambia la sintaxis a asignaci√≥n directa para asegurar la correcta interpolaci√≥n.
    springCloudVersion = "2024.0.4"
    postgresDriverVersion = "42.7.8"
    h2Version = "2.4.240"
    lombokVersion = "1.18.42"
    mapstructVersion = "1.6.3"
    testcontainersBom = "1.19.8"
    // ‚≠ê VERSI√ìN ESTABLE: Usamos 3.3.1 para asegurar la resoluci√≥n correcta desde Maven Central.
    springBootVersion = "3.3.1"
    springCloudGatewayVersion = "4.1.4"
    springCloudNetflixVersion = "4.1.3"

    // üÜï Versiones espec√≠ficas para dependencias de prueba que el BOM no estaba resolviendo
    reactorTestVersion = "3.6.8"
    springSecurityVersion = "6.3.1"
}

dependencies {
    // A√±adir Gson.
    implementation 'com.google.code.gson:gson:2.10.1'

    // ‚≠ê CORE STARTERS: Forzamos la versi√≥n 3.3.1 expl√≠citamente.
    implementation "org.springframework.boot:spring-boot-starter-webflux:${springBootVersion}"
    implementation "org.springframework.boot:spring-boot-starter-actuator:${springBootVersion}"
    implementation "org.springframework.boot:spring-boot-starter-security:${springBootVersion}"
    implementation "org.springframework.boot:spring-boot-starter-validation:${springBootVersion}"

    // Dependencias de desarrollo y prueba con versi√≥n forzada
    annotationProcessor "org.springframework.boot:spring-boot-configuration-processor:${springBootVersion}"
    developmentOnly "org.springframework.boot:spring-boot-devtools:${springBootVersion}"
    testImplementation "org.springframework.boot:spring-boot-starter-test:${springBootVersion}"

    // STARTERS DE SPRING CLOUD: Mantenemos la versi√≥n expl√≠cita
    implementation "org.springframework.cloud:spring-cloud-starter-gateway:${springCloudGatewayVersion}"
    implementation "org.springframework.cloud:spring-cloud-starter-netflix-eureka-client:${springCloudNetflixVersion}"
    implementation "org.springframework.cloud:spring-cloud-starter-config:${springCloudNetflixVersion}"

    // MapStruct
    implementation "org.mapstruct:mapstruct:${mapstructVersion}"
    annotationProcessor "org.mapstruct:mapstruct-processor:${mapstructVersion}"
    annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'

    // OpenAPI
    implementation 'org.springdoc:springdoc-openapi-starter-webflux-ui:2.5.0'

    // Lombok
    compileOnly "org.projectlombok:lombok:${lombokVersion}"
    annotationProcessor "org.projectlombok:lombok:${lombokVersion}"

    // Dependencias JWT
    implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
    implementation 'io.jsonwebtoken:jjwt-impl:0.12.3'
    implementation 'io.jsonwebtoken:jjwt-jackson:0.12.3'

    // ‚≠ê TEST DEPENDENCIES: Forzamos la versi√≥n exacta.
    testImplementation "io.projectreactor:reactor-test:${reactorTestVersion}"
    testImplementation "org.springframework.security:spring-security-test:${springSecurityVersion}"
}

// Bloque de Gesti√≥n de Dependencias (BOM)
dependencyManagement {
    imports {
        // Usamos el BOM de la versi√≥n estable 3.3.1
        mavenBom "org.springframework.boot:spring-boot-dependencies:${springBootVersion}"

        // Esto asegura que todas las dependencias de Spring Cloud usen la versi√≥n '2024.0.4'
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
    }
}

tasks.withType(JavaCompile).configureEach {
    options.compilerArgs += ['-Xlint:unchecked', '-Xlint:deprecation']
}

tasks.withType(Test).configureEach {
    useJUnitPlatform()

    // Propiedad que desactiva la verificaci√≥n de compatibilidad de Spring Cloud
    systemProperty 'spring.cloud.compatibility-verifier.enabled', 'false'
}

springBoot {
    mainClass = 'com.celotts.apigateway.ApiGatewayApplication'
    // Define el nombre de la imagen para Podman/Docker
    buildInfo {
        properties {
            name = 'api-gateway'
        }
    }
}

bootJar {
    archiveFileName = 'api-gateway-0.0.1-SNAPSHOT.jar'
}

compileJava {
    options.compilerArgs += [
            '-Amapstruct.defaultComponentModel=spring',
            '-Amapstruct.unmappedTargetPolicy=IGNORE'
    ]
}